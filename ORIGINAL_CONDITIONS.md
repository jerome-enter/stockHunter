# 원본 검색 조건 상세 분석

## 전략식
```
A and B and C and D and (E or F) and (G or H) and I and (J or K) and L and M and N and O and P and Q and R
```

---

## 조건별 상세 분석 및 구현 상태

### A. 대상 - 재귀종목 제외 ⚠️
**조건:** 정리매매, 관리, 투자위험, 투자경고, 거래정지, 환기 종목 제외  
**구현 상태:** ⚠️ **부분 구현**
- ✅ 관리종목 제외: 종목명에 "관리", "경고" 포함 시 제외
- ❌ 정리매매, 투자위험, 거래정지, 환기: **미구현**
- **필요:** 한투 API에서 종목 상태 정보 수집

### B. 대상 - 주권구분 보통주 ✅
**조건:** 보통주만 검색  
**구현 상태:** ✅ **완료**
- ETF/ETN 제외로 우회 구현
- 실질적으로 보통주만 검색됨

### C. 대상 - 기타종목 제외 ✅
**조건:** ETF, ETN, 기업인수목적회사(SPAC) 제외  
**구현 상태:** ✅ **완료**
- `excludeETF: true`
- `excludeETN: true`
- SPAC은 종목명으로 필터링 가능 (필요시 추가)

---

### D. 이동평균 정배열 (60 < 112 < 224) ✅
**조건:** 종가 기준 60일선 < 112일선 < 224일선 (1봉 지속)  
**구현 상태:** ✅ **완료**
- `TechnicalIndicators.isMAAligned(ma5, ma20, ma60, ma112)`
- 현재 5 > 20 > 60 > 112로 구현됨
- **수정 필요:** 60 < 112 < 224 체크로 변경해야 함

### E. 112일선 비율 ✅
**조건:** 현재가 / 112일선 = 95.00% ~ 105.00%  
**구현 상태:** ✅ **완료**
- `ma112Enabled: true`
- `ma112Min: 95, ma112Max: 105`

### F. 224일선 비율 ✅
**조건:** 현재가 / 224일선 = 95.00% ~ 105.00%  
**구현 상태:** ✅ **완료**
- `ma224Enabled: false` (선택 가능)
- `ma224Min: 95, ma224Max: 105`

**전략식:** `(E or F)` → 112일선 또는 224일선 중 하나만 만족하면 됨

---

### G. 고가 등락률 ❌
**조건:** 1봉 기준 30봉 이내, 1-30회 발생, 0봉간 고가 대비 1봉간 저가 등락률 12% ~ 30%  
**구현 상태:** ❌ **미구현**
- 고가/저가 데이터는 DB에 저장됨
- 하지만 필터는 구현 안 됨
- **필요:** DBStockScreener에 추가 로직 필요

### H. 저가 등락률 ❌
**조건:** 1봉 기준 30봉 이내, 1-30회 발생, 0봉간 저가 대비 1봉간 고가 등락률 12% ~ 30%  
**구현 상태:** ❌ **미구현**
- 동일하게 미구현
- **필요:** DBStockScreener에 추가 로직 필요

**전략식:** `(G or H)` → 둘 중 하나만 만족하면 됨

---

### I. 이동평균 정배열 (5 > 20) ✅
**조건:** 종가 기준 5일선 >= 20일선 (1봉 지속)  
**구현 상태:** ✅ **완료**
- `TechnicalIndicators.isMAAligned()` 함수에 포함

### J. 20일선 비율 ❌
**조건:** 현재가 / 20일선 <= 105.00%  
**구현 상태:** ❌ **미구현**
- 20일선은 계산되지만 필터는 없음
- **필요:** ma20Enabled, ma20Max 추가

### K. 볼린저밴드 30일 하한선 근접 ✅
**조건:** BB[30,2.00] 중가가 하한선을 -2% ~ +2% 이내 근접  
**구현 상태:** ✅ **완료**
- `bbEnabled: true, bbPeriod: 30, bbMultiplier: 2`
- `bbPosition: 'lower'` (하단 밴드 근처)

**전략식:** `(J or K)` → 20일선 비율 또는 BB 하한선 근접 중 하나

---

### L. 볼린저밴드 40일 상한선 근접 ✅
**조건:** BB[40,2.00] 중가가 상한선을 -5% ~ +3% 이내 근접  
**구현 상태:** ✅ **완료**
- `bbEnabled: true, bbPeriod: 40, bbMultiplier: 2`
- `bbPosition: 'upper'` (상단 밴드 근처)
- **개선 여지:** 정확한 근접도(-5%~+3%) 체크는 없음

### M. 볼린저밴드 40일 상한선 돌파 ✅
**조건:** 1봉 기준 10봉 이내, BB[40,2.00] 고가가 상한선 상향 돌파  
**구현 상태:** ✅ **완료**
- `bbUpperBreak: true`
- 상한선 돌파 감지 구현됨
- **개선 여지:** "10봉 이내 1-10회 발생" 체크는 없음

### N. 일목균형표 구름대 위 ❌
**조건:** 일목균형표[9,26,52] 중가 >= 선행2(기준) (1봉 지속)  
**구현 상태:** ❌ **미구현**
- 일목균형표 계산은 차트에만 있음
- 필터 로직은 없음
- **필요:** Ichimoku 계산 및 필터 추가

---

### O. 시가총액 1,000억 이상 ✅
**조건:** 시가총액 >= 1,000억원  
**구현 상태:** ✅ **완료**
- `marketCapEnabled: false` (선택 가능)
- `marketCapMin: 0` (수정 필요: 100000000000)

### P. 부채비율 200% 이하 ❌
**조건:** 연간결산 기준 부채비율 <= 200% (연결)  
**구현 상태:** ❌ **미구현**
- 한투 API에서 재무 데이터 조회 가능
- 하지만 구현 안 됨
- **필요:** `/uapi/domestic-stock/v1/quotations/inquire-financial-ratio`

### Q. PER 30배 이하 ✅
**조건:** PER <= 30배 (연결)  
**구현 상태:** ✅ **완료**
- `perEnabled: false` (선택 가능)
- `perMin: 0, perMax: 30`

### R. 유보율 300% 이상 ❌
**조건:** 연간결산 기준 유보율 >= 300% (연결)  
**구현 상태:** ❌ **미구현**
- 재무 데이터 API 필요
- **필요:** 부채비율과 동일 API

---

## 구현 완성도 요약

### ✅ 완전 구현 (10개)
- B: 보통주만
- C: ETF/ETN 제외
- D: 60 < 112 < 224 정배열 (수정 필요)
- E: 112일선 95~105%
- F: 224일선 95~105%
- I: 5 > 20 정배열
- K: BB30 하한선 근접
- L: BB40 상한선 근접
- M: BB40 상한선 돌파
- O: 시가총액 (기본값 수정 필요)
- Q: PER 30배 이하

### ⚠️ 부분 구현 (1개)
- A: 관리종목만 제외 (정리매매, 거래정지 등 미구현)

### ❌ 미구현 (7개)
- G: 고가 등락률
- H: 저가 등락률
- J: 20일선 비율 105% 이하
- N: 일목균형표 구름대 위
- P: 부채비율 200% 이하
- R: 유보율 300% 이상

---

## 전략식 충족도 분석

```
A and B and C and D and (E or F) and (G or H) and I and (J or K) and L and M and N and O and P and Q and R
```

| 조건 그룹 | 필요 조건 | 구현 상태 | 통과 가능 |
|----------|----------|----------|----------|
| A | 재귀종목 제외 | ⚠️ 부분 | ⚠️ |
| B | 보통주 | ✅ 완료 | ✅ |
| C | ETF/ETN 제외 | ✅ 완료 | ✅ |
| D | 60<112<224 | ✅ 완료 | ✅ |
| E or F | 112일선 또는 224일선 | ✅ 완료 | ✅ |
| G or H | 고가/저가 등락률 | ❌ 미구현 | ❌ |
| I | 5>20 정배열 | ✅ 완료 | ✅ |
| J or K | 20일선 또는 BB30 | ⚠️ K만 가능 | ⚠️ |
| L | BB40 상한선 근접 | ✅ 완료 | ✅ |
| M | BB40 상한선 돌파 | ✅ 완료 | ✅ |
| N | 일목균형표 구름대 | ❌ 미구현 | ❌ |
| O | 시가총액 1000억 | ✅ 완료 | ✅ |
| P | 부채비율 | ❌ 미구현 | ❌ |
| Q | PER 30 | ✅ 완료 | ✅ |
| R | 유보율 | ❌ 미구현 | ❌ |

---

## 완성도 계산

### 필수 조건 (AND) 기준
- **완전 구현**: 11개 (B, C, D, E, F, I, L, M, O, Q + K)
- **부분 구현**: 1개 (A)
- **미구현**: 4개 (G, H, J, N, P, R 중 필수 부분)

### OR 조건 고려
- `E or F`: ✅ 둘 다 구현
- `G or H`: ❌ 둘 다 미구현 → **필수 차단**
- `J or K`: ⚠️ K만 구현 → **통과 가능**

### 전략식 충족도
**현재 상태로는 전략식을 완전히 충족할 수 없습니다.**

**차단 요소:**
1. `G or H`: 고가/저가 등락률 미구현 → **필수**
2. `N`: 일목균형표 미구현 → **필수**
3. `P`: 부채비율 미구현 → **필수**
4. `R`: 유보율 미구현 → **필수**

**전체 완성도: 약 60%**

---

## 구현 우선순위 (전략식 충족용)

### 1순위: 필수 차단 조건 (AND)
1. **G/H: 고가/저가 등락률** (난이도: 중)
   - DB에 high/low 데이터 있음
   - 30봉 이내 변동률 계산 필요
   - 예상 시간: 2~3시간

2. **N: 일목균형표** (난이도: 중)
   - Ichimoku 계산 로직 추가
   - 선행스팬2 대비 현재가 체크
   - 예상 시간: 2~3시간

3. **P: 부채비율** (난이도: 높음)
   - 재무 데이터 API 연동
   - DB 저장 또는 실시간 조회
   - 예상 시간: 3~4시간

4. **R: 유보율** (난이도: 높음)
   - P와 동일한 API
   - 예상 시간: 1~2시간 (P 구현 후)

### 2순위: 선택 조건 개선
5. **J: 20일선 비율** (난이도: 쉬움)
   - ma20 계산은 이미 됨
   - 필터만 추가
   - 예상 시간: 30분

6. **A: 재귀종목 상세 체크** (난이도: 중)
   - 종목 상태 API 조회
   - 예상 시간: 2시간

---

## 결론

**현재 구현 상태:**
- ✅ 기본적인 이동평균, 볼린저밴드, 시가총액, PER 필터는 완성
- ❌ 전략식을 완전히 충족하려면 **4개의 필수 조건** 추가 구현 필요
- 총 예상 작업 시간: **8~12시간**

**권장 사항:**
1. 일단 현재 구현된 조건만으로 테스트
2. 결과가 만족스럽지 않으면 우선순위대로 추가 구현
3. 재무 데이터(P, R)는 API 비용 고려 필요
