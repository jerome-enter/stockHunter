<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>ì œë¡¬ê³¼ í•¨ê»˜í•˜ëŠ” í–‰ë³µ ì£¼ì‹ ê²€ìƒ‰ê¸°</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <style>
    body {
      background: linear-gradient(to bottom right, #0f172a, #1e3a8a, #0f172a);
      min-height: 100vh;
    }
  </style>
</head>
<body class="p-4 md:p-6">
  <div id="app" class="max-w-7xl mx-auto"></div>
  
  <!-- ì§„í–‰ë¥  ëª¨ë‹¬ -->
  <div id="progressModal" class="hidden fixed inset-0 bg-black/50 backdrop-blur-sm flex items-center justify-center z-50">
    <div class="bg-gradient-to-br from-slate-900 to-slate-800 border border-white/20 rounded-2xl p-8 max-w-md w-full mx-4">
      <h3 class="text-2xl font-bold text-white mb-6">ğŸ“Š DB ì´ˆê¸°í™” ì¤‘...</h3>
      
      <div class="mb-4">
        <div class="flex justify-between text-white mb-2">
          <span id="progressText">ì¤€ë¹„ ì¤‘...</span>
          <span id="progressPercent">0%</span>
        </div>
        <div class="w-full bg-slate-700 rounded-full h-4 overflow-hidden">
          <div id="progressBar" class="h-full bg-gradient-to-r from-blue-500 to-purple-500 transition-all duration-300" style="width: 0%"></div>
        </div>
      </div>
      
      <div class="text-sm text-white/70 space-y-2">
        <div class="flex justify-between">
          <span>ì²˜ë¦¬ ì¤‘:</span>
          <span id="progressCount">0 / 0</span>
        </div>
        <div class="flex justify-between">
          <span>í˜„ì¬ ì¢…ëª©:</span>
          <span id="progressStock" class="font-mono">-</span>
        </div>
        <div class="flex justify-between">
          <span>ê²½ê³¼ ì‹œê°„:</span>
          <span id="progressElapsed">0ì´ˆ</span>
        </div>
        <div class="flex justify-between">
          <span>ë‚¨ì€ ì‹œê°„:</span>
          <span id="progressRemaining">ê³„ì‚° ì¤‘...</span>
        </div>
      </div>
      
      <div class="mt-6 text-xs text-white/50 text-center">
        âš ï¸ í•œêµ­íˆ¬ìì¦ê¶Œ API ì œì•½ ì¤€ìˆ˜ ì¤‘ (ì´ˆë‹¹ 15ê±´)
      </div>
    </div>
  </div>

  <script>
    const app = {
      selectedMarket: 'domestic',  // domestic or us
      isProduction: true,   // ì‹¤ì „íˆ¬ì ì—¬ë¶€ (ê¸°ë³¸ê°’)
      searchDomestic: true,   // êµ­ë‚´ì£¼ì‹ ê²€ìƒ‰ ì—¬ë¶€
      searchUS: false,        // í•´ì™¸ì£¼ì‹ ê²€ìƒ‰ ì—¬ë¶€
      conditions: {
        market: 'domestic',
        exchangeCode: 'KRX',  // KRX(êµ­ë‚´), NAS(ë‚˜ìŠ¤ë‹¥), NYS(ë‰´ìš•)
        excludeManagement: false,
        ma60Enabled: false,
        ma60Min: 95,
        ma60Max: 105,
        ma112Enabled: true,
        ma112Min: 95,
        ma112Max: 105,
        ma224Enabled: false,
        ma224Min: 95,
        ma224Max: 105,
        excludeETF: true,
        excludeETN: true,
        volumeEnabled: false,
        volumeMultiple: 1.5,
        maAlignment: false,
        bbEnabled: false,
        bbPeriod: 20,
        bbMultiplier: 2,
        bbPosition: 'all',
        bbUpperBreak: false,
        bbLowerBreak: false,
        priceChangeEnabled: false,
        priceChangeMin: -100,
        priceChangeMax: 100,
        marketCapEnabled: false,
        marketCapMin: 0,
        marketCapMax: 10000000000000,
        perEnabled: false,
        perMin: 0,
        perMax: 30,
        pbrEnabled: false,
        pbrMin: 0,
        pbrMax: 3,
      },
      appKey: '',
      appSecret: '',
      accessToken: '',
      results: [],
      loading: false,
      error: ''
    };

    // FastAPI ë°±ì—”ë“œ URL (ê°™ì€ ì„œë²„ ì‚¬ìš©)
    const API_BASE_URL = window.location.origin;
    
    let progressCheckInterval = null;

    // ì§„í–‰ë¥  ëª¨ë‹¬ í‘œì‹œ/ìˆ¨ê¹€
    function showProgressModal() {
      document.getElementById('progressModal').classList.remove('hidden');
      startProgressCheck();
    }
    
    function hideProgressModal() {
      document.getElementById('progressModal').classList.add('hidden');
      stopProgressCheck();
    }
    
    // ì§„í–‰ë¥  í´ë§ ì‹œì‘
    function startProgressCheck() {
      progressCheckInterval = setInterval(updateProgress, 1000); // 1ì´ˆë§ˆë‹¤
      updateProgress(); // ì¦‰ì‹œ í•œ ë²ˆ ì‹¤í–‰
    }
    
    // ì§„í–‰ë¥  í´ë§ ì¤‘ì§€
    function stopProgressCheck() {
      if (progressCheckInterval) {
        clearInterval(progressCheckInterval);
        progressCheckInterval = null;
      }
    }
    
    // ì§„í–‰ë¥  ì—…ë°ì´íŠ¸
    async function updateProgress() {
      try {
        const response = await fetch('http://localhost:8080/api/v1/database/progress');
        const progress = await response.json();
        
        document.getElementById('progressPercent').textContent = progress.percentage + '%';
        document.getElementById('progressBar').style.width = progress.percentage + '%';
        document.getElementById('progressCount').textContent = 
          `${progress.currentCount} / ${progress.totalCount}`;
        document.getElementById('progressStock').textContent = 
          progress.currentStock || '-';
        document.getElementById('progressElapsed').textContent = 
          formatSeconds(progress.elapsedSeconds);
        document.getElementById('progressRemaining').textContent = 
          progress.remainingSeconds > 0 ? formatSeconds(progress.remainingSeconds) : 'ê³„ì‚° ì¤‘...';
        
        if (progress.percentage > 0) {
          document.getElementById('progressText').textContent = 'ì´ˆê¸°í™” ì¤‘...';
        }
        
        // ì™„ë£Œ ì‹œ ëª¨ë‹¬ ë‹«ê¸° ë° DB ìƒíƒœ ê°±ì‹ 
        if (!progress.isRunning && progress.currentCount > 0) {
          setTimeout(() => {
            hideProgressModal();
            // DB ìƒíƒœ ìë™ ê°±ì‹ 
            checkDatabaseStatus();
            alert('âœ… DB ì´ˆê¸°í™” ì™„ë£Œ!\nì´ì œ ìŠ¤í¬ë¦¬ë‹ì„ ì‹¤í–‰í•˜ì„¸ìš”.');
          }, 1000);
        }
      } catch (err) {
        console.error('ì§„í–‰ë¥  ì¡°íšŒ ì‹¤íŒ¨:', err);
      }
    }
    
    // ì´ˆ â†’ "ë¶„ ì´ˆ" í˜•ì‹ ë³€í™˜
    function formatSeconds(seconds) {
      const min = Math.floor(seconds / 60);
      const sec = seconds % 60;
      return min > 0 ? `${min}ë¶„ ${sec}ì´ˆ` : `${sec}ì´ˆ`;
    }
    
    // ì§„í–‰ë¥  í´ë§ ì‹œì‘
    function startProgressPolling() {
      if (progressCheckInterval) {
        clearInterval(progressCheckInterval);
      }
      progressCheckInterval = setInterval(updateProgress, 1000);
      updateProgress(); // ì¦‰ì‹œ í•œ ë²ˆ ì‹¤í–‰
    }
    
    // DB ìƒíƒœ í™•ì¸ ë° ë²„íŠ¼ í‘œì‹œ
    async function checkDatabaseStatus() {
      try {
        const response = await fetch('http://localhost:8080/api/v1/database/status');
        const status = await response.json();
        
        const initBtn = document.getElementById('dbInitBtn');
        const rebuildBtn = document.getElementById('dbRebuildBtn');
        const updateBtn = document.getElementById('dbUpdateBtn');
        const statusText = document.getElementById('dbStatusText');
        
        if (!status.initialized || status.totalStocks === 0) {
          // DB ì—†ìŒ â†’ ì´ˆê¸°í™” ë²„íŠ¼ë§Œ í‘œì‹œ
          initBtn.classList.remove('hidden');
          rebuildBtn.classList.add('hidden');
          updateBtn.classList.add('hidden');
          statusText.innerHTML = 'âŒ DB ë¯¸êµ¬ì¶• (ì´ˆê¸°í™” í•„ìš”)';
        } else {
          // DB ìˆìŒ â†’ ì¬êµ¬ì¶• + ì—…ë°ì´íŠ¸ ë²„íŠ¼ í‘œì‹œ
          initBtn.classList.add('hidden');
          rebuildBtn.classList.remove('hidden');
          updateBtn.classList.remove('hidden');
          
          // ìµœì‹  ì˜ì—…ì¼ í™•ì¸ (í† ìš”ì¼, ì¼ìš”ì¼ ì œì™¸)
          const now = new Date();
          const dayOfWeek = now.getDay(); // 0=ì¼ìš”ì¼, 6=í† ìš”ì¼
          
          // ê°€ì¥ ìµœê·¼ ì˜ì—…ì¼ ê³„ì‚°
          let daysToSubtract = 1; // ê¸°ë³¸: ì–´ì œ(ì¥ ë§ˆê° í›„ ê¸°ì¤€)
          if (dayOfWeek === 0) {
            // ì¼ìš”ì¼ â†’ ê¸ˆìš”ì¼ê¹Œì§€ê°€ ìµœì‹  (2ì¼ ì „)
            daysToSubtract = 2;
          } else if (dayOfWeek === 6) {
            // í† ìš”ì¼ â†’ ê¸ˆìš”ì¼ê¹Œì§€ê°€ ìµœì‹  (1ì¼ ì „)
            daysToSubtract = 1;
          } else if (dayOfWeek === 1) {
            // ì›”ìš”ì¼ â†’ ê¸ˆìš”ì¼ê¹Œì§€ê°€ ìµœì‹  (3ì¼ ì „)
            daysToSubtract = 3;
          }
          // í™”~ê¸ˆì€ ì „ì¼(1ì¼ ì „)ì´ ìµœì‹ 
          
          const lastBusinessDay = new Date(now);
          lastBusinessDay.setDate(now.getDate() - daysToSubtract);
          const expectedDate = lastBusinessDay.toISOString().split('T')[0];
          
          const isUpToDate = status.newestDate >= expectedDate;
          
          if (isUpToDate) {
            // ìµœì‹  ìƒíƒœ
            updateBtn.disabled = true;
            updateBtn.classList.remove('bg-green-600', 'hover:bg-green-700');
            updateBtn.classList.add('bg-gray-600', 'cursor-not-allowed', 'opacity-50');
            statusText.innerHTML = `âœ… ìµœì‹  ì •ë³´ì…ë‹ˆë‹¤ (${status.totalStocks}ê°œ ì¢…ëª©, ${status.totalRecords.toLocaleString()}ê±´, ${status.newestDate})`;
          } else {
            // ì—…ë°ì´íŠ¸ í•„ìš”
            updateBtn.disabled = false;
            updateBtn.classList.add('bg-green-600', 'hover:bg-green-700');
            updateBtn.classList.remove('bg-gray-600', 'cursor-not-allowed', 'opacity-50');
            statusText.innerHTML = `âš ï¸ ì—…ë°ì´íŠ¸ í•„ìš” (${status.totalStocks}ê°œ ì¢…ëª©, ìµœì¢…: ${status.newestDate})`;
          }
        }
      } catch (err) {
        console.error('DB ìƒíƒœ í™•ì¸ ì‹¤íŒ¨:', err);
        document.getElementById('dbStatusText').innerHTML = 'âš ï¸ ìƒíƒœ í™•ì¸ ì‹¤íŒ¨';
      }
    }
    
    // DB ì´ˆê¸°í™”
    async function initializeDatabase() {
      if (!app.appKey || !app.appSecret) {
        alert('âŒ API KEYì™€ SECRETì„ ë¨¼ì € ì…ë ¥í•´ì£¼ì„¸ìš”!');
        return;
      }
      
      if (!confirm('DB ì´ˆê¸°í™”ë¥¼ ì‹œì‘í•©ë‹ˆë‹¤.\nì•½ 2ë¶„ ì†Œìš”ë©ë‹ˆë‹¤. ê³„ì†í•˜ì‹œê² ìŠµë‹ˆê¹Œ?')) {
        return;
      }
      
      try {
        showProgressModal();
        
        const response = await fetch('http://localhost:8080/api/v1/database/initialize', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({
            appKey: app.appKey,
            appSecret: app.appSecret,
            isProduction: app.isProduction
          })
        });
        
        const result = await response.json();
        
        if (response.status === 409) {
          // ì´ë¯¸ ì´ˆê¸°í™”ë¨
          alert('â„¹ï¸ ' + result.message + '\n\n' + result.error);
          hideProgressModal();
          checkDatabaseStatus();
        } else if (response.ok) {
          // ì§„í–‰ë¥  ì²´í¬ ì‹œì‘
          startProgressPolling();
        } else {
          throw new Error(result.error || 'DB ì´ˆê¸°í™” ì‹¤íŒ¨');
        }
      } catch (err) {
        alert('âŒ ì˜¤ë¥˜: ' + err.message);
        hideProgressModal();
      }
    }
    
    // DB ì¬êµ¬ì¶• (ê°•ì œ)
    async function rebuildDatabase() {
      if (!app.appKey || !app.appSecret) {
        alert('âŒ API KEYì™€ SECRETì„ ë¨¼ì € ì…ë ¥í•´ì£¼ì„¸ìš”!');
        return;
      }
      
      if (!confirm('âš ï¸ DBë¥¼ ì™„ì „íˆ ì¬êµ¬ì¶•í•©ë‹ˆë‹¤.\n\nê¸°ì¡´ ë°ì´í„°ê°€ ì‚­ì œë˜ê³  ì²˜ìŒë¶€í„° ë‹¤ì‹œ ìˆ˜ì§‘í•©ë‹ˆë‹¤.\nì•½ 2~3ë¶„ ì†Œìš”ë©ë‹ˆë‹¤.\n\nê³„ì†í•˜ì‹œê² ìŠµë‹ˆê¹Œ?')) {
        return;
      }
      
      try {
        showProgressModal();
        
        const response = await fetch('http://localhost:8080/api/v1/database/initialize', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({
            appKey: app.appKey,
            appSecret: app.appSecret,
            isProduction: app.isProduction,
            forceRebuild: true  // ê°•ì œ ì¬êµ¬ì¶•!
          })
        });
        
        const result = await response.json();
        
        if (!response.ok) {
          throw new Error(result.error || 'ì¬êµ¬ì¶• ì‹¤íŒ¨');
        }
        
        // ì§„í–‰ë¥  ì²´í¬ ì‹œì‘
        startProgressPolling();
        
      } catch (err) {
        alert('âŒ ì¬êµ¬ì¶• ì‹¤íŒ¨: ' + err.message);
        hideProgressModal();
      }
    }
    
    // DB ì—…ë°ì´íŠ¸
    async function updateDatabase() {
      if (!app.appKey || !app.appSecret) {
        alert('âŒ API KEYì™€ SECRETì„ ë¨¼ì € ì…ë ¥í•´ì£¼ì„¸ìš”!');
        return;
      }
      
      if (!confirm('DB ì—…ë°ì´íŠ¸ë¥¼ ì‹œì‘í•©ë‹ˆë‹¤.\nì•½ 30ì´ˆ ì†Œìš”ë©ë‹ˆë‹¤. ê³„ì†í•˜ì‹œê² ìŠµë‹ˆê¹Œ?')) {
        return;
      }
      
      try {
        showProgressModal();
        
        const response = await fetch('http://localhost:8080/api/v1/database/update', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({
            appKey: app.appKey,
            appSecret: app.appSecret,
            isProduction: app.isProduction
          })
        });
        
        const result = await response.json();
        
        // ì§„í–‰ë¥  ì²´í¬ ì‹œì‘
        startProgressPolling();
        
      } catch (err) {
        alert('âŒ ì—…ë°ì´íŠ¸ ì‹¤íŒ¨: ' + err.message);
        hideProgressModal();
      }
    }
    
    // í™œì„±í™”ëœ ì´ë™í‰ê·  ê¸°ê°„ ê°€ì ¸ì˜¤ê¸°
    function getActiveMAPeriod() {
      if (app.conditions.ma224Enabled) return 224;
      if (app.conditions.ma112Enabled) return 112;
      if (app.conditions.ma60Enabled) return 60;
      return null;
    }
    
    // ì´ë™í‰ê·  ê°’ ê°€ì ¸ì˜¤ê¸°
    function getMAValue(stock, period) {
      const value = stock[`ma${period}`];
      return value !== undefined && value !== null ? parseFloat(value).toLocaleString() : 'N/A';
    }
    
    // ì´ë™í‰ê·  ë¹„ìœ¨ ê°€ì ¸ì˜¤ê¸°
    function getMARatio(stock, period) {
      const ratio = stock[`ma${period}Ratio`];
      return ratio !== undefined && ratio !== null ? ratio : 'N/A';
    }
    
    // ì¢…ëª© ë§ˆìŠ¤í„° íŒŒì¼ ì—…ë¡œë“œ
    async function uploadStockMasterFiles() {
      const kospiFile = document.getElementById('kospiFile').files[0];
      const kosdaqFile = document.getElementById('kosdaqFile').files[0];
      
      if (!kospiFile && !kosdaqFile) {
        alert('âŒ KOSPI ë˜ëŠ” KOSDAQ íŒŒì¼ì„ ì„ íƒí•´ì£¼ì„¸ìš”!');
        return;
      }
      
      if (!confirm(`ğŸ“¤ ì¢…ëª© ë§ˆìŠ¤í„° íŒŒì¼ì„ ì—…ë¡œë“œí•©ë‹ˆë‹¤.\n\nKOSPI: ${kospiFile ? kospiFile.name : 'ì—†ìŒ'}\nKOSDAQ: ${kosdaqFile ? kosdaqFile.name : 'ì—†ìŒ'}\n\nê³„ì†í•˜ì‹œê² ìŠµë‹ˆê¹Œ?`)) {
        return;
      }
      
      try {
        const statusEl = document.getElementById('uploadStatus');
        statusEl.textContent = 'ğŸ“¤ ì—…ë¡œë“œ ì¤‘...';
        statusEl.className = 'mt-2 text-xs text-yellow-400';
        
        const formData = new FormData();
        if (kospiFile) formData.append('files', kospiFile);
        if (kosdaqFile) formData.append('files', kosdaqFile);
        
        const response = await fetch('http://localhost:8080/api/v1/database/upload-stock-master', {
          method: 'POST',
          body: formData
        });
        
        const result = await response.json();
        
        if (response.ok) {
          statusEl.textContent = `âœ… ì—…ë¡œë“œ ì™„ë£Œ! KOSPI: ${result.kospiCount}ê°œ, KOSDAQ: ${result.kosdaqCount}ê°œ, ì´: ${result.totalCount}ê°œ`;
          statusEl.className = 'mt-2 text-xs text-green-400';
          
          // DB ìƒíƒœ ê°±ì‹ 
          setTimeout(() => checkDatabaseStatus(), 1000);
          
          // íŒŒì¼ ì…ë ¥ ì´ˆê¸°í™”
          document.getElementById('kospiFile').value = '';
          document.getElementById('kosdaqFile').value = '';
        } else {
          throw new Error(result.error || 'ì—…ë¡œë“œ ì‹¤íŒ¨');
        }
        
      } catch (err) {
        const statusEl = document.getElementById('uploadStatus');
        statusEl.textContent = 'âŒ ì—…ë¡œë“œ ì‹¤íŒ¨: ' + err.message;
        statusEl.className = 'mt-2 text-xs text-red-400';
      }
    }

    async function validateCredentials() {
      try {
        const response = await fetch(`${API_BASE_URL}/api/v1/validate-credentials`, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({
            appKey: app.appKey,
            appSecret: app.appSecret
          })
        });
        
        const data = await response.json();
        if (data.valid) {
          app.error = '';
          return true;
        } else {
          throw new Error(data.message || 'ì¸ì¦ ì‹¤íŒ¨');
        }
      } catch (err) {
        app.error = 'API ì¸ì¦ ì‹¤íŒ¨: ' + err.message;
        render();
        return false;
      }
    }

    // ê¸°ìˆ ì  ì§€í‘œ ê³„ì‚° í•¨ìˆ˜ë“¤ì€ ë°±ì—”ë“œì—ì„œ ì²˜ë¦¬ë˜ë¯€ë¡œ ì œê±°ë¨

    async function runScreener() {
      if (!app.appKey || !app.appSecret) {
        app.error = 'APP KEYì™€ APP SECRETì„ ì…ë ¥í•´ì£¼ì„¸ìš”';
        render();
        return;
      }

      app.loading = true;
      app.error = '';
      app.results = [];
      render();

      try {
        // FastAPI ë°±ì—”ë“œë¡œ ìŠ¤í¬ë¦¬ë‹ ìš”ì²­ ì „ì†¡
        const response = await fetch(`${API_BASE_URL}/api/v1/screen`, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({
            appKey: app.appKey,
            appSecret: app.appSecret,
            isProduction: app.isProduction,
            ...app.conditions
          })
        });

        if (!response.ok) {
          const errorData = await response.json();
          throw new Error(errorData.error || errorData.detail || 'ìŠ¤í¬ë¦¬ë‹ ì‹¤íŒ¨');
        }

        const result = await response.json();
        
        // ê²°ê³¼ ë³€í™˜ (ë°±ì—”ë“œ ì‘ë‹µ í˜•ì‹ì— ë§ê²Œ)
        app.results = result.stocks.map(stock => ({
          code: stock.code,
          name: stock.name,
          currentPrice: stock.currentPrice,
          changePercent: stock.changePercent,
          ma5: stock.ma5,
          ma20: stock.ma20,
          ma60: stock.ma60,
          ma112: stock.ma112,
          ma224: stock.ma224,
          ma60Ratio: stock.ma60Ratio,
          ma112Ratio: stock.ma112Ratio,
          ma224Ratio: stock.ma224Ratio,
          bbPosition: stock.bbPosition,
          currentVolume: stock.volume,
          volumeRatio: stock.volumeRatio,
          maAlignment: stock.maAlignment
        }));

        console.log(`ìŠ¤í¬ë¦¬ë‹ ì™„ë£Œ: ${result.matchedCount}/${result.totalScanned} ì¢…ëª© (${result.executionTimeMs}ms)`);
        
      } catch (err) {
        app.error = 'ê²€ìƒ‰ ì¤‘ ì˜¤ë¥˜ ë°œìƒ: ' + err.message;
        console.error('Screening error:', err);
      } finally {
        app.loading = false;
        render();
      }
    }

    function render() {
      const appDiv = document.getElementById('app');
      appDiv.innerHTML = `
        <div class="text-center mb-8">
          <h1 class="text-3xl md:text-4xl font-bold text-white mb-2">ğŸ“ˆ ì£¼ì‹ ì¡°ê±´ ê²€ìƒ‰ê¸°</h1>
          <p class="text-blue-200">ê¸°ìˆ ì  ë¶„ì„ ê¸°ë°˜ ì¢…ëª© ìŠ¤í¬ë¦¬ë‹</p>
        </div>

        <div class="bg-white/10 backdrop-blur-md rounded-xl p-4 md:p-6 mb-6 border border-white/20">
          <h2 class="text-lg md:text-xl font-bold text-white mb-4">ğŸ”‘ í•œêµ­íˆ¬ìì¦ê¶Œ API ì„¤ì •</h2>
          
          <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-4">
            <div>
              <label class="block text-sm font-medium text-blue-200 mb-2">ê³„ì¢Œ êµ¬ë¶„</label>
              <div class="flex gap-4">
                <label class="flex items-center gap-2 text-white cursor-pointer">
                  <input type="radio" name="accountType" value="mock" ${!app.isProduction ? 'checked' : ''} class="w-4 h-4">
                  <span>ğŸ® ëª¨ì˜íˆ¬ì</span>
                </label>
                <label class="flex items-center gap-2 text-white cursor-pointer">
                  <input type="radio" name="accountType" value="real" ${app.isProduction ? 'checked' : ''} class="w-4 h-4">
                  <span class="text-green-400 font-semibold">ğŸ’ ì‹¤ì „íˆ¬ì</span>
                </label>
              </div>
            </div>
            <div>
              <label class="block text-sm font-medium text-blue-200 mb-2">ì‹œì¥ ì„ íƒ</label>
              <div class="flex gap-4">
                <label class="flex items-center gap-2 text-white cursor-pointer">
                  <input type="checkbox" id="searchDomestic" ${app.searchDomestic ? 'checked' : ''} class="w-4 h-4">
                  <span>ğŸ‡°ğŸ‡· êµ­ë‚´ì£¼ì‹</span>
                </label>
                <label class="flex items-center gap-2 text-white cursor-pointer">
                  <input type="checkbox" id="searchUS" ${app.searchUS ? 'checked' : ''} class="w-4 h-4">
                  <span>ğŸ‡ºğŸ‡¸ í•´ì™¸ì£¼ì‹</span>
                </label>
              </div>
            </div>
          </div>
          
          <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-4">
            <div>
              <label class="block text-sm font-medium text-blue-200 mb-2">APP KEY</label>
              <input type="text" id="appKey" value="${app.appKey}" placeholder="APP KEY ì…ë ¥"
                class="w-full px-4 py-2 bg-white/20 border border-white/30 rounded-lg text-white placeholder-white/50 focus:outline-none focus:ring-2 focus:ring-blue-400">
            </div>
            <div>
              <label class="block text-sm font-medium text-blue-200 mb-2">APP SECRET</label>
              <input type="password" id="appSecret" value="${app.appSecret}" placeholder="APP SECRET ì…ë ¥"
                class="w-full px-4 py-2 bg-white/20 border border-white/30 rounded-lg text-white placeholder-white/50 focus:outline-none focus:ring-2 focus:ring-blue-400">
            </div>
          </div>
          <div class="text-sm text-blue-200 bg-blue-900/30 p-3 rounded-lg mb-4">
            <strong>API í‚¤ ë°œê¸‰:</strong> í•œêµ­íˆ¬ìì¦ê¶Œ í™ˆí˜ì´ì§€ â†’ KIS Developers â†’ ì•± ë“±ë¡
          </div>
          
          <!-- DB ê´€ë¦¬ ì˜ì—­ -->
          <div id="dbManagement" class="border-t border-white/20 pt-4">
            <div class="flex items-center justify-between gap-4 flex-wrap">
              <div class="flex-1">
                <div class="text-sm font-medium text-blue-200">ğŸ“Š ë°ì´í„°ë² ì´ìŠ¤ ìƒíƒœ</div>
                <div id="dbStatusText" class="text-xs text-white/70 mt-1">í™•ì¸ ì¤‘...</div>
              </div>
              <div class="flex gap-2">
                <button id="dbInitBtn" onclick="initializeDatabase()" 
                  class="hidden px-4 py-2 bg-purple-600 hover:bg-purple-700 text-white rounded-lg text-sm font-medium transition-colors">
                  ğŸš€ DB ì´ˆê¸°í™”
                </button>
                <button id="dbRebuildBtn" onclick="rebuildDatabase()" 
                  class="hidden px-4 py-2 bg-orange-600 hover:bg-orange-700 text-white rounded-lg text-sm font-medium transition-colors">
                  ğŸ”„ DB ì¬êµ¬ì¶•
                </button>
                <button id="dbUpdateBtn" onclick="updateDatabase()" 
                  class="hidden px-4 py-2 bg-green-600 hover:bg-green-700 text-white rounded-lg text-sm font-medium transition-colors">
                  âœ¨ DB ì—…ë°ì´íŠ¸
                </button>
              </div>
            </div>
            
            <!-- ì¢…ëª© ë§ˆìŠ¤í„° íŒŒì¼ ì—…ë¡œë“œ -->
            <div class="mt-4 pt-4 border-t border-white/20">
              <div class="flex items-center justify-between mb-2">
                <div>
                  <div class="text-sm font-medium text-blue-200">ğŸ“ ì¢…ëª© ë§ˆìŠ¤í„° íŒŒì¼ ì—…ë¡œë“œ</div>
                  <div class="text-xs text-white/50 mt-1">í•œêµ­íˆ¬ìì¦ê¶Œ ì¢…ëª©ì •ë³´íŒŒì¼ (KOSPI, KOSDAQ)</div>
                </div>
              </div>
              <div class="grid grid-cols-2 gap-3">
                <!-- KOSPI íŒŒì¼ ì—…ë¡œë“œ -->
                <div>
                  <label class="block text-xs text-white/70 mb-1">KOSPI íŒŒì¼</label>
                  <input type="file" id="kospiFile" accept=".mst,.txt,.dat" 
                    class="block w-full text-xs text-white/70 file:mr-2 file:py-2 file:px-3 file:rounded-lg file:border-0 file:text-xs file:font-semibold file:bg-blue-600 file:text-white hover:file:bg-blue-700 file:cursor-pointer cursor-pointer bg-white/5 border border-white/20 rounded-lg">
                </div>
                <!-- KOSDAQ íŒŒì¼ ì—…ë¡œë“œ -->
                <div>
                  <label class="block text-xs text-white/70 mb-1">KOSDAQ íŒŒì¼</label>
                  <input type="file" id="kosdaqFile" accept=".mst,.txt,.dat" 
                    class="block w-full text-xs text-white/70 file:mr-2 file:py-2 file:px-3 file:rounded-lg file:border-0 file:text-xs file:font-semibold file:bg-blue-600 file:text-white hover:file:bg-blue-700 file:cursor-pointer cursor-pointer bg-white/5 border border-white/20 rounded-lg">
                </div>
              </div>
              <button onclick="uploadStockMasterFiles()" 
                class="mt-3 w-full px-4 py-2 bg-indigo-600 hover:bg-indigo-700 text-white rounded-lg text-sm font-medium transition-colors">
                ğŸ“¤ ì¢…ëª© íŒŒì¼ ì—…ë¡œë“œ
              </button>
              <div id="uploadStatus" class="mt-2 text-xs text-white/70"></div>
            </div>
          </div>
        </div>

        <div class="bg-white/10 backdrop-blur-md rounded-xl p-4 md:p-6 mb-6 border border-white/20">
          <h2 class="text-lg md:text-xl font-bold text-white mb-4">âš™ï¸ ì¡°ê±´ì„¤ì •</h2>
          
          <div class="mb-6">
            <h3 class="text-base md:text-lg font-semibold text-blue-200 mb-3">ì œì™¸ ì¡°ê±´</h3>
            <div class="grid grid-cols-2 gap-3">
              <label class="flex items-center gap-2 text-white cursor-pointer text-sm">
                <input type="checkbox" id="excludeManagement" ${app.conditions.excludeManagement ? 'checked' : ''} class="w-4 h-4">
                <span>ê´€ë¦¬ì¢…ëª©/íˆ¬ìê²½ê³ </span>
              </label>
              <label class="flex items-center gap-2 text-white cursor-pointer text-sm">
                <input type="checkbox" id="excludeETF" ${app.conditions.excludeETF ? 'checked' : ''} class="w-4 h-4">
                <span>ETF/ETN ì œì™¸</span>
              </label>
            </div>
          </div>

          <div class="mb-6">
            <h3 class="text-base md:text-lg font-semibold text-blue-200 mb-3">ì´ë™í‰ê· ì„  (í•˜ë‚˜ë§Œ ì„ íƒ)</h3>
            <div class="space-y-3">
              ${[
                { key: 'ma60', label: '60ì¼', period: 60 },
                { key: 'ma112', label: '112ì¼', period: 112 },
                { key: 'ma224', label: '224ì¼', period: 224 }
              ].map(ma => `
                <div class="flex items-center gap-2 flex-wrap">
                  <label class="flex items-center gap-2 text-white cursor-pointer text-sm">
                    <input type="radio" name="maPeriod" value="${ma.period}" id="${ma.key}Enabled" 
                      ${app.conditions[ma.key + 'Enabled'] ? 'checked' : ''} class="w-4 h-4">
                    <span>${ma.label} ì´í‰ Â±</span>
                  </label>
                  <input type="number" id="${ma.key}Min" value="${app.conditions[ma.key + 'Min']}" 
                    class="w-16 px-2 py-1 bg-white/20 border border-white/30 rounded text-white text-sm"
                    ${!app.conditions[ma.key + 'Enabled'] ? 'disabled' : ''}>
                  <span class="text-white">~</span>
                  <input type="number" id="${ma.key}Max" value="${app.conditions[ma.key + 'Max']}" 
                    class="w-16 px-2 py-1 bg-white/20 border border-white/30 rounded text-white text-sm"
                    ${!app.conditions[ma.key + 'Enabled'] ? 'disabled' : ''}>
                  <span class="text-blue-300 text-sm">%</span>
                </div>
              `).join('')}
              <div class="text-xs text-blue-300 bg-blue-900/20 p-2 rounded mt-2">
                ğŸ’¡ í˜„ì¬ê°€ê°€ ì„ íƒí•œ ì´ë™í‰ê· ì„  ëŒ€ë¹„ ì„¤ì •í•œ ë²”ìœ„ ë‚´ì— ìˆëŠ” ì¢…ëª©ì„ ì°¾ìŠµë‹ˆë‹¤
              </div>
            </div>
          </div>

          <div class="mb-6">
            <h3 class="text-base md:text-lg font-semibold text-blue-200 mb-3">ë³¼ë¦°ì € ë°´ë“œ</h3>
            <div class="space-y-3">
              <label class="flex items-center gap-2 text-white cursor-pointer text-sm">
                <input type="checkbox" id="bbEnabled" ${app.conditions.bbEnabled ? 'checked' : ''} class="w-4 h-4">
                <span>BB ì¡°ê±´ ì‚¬ìš©</span>
              </label>
              
              <div class="space-y-2 ml-6 ${!app.conditions.bbEnabled ? 'opacity-50' : ''}">
                <div class="text-sm text-blue-300 mb-2">ì „ëµ ì„ íƒ:</div>
                <label class="flex items-center gap-2 text-white cursor-pointer text-sm">
                  <input type="radio" name="bbPreset" value="short" 
                    ${app.conditions.bbPeriod === 10 && app.conditions.bbMultiplier === 1.5 ? 'checked' : ''}
                    ${!app.conditions.bbEnabled ? 'disabled' : ''} class="w-4 h-4">
                  <span>ë‹¨ê¸° íŠ¸ë ˆì´ë”© (10ì¼, Â±1.5Ïƒ) - ë¯¼ê°í•˜ê²Œ ë°˜ì‘</span>
                </label>
                <label class="flex items-center gap-2 text-white cursor-pointer text-sm">
                  <input type="radio" name="bbPreset" value="normal" 
                    ${app.conditions.bbPeriod === 20 && app.conditions.bbMultiplier === 2 ? 'checked' : ''}
                    ${!app.conditions.bbEnabled ? 'disabled' : ''} class="w-4 h-4">
                  <span>ì¼ë°˜ì  (20ì¼, Â±2Ïƒ) - ê°€ì¥ ë§ì´ ì‚¬ìš© â­</span>
                </label>
                <label class="flex items-center gap-2 text-white cursor-pointer text-sm">
                  <input type="radio" name="bbPreset" value="long" 
                    ${app.conditions.bbPeriod === 30 && app.conditions.bbMultiplier === 3 ? 'checked' : ''}
                    ${!app.conditions.bbEnabled ? 'disabled' : ''} class="w-4 h-4">
                  <span>ì¥ê¸° íˆ¬ì (30ì¼, Â±3Ïƒ) - ì•ˆì •ì </span>
                </label>
              </div>
              
              <select id="bbPosition" class="px-3 py-1 bg-white/20 border border-white/30 rounded text-white text-sm"
                ${!app.conditions.bbEnabled ? 'disabled' : ''}>
                <option value="all" ${app.conditions.bbPosition === 'all' ? 'selected' : ''}>ìœ„ì¹˜ ë¬´ê´€</option>
                <option value="lower" ${app.conditions.bbPosition === 'lower' ? 'selected' : ''}>í•˜ë‹¨ ë°´ë“œ ê·¼ì²˜ (ê³¼ë§¤ë„)</option>
                <option value="middle" ${app.conditions.bbPosition === 'middle' ? 'selected' : ''}>ì¤‘ê°„ ë°´ë“œ ê·¼ì²˜</option>
                <option value="upper" ${app.conditions.bbPosition === 'upper' ? 'selected' : ''}>ìƒë‹¨ ë°´ë“œ ê·¼ì²˜ (ê³¼ë§¤ìˆ˜)</option>
              </select>
              
              <div class="grid grid-cols-1 md:grid-cols-2 gap-3 mt-3">
                <label class="flex items-center gap-2 text-white cursor-pointer text-sm">
                  <input type="checkbox" id="bbUpperBreak" ${app.conditions.bbUpperBreak ? 'checked' : ''} class="w-4 h-4">
                  <span>ìƒë‹¨ ë°´ë“œ ëŒíŒŒ (ê°•í•œ ìƒìŠ¹)</span>
                </label>
                <label class="flex items-center gap-2 text-white cursor-pointer text-sm">
                  <input type="checkbox" id="bbLowerBreak" ${app.conditions.bbLowerBreak ? 'checked' : ''} class="w-4 h-4">
                  <span>í•˜ë‹¨ ë°´ë“œ í„°ì¹˜ (ë°˜ë“± ê¸°íšŒ)</span>
                </label>
              </div>
              
              <div class="text-xs text-blue-300 bg-blue-900/20 p-2 rounded mt-2">
                ğŸ’¡ ìƒë‹¨ ëŒíŒŒ: ì£¼ê°€ > ìƒë‹¨ ë°´ë“œ | í•˜ë‹¨ í„°ì¹˜: ì£¼ê°€ â‰¤ í•˜ë‹¨ ë°´ë“œ
              </div>
            </div>
          </div>

          <div class="mb-6">
            <h3 class="text-base md:text-lg font-semibold text-blue-200 mb-3">ê±°ë˜ëŸ‰</h3>
            <div class="flex items-center gap-2 flex-wrap">
              <label class="flex items-center gap-2 text-white cursor-pointer text-sm">
                <input type="checkbox" id="volumeEnabled" ${app.conditions.volumeEnabled ? 'checked' : ''} class="w-4 h-4">
                <span>í‰ê·  ëŒ€ë¹„</span>
              </label>
              <input type="number" step="0.1" id="volumeMultiple" value="${app.conditions.volumeMultiple}" 
                class="w-20 px-2 py-1 bg-white/20 border border-white/30 rounded text-white text-sm"
                ${!app.conditions.volumeEnabled ? 'disabled' : ''}>
              <span class="text-blue-300 text-sm">ë°°</span>
            </div>
          </div>

          <div class="mb-6">
            <h3 class="text-base md:text-lg font-semibold text-blue-200 mb-3">ê°€ê²© ë³€ë™</h3>
            <div class="space-y-2">
              <label class="flex items-center gap-2 text-white cursor-pointer text-sm">
                <input type="checkbox" id="priceChangeEnabled" ${app.conditions.priceChangeEnabled ? 'checked' : ''} class="w-4 h-4">
                <span>ë“±ë½ë¥  ë²”ìœ„</span>
              </label>
              <div class="flex items-center gap-2 ml-6">
                <input type="number" step="0.1" id="priceChangeMin" value="${app.conditions.priceChangeMin}" 
                  class="w-20 px-2 py-1 bg-white/20 border border-white/30 rounded text-white text-sm"
                  ${!app.conditions.priceChangeEnabled ? 'disabled' : ''}>
                <span class="text-white">~</span>
                <input type="number" step="0.1" id="priceChangeMax" value="${app.conditions.priceChangeMax}" 
                  class="w-20 px-2 py-1 bg-white/20 border border-white/30 rounded text-white text-sm"
                  ${!app.conditions.priceChangeEnabled ? 'disabled' : ''}>
                <span class="text-blue-300 text-sm">%</span>
              </div>
            </div>
          </div>

          <div class="mb-6">
            <h3 class="text-base md:text-lg font-semibold text-blue-200 mb-3">ì¶”ê°€ ì¡°ê±´</h3>
            <div class="space-y-2">
              <label class="flex items-center gap-2 text-white cursor-pointer text-sm">
                <input type="checkbox" id="maAlignment" ${app.conditions.maAlignment ? 'checked' : ''} class="w-4 h-4">
                <span>ì´í‰ì„  ì •ë°°ì—´ (5 > 20 > 60 > 112)</span>
              </label>
            </div>
          </div>

          <div class="mb-6">
            <h3 class="text-base md:text-lg font-semibold text-blue-200 mb-3">ì‹œê°€ì´ì•¡ (ì–µì›)</h3>
            <div class="space-y-2">
              <label class="flex items-center gap-2 text-white cursor-pointer text-sm">
                <input type="checkbox" id="marketCapEnabled" ${app.conditions.marketCapEnabled ? 'checked' : ''} class="w-4 h-4">
                <span>ì‹œê°€ì´ì•¡ ë²”ìœ„</span>
              </label>
              <div class="flex items-center gap-2 ml-6">
                <input type="number" step="1000" id="marketCapMin" value="${app.conditions.marketCapMin / 100000000}" 
                  class="w-24 px-2 py-1 bg-white/20 border border-white/30 rounded text-white text-sm"
                  ${!app.conditions.marketCapEnabled ? 'disabled' : ''}>
                <span class="text-white">~</span>
                <input type="number" step="1000" id="marketCapMax" value="${app.conditions.marketCapMax / 100000000}" 
                  class="w-24 px-2 py-1 bg-white/20 border border-white/30 rounded text-white text-sm"
                  ${!app.conditions.marketCapEnabled ? 'disabled' : ''}>
                <span class="text-blue-300 text-sm">ì–µ</span>
              </div>
            </div>
          </div>

          <div class="mb-6">
            <h3 class="text-base md:text-lg font-semibold text-blue-200 mb-3">ì¬ë¬´ ë¹„ìœ¨</h3>
            <div class="space-y-3">
              <div>
                <label class="flex items-center gap-2 text-white cursor-pointer text-sm mb-2">
                  <input type="checkbox" id="perEnabled" ${app.conditions.perEnabled ? 'checked' : ''} class="w-4 h-4">
                  <span>PER (ì£¼ê°€ìˆ˜ìµë¹„ìœ¨)</span>
                </label>
                <div class="flex items-center gap-2 ml-6">
                  <input type="number" step="1" id="perMin" value="${app.conditions.perMin}" 
                    class="w-20 px-2 py-1 bg-white/20 border border-white/30 rounded text-white text-sm"
                    ${!app.conditions.perEnabled ? 'disabled' : ''}>
                  <span class="text-white">~</span>
                  <input type="number" step="1" id="perMax" value="${app.conditions.perMax}" 
                    class="w-20 px-2 py-1 bg-white/20 border border-white/30 rounded text-white text-sm"
                    ${!app.conditions.perEnabled ? 'disabled' : ''}>
                </div>
              </div>
              <div>
                <label class="flex items-center gap-2 text-white cursor-pointer text-sm mb-2">
                  <input type="checkbox" id="pbrEnabled" ${app.conditions.pbrEnabled ? 'checked' : ''} class="w-4 h-4">
                  <span>PBR (ì£¼ê°€ìˆœìì‚°ë¹„ìœ¨)</span>
                </label>
                <div class="flex items-center gap-2 ml-6">
                  <input type="number" step="0.1" id="pbrMin" value="${app.conditions.pbrMin}" 
                    class="w-20 px-2 py-1 bg-white/20 border border-white/30 rounded text-white text-sm"
                    ${!app.conditions.pbrEnabled ? 'disabled' : ''}>
                  <span class="text-white">~</span>
                  <input type="number" step="0.1" id="pbrMax" value="${app.conditions.pbrMax}" 
                    class="w-20 px-2 py-1 bg-white/20 border border-white/30 rounded text-white text-sm"
                    ${!app.conditions.pbrEnabled ? 'disabled' : ''}>
                </div>
              </div>
            </div>
          </div>

          <button onclick="runScreener()" ${app.loading ? 'disabled' : ''}
            class="w-full bg-gradient-to-r from-blue-500 to-purple-600 hover:from-blue-600 hover:to-purple-700 disabled:from-gray-500 disabled:to-gray-600 text-white font-bold py-3 px-6 rounded-lg transition-all">
            ${app.loading ? 'ğŸ”„ ê²€ìƒ‰ ì¤‘...' : 'ğŸ” ì¡°ê±´ ê²€ìƒ‰ ì‹¤í–‰'}
          </button>
        </div>

        ${app.error ? `
          <div class="bg-red-500/20 border border-red-500 text-red-200 px-4 py-3 rounded-lg mb-6">
            ${app.error}
          </div>
        ` : ''}

        ${app.results.length > 0 ? `
          <div class="bg-white/10 backdrop-blur-md rounded-xl p-4 md:p-6 border border-white/20">
            <h2 class="text-lg md:text-xl font-bold text-white mb-4">âœ… ê²€ìƒ‰ ê²°ê³¼ (${app.results.length}ê°œ)</h2>
            <div class="overflow-x-auto">
              <table class="w-full text-left text-xs md:text-sm">
                <thead>
                  <tr class="border-b border-white/20">
                    <th class="px-2 py-2 text-blue-200">ì¢…ëª©ëª…</th>
                    <th class="px-2 py-2 text-blue-200">ì¢…ëª©ì½”ë“œ</th>
                    <th class="px-2 py-2 text-blue-200">í˜„ì¬ê°€</th>
                    <th class="px-2 py-2 text-blue-200">ë“±ë½%</th>
                    ${getActiveMAPeriod() ? `
                      <th class="px-2 py-2 text-blue-200">${getActiveMAPeriod()}ì¼ì„ </th>
                      <th class="px-2 py-2 text-blue-200">ë¹„ìœ¨</th>
                    ` : ''}
                  </tr>
                </thead>
                <tbody>
                  ${app.results.map(stock => `
                    <tr class="border-b border-white/10 hover:bg-white/5">
                      <td class="px-2 py-2 text-white font-medium">${stock.name}</td>
                      <td class="px-2 py-2 text-gray-300 text-xs">${stock.code}</td>
                      <td class="px-2 py-2 text-white">${parseFloat(stock.currentPrice).toLocaleString()}</td>
                      <td class="px-2 py-2 ${parseFloat(stock.changePercent) >= 0 ? 'text-red-400' : 'text-blue-400'} font-bold">
                        ${stock.changePercent}%
                      </td>
                      ${getActiveMAPeriod() ? `
                        <td class="px-2 py-2 text-white">${getMAValue(stock, getActiveMAPeriod())}</td>
                        <td class="px-2 py-2 text-green-400">${getMARatio(stock, getActiveMAPeriod())}%</td>
                      ` : ''}
                    </tr>
                  `).join('')}
                </tbody>
              </table>
            </div>
          </div>
        ` : !app.loading ? `
          <div class="bg-white/5 backdrop-blur-sm rounded-xl p-8 text-center border border-white/10">
            <p class="text-blue-200 text-base md:text-lg">API í‚¤ë¥¼ ì…ë ¥í•˜ê³  ì¡°ê±´ì„ ì„¤ì •í•œ í›„ ê²€ìƒ‰ì„ ì‹¤í–‰í•˜ì„¸ìš”</p>
          </div>
        ` : ''}
      `;

      // ì´ë²¤íŠ¸ ë¦¬ìŠ¤ë„ˆ ë“±ë¡
      ['appKey', 'appSecret'].forEach(id => {
        const el = document.getElementById(id);
        if (el) el.addEventListener('input', (e) => {
          app[id] = e.target.value;
        });
      });
      
      // ê³„ì¢Œ êµ¬ë¶„ ë¼ë””ì˜¤ ë²„íŠ¼
      document.querySelectorAll('input[name="accountType"]').forEach(radio => {
        radio.addEventListener('change', (e) => {
          app.isProduction = e.target.value === 'real';
          console.log('ê³„ì¢Œ êµ¬ë¶„ ë³€ê²½:', app.isProduction ? 'ì‹¤ì „íˆ¬ì' : 'ëª¨ì˜íˆ¬ì');
        });
      });
      
      // ì‹œì¥ ì„ íƒ ì²´í¬ë°•ìŠ¤
      ['searchDomestic', 'searchUS'].forEach(id => {
        const el = document.getElementById(id);
        if (el) el.addEventListener('change', (e) => {
          app[id] = e.target.checked;
          console.log('ì‹œì¥ ì„ íƒ:', id, app[id]);
        });
      });

      ['excludeETF', 'excludeManagement', 'bbEnabled', 'volumeEnabled', 'bbUpperBreak', 'bbLowerBreak', 'maAlignment', 'priceChangeEnabled', 'marketCapEnabled', 'perEnabled', 'pbrEnabled'].forEach(id => {
        const el = document.getElementById(id);
        if (el) el.addEventListener('change', (e) => {
          app.conditions[id] = e.target.checked;
          render();
        });
      });
      
      // ì´ë™í‰ê· ì„  ë¼ë””ì˜¤ ë²„íŠ¼
      document.querySelectorAll('input[name="maPeriod"]').forEach(radio => {
        radio.addEventListener('change', (e) => {
          // ëª¨ë“  MA ë¹„í™œì„±í™”
          app.conditions.ma60Enabled = false;
          app.conditions.ma112Enabled = false;
          app.conditions.ma224Enabled = false;
          
          // ì„ íƒëœ MAë§Œ í™œì„±í™”
          const period = e.target.value;
          if (period === '60') app.conditions.ma60Enabled = true;
          if (period === '112') app.conditions.ma112Enabled = true;
          if (period === '224') app.conditions.ma224Enabled = true;
          
          render();
        });
      });

      ['ma60Min', 'ma60Max', 'ma112Min', 'ma112Max', 'ma224Min', 'ma224Max', 'volumeMultiple', 'priceChangeMin', 'priceChangeMax', 'perMin', 'perMax', 'pbrMin', 'pbrMax'].forEach(id => {
        const el = document.getElementById(id);
        if (el) el.addEventListener('input', (e) => {
          app.conditions[id] = parseFloat(e.target.value);
        });
      });

      // ì‹œê°€ì´ì•¡ (ì–µì› ë‹¨ìœ„ ë³€í™˜)
      ['marketCapMin', 'marketCapMax'].forEach(id => {
        const el = document.getElementById(id);
        if (el) el.addEventListener('input', (e) => {
          app.conditions[id] = parseFloat(e.target.value) * 100000000; // ì–µì› â†’ ì›
        });
      });

      // ë³¼ë¦°ì € ë°´ë“œ í”„ë¦¬ì…‹ ë¼ë””ì˜¤ ë²„íŠ¼
      document.querySelectorAll('input[name="bbPreset"]').forEach(radio => {
        radio.addEventListener('change', (e) => {
          const presets = {
            short: { period: 10, multiplier: 1.5 },
            normal: { period: 20, multiplier: 2 },
            long: { period: 30, multiplier: 3 }
          };
          const preset = presets[e.target.value];
          if (preset) {
            app.conditions.bbPeriod = preset.period;
            app.conditions.bbMultiplier = preset.multiplier;
          }
        });
      });

      const bbPos = document.getElementById('bbPosition');
      if (bbPos) bbPos.addEventListener('change', (e) => {
        app.conditions.bbPosition = e.target.value;
      });
    }

    // ì´ˆê¸° ë Œë”ë§
    render();
    
    // DB ìƒíƒœ ìë™ í™•ì¸ (í˜ì´ì§€ ë¡œë“œ ì‹œ)
    setTimeout(checkDatabaseStatus, 500);
  </script>
</body>
</html>
