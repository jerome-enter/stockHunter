<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>제롬과 함께하는 행복 주식 검색기</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <style>
    body {
      background: linear-gradient(to bottom right, #0f172a, #1e3a8a, #0f172a);
      min-height: 100vh;
    }
  </style>
</head>
<body class="p-4 md:p-6">
  <div id="app" class="max-w-7xl mx-auto"></div>
  
  <!-- 진행률 모달 -->
  <div id="progressModal" class="hidden fixed inset-0 bg-black/50 backdrop-blur-sm flex items-center justify-center z-50">
    <div class="bg-gradient-to-br from-slate-900 to-slate-800 border border-white/20 rounded-2xl p-8 max-w-md w-full mx-4">
      <h3 class="text-2xl font-bold text-white mb-6">📊 DB 초기화 중...</h3>
      
      <div class="mb-4">
        <div class="flex justify-between text-white mb-2">
          <span id="progressText">준비 중...</span>
          <span id="progressPercent">0%</span>
        </div>
        <div class="w-full bg-slate-700 rounded-full h-4 overflow-hidden">
          <div id="progressBar" class="h-full bg-gradient-to-r from-blue-500 to-purple-500 transition-all duration-300" style="width: 0%"></div>
        </div>
      </div>
      
      <div class="text-sm text-white/70 space-y-2">
        <div class="flex justify-between">
          <span>처리 중:</span>
          <span id="progressCount">0 / 0</span>
        </div>
        <div class="flex justify-between">
          <span>현재 종목:</span>
          <span id="progressStock" class="font-mono">-</span>
        </div>
        <div class="flex justify-between">
          <span>경과 시간:</span>
          <span id="progressElapsed">0초</span>
        </div>
        <div class="flex justify-between">
          <span>남은 시간:</span>
          <span id="progressRemaining">계산 중...</span>
        </div>
      </div>
      
      <div class="mt-6 text-xs text-white/50 text-center">
        ⚠️ 한국투자증권 API 제약 준수 중 (초당 15건)
      </div>
    </div>
  </div>

  <script>
    const app = {
      selectedMarket: 'domestic',  // domestic or us
      isProduction: true,   // 실전투자 여부 (기본값)
      searchDomestic: true,   // 국내주식 검색 여부
      searchUS: false,        // 해외주식 검색 여부
      conditions: {
        market: 'domestic',
        exchangeCode: 'KRX',  // KRX(국내), NAS(나스닥), NYS(뉴욕)
        excludeManagement: false,
        ma60Enabled: false,
        ma60Min: 95,
        ma60Max: 105,
        ma112Enabled: true,
        ma112Min: 95,
        ma112Max: 105,
        ma224Enabled: false,
        ma224Min: 95,
        ma224Max: 105,
        excludeETF: true,
        excludeETN: true,
        volumeEnabled: false,
        volumeMultiple: 1.5,
        maAlignment: false,
        bbEnabled: false,
        bbPeriod: 20,
        bbMultiplier: 2,
        bbPosition: 'all',
        bbUpperBreak: false,
        bbLowerBreak: false,
        priceChangeEnabled: false,
        priceChangeMin: -100,
        priceChangeMax: 100,
        marketCapEnabled: false,
        marketCapMin: 0,
        marketCapMax: 10000000000000,
        perEnabled: false,
        perMin: 0,
        perMax: 30,
        pbrEnabled: false,
        pbrMin: 0,
        pbrMax: 3,
      },
      appKey: '',
      appSecret: '',
      accessToken: '',
      results: [],
      loading: false,
      error: ''
    };

    // FastAPI 백엔드 URL (같은 서버 사용)
    const API_BASE_URL = window.location.origin;
    
    let progressCheckInterval = null;

    // 진행률 모달 표시/숨김
    function showProgressModal() {
      document.getElementById('progressModal').classList.remove('hidden');
      startProgressCheck();
    }
    
    function hideProgressModal() {
      document.getElementById('progressModal').classList.add('hidden');
      stopProgressCheck();
    }
    
    // 진행률 폴링 시작
    function startProgressCheck() {
      progressCheckInterval = setInterval(updateProgress, 1000); // 1초마다
      updateProgress(); // 즉시 한 번 실행
    }
    
    // 진행률 폴링 중지
    function stopProgressCheck() {
      if (progressCheckInterval) {
        clearInterval(progressCheckInterval);
        progressCheckInterval = null;
      }
    }
    
    // 진행률 업데이트
    async function updateProgress() {
      try {
        const response = await fetch('http://localhost:8080/api/v1/database/progress');
        const progress = await response.json();
        
        document.getElementById('progressPercent').textContent = progress.percentage + '%';
        document.getElementById('progressBar').style.width = progress.percentage + '%';
        document.getElementById('progressCount').textContent = 
          `${progress.currentCount} / ${progress.totalCount}`;
        document.getElementById('progressStock').textContent = 
          progress.currentStock || '-';
        document.getElementById('progressElapsed').textContent = 
          formatSeconds(progress.elapsedSeconds);
        document.getElementById('progressRemaining').textContent = 
          progress.remainingSeconds > 0 ? formatSeconds(progress.remainingSeconds) : '계산 중...';
        
        if (progress.percentage > 0) {
          document.getElementById('progressText').textContent = '초기화 중...';
        }
        
        // 완료 시 모달 닫기 및 DB 상태 갱신
        if (!progress.isRunning && progress.currentCount > 0) {
          setTimeout(() => {
            hideProgressModal();
            // DB 상태 자동 갱신
            checkDatabaseStatus();
            alert('✅ DB 초기화 완료!\n이제 스크리닝을 실행하세요.');
          }, 1000);
        }
      } catch (err) {
        console.error('진행률 조회 실패:', err);
      }
    }
    
    // 초 → "분 초" 형식 변환
    function formatSeconds(seconds) {
      const min = Math.floor(seconds / 60);
      const sec = seconds % 60;
      return min > 0 ? `${min}분 ${sec}초` : `${sec}초`;
    }
    
    // 진행률 폴링 시작
    function startProgressPolling() {
      if (progressCheckInterval) {
        clearInterval(progressCheckInterval);
      }
      progressCheckInterval = setInterval(updateProgress, 1000);
      updateProgress(); // 즉시 한 번 실행
    }
    
    // DB 상태 확인 및 버튼 표시
    async function checkDatabaseStatus() {
      try {
        const response = await fetch('http://localhost:8080/api/v1/database/status');
        const status = await response.json();
        
        const initBtn = document.getElementById('dbInitBtn');
        const rebuildBtn = document.getElementById('dbRebuildBtn');
        const updateBtn = document.getElementById('dbUpdateBtn');
        const statusText = document.getElementById('dbStatusText');
        
        if (!status.initialized || status.totalStocks === 0) {
          // DB 없음 → 초기화 버튼만 표시
          initBtn.classList.remove('hidden');
          rebuildBtn.classList.add('hidden');
          updateBtn.classList.add('hidden');
          statusText.innerHTML = '❌ DB 미구축 (초기화 필요)';
        } else {
          // DB 있음 → 재구축 + 업데이트 버튼 표시
          initBtn.classList.add('hidden');
          rebuildBtn.classList.remove('hidden');
          updateBtn.classList.remove('hidden');
          
          // 최신 영업일 확인 (토요일, 일요일 제외)
          const now = new Date();
          const dayOfWeek = now.getDay(); // 0=일요일, 6=토요일
          
          // 가장 최근 영업일 계산
          let daysToSubtract = 1; // 기본: 어제(장 마감 후 기준)
          if (dayOfWeek === 0) {
            // 일요일 → 금요일까지가 최신 (2일 전)
            daysToSubtract = 2;
          } else if (dayOfWeek === 6) {
            // 토요일 → 금요일까지가 최신 (1일 전)
            daysToSubtract = 1;
          } else if (dayOfWeek === 1) {
            // 월요일 → 금요일까지가 최신 (3일 전)
            daysToSubtract = 3;
          }
          // 화~금은 전일(1일 전)이 최신
          
          const lastBusinessDay = new Date(now);
          lastBusinessDay.setDate(now.getDate() - daysToSubtract);
          const expectedDate = lastBusinessDay.toISOString().split('T')[0];
          
          const isUpToDate = status.newestDate >= expectedDate;
          
          if (isUpToDate) {
            // 최신 상태
            updateBtn.disabled = true;
            updateBtn.classList.remove('bg-green-600', 'hover:bg-green-700');
            updateBtn.classList.add('bg-gray-600', 'cursor-not-allowed', 'opacity-50');
            statusText.innerHTML = `✅ 최신 정보입니다 (${status.totalStocks}개 종목, ${status.totalRecords.toLocaleString()}건, ${status.newestDate})`;
          } else {
            // 업데이트 필요
            updateBtn.disabled = false;
            updateBtn.classList.add('bg-green-600', 'hover:bg-green-700');
            updateBtn.classList.remove('bg-gray-600', 'cursor-not-allowed', 'opacity-50');
            statusText.innerHTML = `⚠️ 업데이트 필요 (${status.totalStocks}개 종목, 최종: ${status.newestDate})`;
          }
        }
      } catch (err) {
        console.error('DB 상태 확인 실패:', err);
        document.getElementById('dbStatusText').innerHTML = '⚠️ 상태 확인 실패';
      }
    }
    
    // DB 초기화
    async function initializeDatabase() {
      if (!app.appKey || !app.appSecret) {
        alert('❌ API KEY와 SECRET을 먼저 입력해주세요!');
        return;
      }
      
      if (!confirm('DB 초기화를 시작합니다.\n약 2분 소요됩니다. 계속하시겠습니까?')) {
        return;
      }
      
      try {
        showProgressModal();
        
        const response = await fetch('http://localhost:8080/api/v1/database/initialize', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({
            appKey: app.appKey,
            appSecret: app.appSecret,
            isProduction: app.isProduction
          })
        });
        
        const result = await response.json();
        
        if (response.status === 409) {
          // 이미 초기화됨
          alert('ℹ️ ' + result.message + '\n\n' + result.error);
          hideProgressModal();
          checkDatabaseStatus();
        } else if (response.ok) {
          // 진행률 체크 시작
          startProgressPolling();
        } else {
          throw new Error(result.error || 'DB 초기화 실패');
        }
      } catch (err) {
        alert('❌ 오류: ' + err.message);
        hideProgressModal();
      }
    }
    
    // DB 재구축 (강제)
    async function rebuildDatabase() {
      if (!app.appKey || !app.appSecret) {
        alert('❌ API KEY와 SECRET을 먼저 입력해주세요!');
        return;
      }
      
      if (!confirm('⚠️ DB를 완전히 재구축합니다.\n\n기존 데이터가 삭제되고 처음부터 다시 수집합니다.\n약 2~3분 소요됩니다.\n\n계속하시겠습니까?')) {
        return;
      }
      
      try {
        showProgressModal();
        
        const response = await fetch('http://localhost:8080/api/v1/database/initialize', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({
            appKey: app.appKey,
            appSecret: app.appSecret,
            isProduction: app.isProduction,
            forceRebuild: true  // 강제 재구축!
          })
        });
        
        const result = await response.json();
        
        if (!response.ok) {
          throw new Error(result.error || '재구축 실패');
        }
        
        // 진행률 체크 시작
        startProgressPolling();
        
      } catch (err) {
        alert('❌ 재구축 실패: ' + err.message);
        hideProgressModal();
      }
    }
    
    // DB 업데이트
    async function updateDatabase() {
      if (!app.appKey || !app.appSecret) {
        alert('❌ API KEY와 SECRET을 먼저 입력해주세요!');
        return;
      }
      
      if (!confirm('DB 업데이트를 시작합니다.\n약 30초 소요됩니다. 계속하시겠습니까?')) {
        return;
      }
      
      try {
        showProgressModal();
        
        const response = await fetch('http://localhost:8080/api/v1/database/update', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({
            appKey: app.appKey,
            appSecret: app.appSecret,
            isProduction: app.isProduction
          })
        });
        
        const result = await response.json();
        
        // 진행률 체크 시작
        startProgressPolling();
        
      } catch (err) {
        alert('❌ 업데이트 실패: ' + err.message);
        hideProgressModal();
      }
    }
    
    // 활성화된 이동평균 기간 가져오기
    function getActiveMAPeriod() {
      if (app.conditions.ma224Enabled) return 224;
      if (app.conditions.ma112Enabled) return 112;
      if (app.conditions.ma60Enabled) return 60;
      return null;
    }
    
    // 이동평균 값 가져오기
    function getMAValue(stock, period) {
      const value = stock[`ma${period}`];
      return value !== undefined && value !== null ? parseFloat(value).toLocaleString() : 'N/A';
    }
    
    // 이동평균 비율 가져오기
    function getMARatio(stock, period) {
      const ratio = stock[`ma${period}Ratio`];
      return ratio !== undefined && ratio !== null ? ratio : 'N/A';
    }
    
    // 종목명 동기화
    async function syncStockNames() {
      if (!app.appKey || !app.appSecret) {
        alert('❌ API KEY와 SECRET을 먼저 입력해주세요!');
        return;
      }
      
      if (!confirm('🔄 DB의 종목코드로 한투 API에서 종목명을 가져옵니다.\n\n약 3,600개 × 70ms = 4-5분 소요\n\n계속하시겠습니까?')) {
        return;
      }
      
      try {
        const statusEl = document.getElementById('syncStatus');
        statusEl.textContent = '🔄 동기화 중... (4-5분 소요, 백그라운드 실행)';
        statusEl.className = 'mt-2 text-xs text-yellow-400';
        
        const response = await fetch('http://localhost:8080/api/v1/database/sync-stock-names', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({
            appKey: app.appKey,
            appSecret: app.appSecret,
            isProduction: app.isProduction
          })
        });
        
        if (response.ok) {
          statusEl.textContent = '✅ 동기화 시작! 4-5분 후 완료됩니다. docker logs로 진행상황 확인 가능';
          statusEl.className = 'mt-2 text-xs text-green-400';
        } else {
          throw new Error('동기화 실패');
        }
      } catch (err) {
        document.getElementById('syncStatus').textContent = '❌ 동기화 실패: ' + err.message;
        document.getElementById('syncStatus').className = 'mt-2 text-xs text-red-400';
      }
    }
    
    // 종목 마스터 파일 업로드
    async function uploadStockMasterFiles() {
      const kospiFile = document.getElementById('kospiFile').files[0];
      const kosdaqFile = document.getElementById('kosdaqFile').files[0];
      
      if (!kospiFile && !kosdaqFile) {
        alert('❌ KOSPI 또는 KOSDAQ 파일을 선택해주세요!');
        return;
      }
      
      if (!confirm(`📤 종목 마스터 파일을 업로드합니다.\n\nKOSPI: ${kospiFile ? kospiFile.name : '없음'}\nKOSDAQ: ${kosdaqFile ? kosdaqFile.name : '없음'}\n\n계속하시겠습니까?`)) {
        return;
      }
      
      try {
        const statusEl = document.getElementById('uploadStatus');
        statusEl.textContent = '📤 업로드 중...';
        statusEl.className = 'mt-2 text-xs text-yellow-400';
        
        const formData = new FormData();
        if (kospiFile) formData.append('files', kospiFile);
        if (kosdaqFile) formData.append('files', kosdaqFile);
        
        const response = await fetch('http://localhost:8080/api/v1/database/upload-stock-master', {
          method: 'POST',
          body: formData
        });
        
        const result = await response.json();
        
        if (response.ok) {
          statusEl.textContent = `✅ 업로드 완료! KOSPI: ${result.kospiCount}개, KOSDAQ: ${result.kosdaqCount}개, 총: ${result.totalCount}개`;
          statusEl.className = 'mt-2 text-xs text-green-400';
          
          // DB 상태 갱신
          setTimeout(() => checkDatabaseStatus(), 1000);
          
          // 파일 입력 초기화
          document.getElementById('kospiFile').value = '';
          document.getElementById('kosdaqFile').value = '';
        } else {
          throw new Error(result.error || '업로드 실패');
        }
        
      } catch (err) {
        const statusEl = document.getElementById('uploadStatus');
        statusEl.textContent = '❌ 업로드 실패: ' + err.message;
        statusEl.className = 'mt-2 text-xs text-red-400';
      }
    }

    async function validateCredentials() {
      try {
        const response = await fetch(`${API_BASE_URL}/api/v1/validate-credentials`, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({
            appKey: app.appKey,
            appSecret: app.appSecret
          })
        });
        
        const data = await response.json();
        if (data.valid) {
          app.error = '';
          return true;
        } else {
          throw new Error(data.message || '인증 실패');
        }
      } catch (err) {
        app.error = 'API 인증 실패: ' + err.message;
        render();
        return false;
      }
    }

    // 기술적 지표 계산 함수들은 백엔드에서 처리되므로 제거됨

    async function runScreener() {
      if (!app.appKey || !app.appSecret) {
        app.error = 'APP KEY와 APP SECRET을 입력해주세요';
        render();
        return;
      }

      app.loading = true;
      app.error = '';
      app.results = [];
      render();

      try {
        // FastAPI 백엔드로 스크리닝 요청 전송
        const response = await fetch(`${API_BASE_URL}/api/v1/screen`, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({
            appKey: app.appKey,
            appSecret: app.appSecret,
            isProduction: app.isProduction,
            ...app.conditions
          })
        });

        if (!response.ok) {
          const errorData = await response.json();
          throw new Error(errorData.error || errorData.detail || '스크리닝 실패');
        }

        const result = await response.json();
        
        // 결과 변환 (백엔드 응답 형식에 맞게)
        app.results = result.stocks.map(stock => ({
          code: stock.code,
          name: stock.name,
          currentPrice: stock.currentPrice,
          changePercent: stock.changePercent,
          ma5: stock.ma5,
          ma20: stock.ma20,
          ma60: stock.ma60,
          ma112: stock.ma112,
          ma224: stock.ma224,
          ma60Ratio: stock.ma60Ratio,
          ma112Ratio: stock.ma112Ratio,
          ma224Ratio: stock.ma224Ratio,
          bbPosition: stock.bbPosition,
          currentVolume: stock.volume,
          volumeRatio: stock.volumeRatio,
          maAlignment: stock.maAlignment
        }));

        console.log(`스크리닝 완료: ${result.matchedCount}/${result.totalScanned} 종목 (${result.executionTimeMs}ms)`);
        
      } catch (err) {
        app.error = '검색 중 오류 발생: ' + err.message;
        console.error('Screening error:', err);
      } finally {
        app.loading = false;
        render();
      }
    }

    function render() {
      const appDiv = document.getElementById('app');
      appDiv.innerHTML = `
        <div class="text-center mb-8">
          <h1 class="text-3xl md:text-4xl font-bold text-white mb-2">📈 주식 조건 검색기</h1>
          <p class="text-blue-200">기술적 분석 기반 종목 스크리닝</p>
        </div>

        <div class="bg-white/10 backdrop-blur-md rounded-xl p-4 md:p-6 mb-6 border border-white/20">
          <h2 class="text-lg md:text-xl font-bold text-white mb-4">🔑 한국투자증권 API 설정</h2>
          
          <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-4">
            <div>
              <label class="block text-sm font-medium text-blue-200 mb-2">계좌 구분</label>
              <div class="flex gap-4">
                <label class="flex items-center gap-2 text-white cursor-pointer">
                  <input type="radio" name="accountType" value="mock" ${!app.isProduction ? 'checked' : ''} class="w-4 h-4">
                  <span>🎮 모의투자</span>
                </label>
                <label class="flex items-center gap-2 text-white cursor-pointer">
                  <input type="radio" name="accountType" value="real" ${app.isProduction ? 'checked' : ''} class="w-4 h-4">
                  <span class="text-green-400 font-semibold">💎 실전투자</span>
                </label>
              </div>
            </div>
            <div>
              <label class="block text-sm font-medium text-blue-200 mb-2">시장 선택</label>
              <div class="flex gap-4">
                <label class="flex items-center gap-2 text-white cursor-pointer">
                  <input type="checkbox" id="searchDomestic" ${app.searchDomestic ? 'checked' : ''} class="w-4 h-4">
                  <span>🇰🇷 국내주식</span>
                </label>
                <label class="flex items-center gap-2 text-white cursor-pointer">
                  <input type="checkbox" id="searchUS" ${app.searchUS ? 'checked' : ''} class="w-4 h-4">
                  <span>🇺🇸 해외주식</span>
                </label>
              </div>
            </div>
          </div>
          
          <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-4">
            <div>
              <label class="block text-sm font-medium text-blue-200 mb-2">APP KEY</label>
              <input type="text" id="appKey" value="${app.appKey}" placeholder="APP KEY 입력"
                class="w-full px-4 py-2 bg-white/20 border border-white/30 rounded-lg text-white placeholder-white/50 focus:outline-none focus:ring-2 focus:ring-blue-400">
            </div>
            <div>
              <label class="block text-sm font-medium text-blue-200 mb-2">APP SECRET</label>
              <input type="password" id="appSecret" value="${app.appSecret}" placeholder="APP SECRET 입력"
                class="w-full px-4 py-2 bg-white/20 border border-white/30 rounded-lg text-white placeholder-white/50 focus:outline-none focus:ring-2 focus:ring-blue-400">
            </div>
          </div>
          <div class="text-sm text-blue-200 bg-blue-900/30 p-3 rounded-lg mb-4">
            <strong>API 키 발급:</strong> 한국투자증권 홈페이지 → KIS Developers → 앱 등록
          </div>
          
          <!-- DB 관리 영역 -->
          <div id="dbManagement" class="border-t border-white/20 pt-4">
            <div class="flex items-center justify-between gap-4 flex-wrap">
              <div class="flex-1">
                <div class="text-sm font-medium text-blue-200">📊 데이터베이스 상태</div>
                <div id="dbStatusText" class="text-xs text-white/70 mt-1">확인 중...</div>
              </div>
              <div class="flex gap-2">
                <button id="dbInitBtn" onclick="initializeDatabase()" 
                  class="hidden px-4 py-2 bg-purple-600 hover:bg-purple-700 text-white rounded-lg text-sm font-medium transition-colors">
                  🚀 DB 초기화
                </button>
                <button id="dbRebuildBtn" onclick="rebuildDatabase()" 
                  class="hidden px-4 py-2 bg-orange-600 hover:bg-orange-700 text-white rounded-lg text-sm font-medium transition-colors">
                  🔄 DB 재구축
                </button>
                <button id="dbUpdateBtn" onclick="updateDatabase()" 
                  class="hidden px-4 py-2 bg-green-600 hover:bg-green-700 text-white rounded-lg text-sm font-medium transition-colors">
                  ✨ DB 업데이트
                </button>
              </div>
            </div>
            
            <!-- 종목 마스터 파일 업로드 -->
            <div class="mt-4 pt-4 border-t border-white/20">
              <div class="flex items-center justify-between mb-2">
                <div>
                  <div class="text-sm font-medium text-blue-200">📁 종목 마스터 파일 업로드</div>
                  <div class="text-xs text-white/50 mt-1">한국투자증권 종목정보파일 (KOSPI, KOSDAQ)</div>
                </div>
              </div>
              <div class="grid grid-cols-2 gap-3">
                <!-- KOSPI 파일 업로드 -->
                <div>
                  <label class="block text-xs text-white/70 mb-1">KOSPI 파일</label>
                  <input type="file" id="kospiFile" accept=".mst,.txt,.dat" 
                    class="block w-full text-xs text-white/70 file:mr-2 file:py-2 file:px-3 file:rounded-lg file:border-0 file:text-xs file:font-semibold file:bg-blue-600 file:text-white hover:file:bg-blue-700 file:cursor-pointer cursor-pointer bg-white/5 border border-white/20 rounded-lg">
                </div>
                <!-- KOSDAQ 파일 업로드 -->
                <div>
                  <label class="block text-xs text-white/70 mb-1">KOSDAQ 파일</label>
                  <input type="file" id="kosdaqFile" accept=".mst,.txt,.dat" 
                    class="block w-full text-xs text-white/70 file:mr-2 file:py-2 file:px-3 file:rounded-lg file:border-0 file:text-xs file:font-semibold file:bg-blue-600 file:text-white hover:file:bg-blue-700 file:cursor-pointer cursor-pointer bg-white/5 border border-white/20 rounded-lg">
                </div>
              </div>
              <button onclick="uploadStockMasterFiles()" 
                class="mt-3 w-full px-4 py-2 bg-indigo-600 hover:bg-indigo-700 text-white rounded-lg text-sm font-medium transition-colors">
                📤 종목 파일 업로드
              </button>
              <div id="uploadStatus" class="mt-2 text-xs text-white/70"></div>
              
              <div class="mt-4 pt-4 border-t border-white/20">
                <div class="text-xs text-white/50 mb-2">💡 DB 종목코드로 한투 API에서 종목명 자동 갱신 (4-5분)</div>
                <button onclick="syncStockNames()" 
                  class="w-full px-4 py-2 bg-teal-600 hover:bg-teal-700 text-white rounded-lg text-sm font-medium transition-colors">
                  🔄 종목명 동기화
                </button>
                <div id="syncStatus" class="mt-2 text-xs text-white/70"></div>
              </div>
            </div>
          </div>
        </div>

        <div class="bg-white/10 backdrop-blur-md rounded-xl p-4 md:p-6 mb-6 border border-white/20">
          <h2 class="text-lg md:text-xl font-bold text-white mb-4">⚙️ 조건설정</h2>
          
          <div class="mb-6">
            <h3 class="text-base md:text-lg font-semibold text-blue-200 mb-3">제외 조건</h3>
            <div class="grid grid-cols-2 gap-3">
              <label class="flex items-center gap-2 text-white cursor-pointer text-sm">
                <input type="checkbox" id="excludeManagement" ${app.conditions.excludeManagement ? 'checked' : ''} class="w-4 h-4">
                <span>관리종목/투자경고</span>
              </label>
              <label class="flex items-center gap-2 text-white cursor-pointer text-sm">
                <input type="checkbox" id="excludeETF" ${app.conditions.excludeETF ? 'checked' : ''} class="w-4 h-4">
                <span>ETF/ETN 제외</span>
              </label>
            </div>
          </div>

          <div class="mb-6">
            <h3 class="text-base md:text-lg font-semibold text-blue-200 mb-3">이동평균선 (하나만 선택)</h3>
            <div class="space-y-3">
              ${[
                { key: 'ma60', label: '60일', period: 60 },
                { key: 'ma112', label: '112일', period: 112 },
                { key: 'ma224', label: '224일', period: 224 }
              ].map(ma => `
                <div class="flex items-center gap-2 flex-wrap">
                  <label class="flex items-center gap-2 text-white cursor-pointer text-sm">
                    <input type="radio" name="maPeriod" value="${ma.period}" id="${ma.key}Enabled" 
                      ${app.conditions[ma.key + 'Enabled'] ? 'checked' : ''} class="w-4 h-4">
                    <span>${ma.label} 이평 ±</span>
                  </label>
                  <input type="number" id="${ma.key}Min" value="${app.conditions[ma.key + 'Min']}" 
                    class="w-16 px-2 py-1 bg-white/20 border border-white/30 rounded text-white text-sm"
                    ${!app.conditions[ma.key + 'Enabled'] ? 'disabled' : ''}>
                  <span class="text-white">~</span>
                  <input type="number" id="${ma.key}Max" value="${app.conditions[ma.key + 'Max']}" 
                    class="w-16 px-2 py-1 bg-white/20 border border-white/30 rounded text-white text-sm"
                    ${!app.conditions[ma.key + 'Enabled'] ? 'disabled' : ''}>
                  <span class="text-blue-300 text-sm">%</span>
                </div>
              `).join('')}
              <div class="text-xs text-blue-300 bg-blue-900/20 p-2 rounded mt-2">
                💡 현재가가 선택한 이동평균선 대비 설정한 범위 내에 있는 종목을 찾습니다
              </div>
            </div>
          </div>

          <div class="mb-6">
            <h3 class="text-base md:text-lg font-semibold text-blue-200 mb-3">볼린저 밴드</h3>
            <div class="space-y-3">
              <label class="flex items-center gap-2 text-white cursor-pointer text-sm">
                <input type="checkbox" id="bbEnabled" ${app.conditions.bbEnabled ? 'checked' : ''} class="w-4 h-4">
                <span>BB 조건 사용</span>
              </label>
              
              <div class="space-y-2 ml-6 ${!app.conditions.bbEnabled ? 'opacity-50' : ''}">
                <div class="text-sm text-blue-300 mb-2">전략 선택:</div>
                <label class="flex items-center gap-2 text-white cursor-pointer text-sm">
                  <input type="radio" name="bbPreset" value="short" 
                    ${app.conditions.bbPeriod === 10 && app.conditions.bbMultiplier === 1.5 ? 'checked' : ''}
                    ${!app.conditions.bbEnabled ? 'disabled' : ''} class="w-4 h-4">
                  <span>단기 트레이딩 (10일, ±1.5σ) - 민감하게 반응</span>
                </label>
                <label class="flex items-center gap-2 text-white cursor-pointer text-sm">
                  <input type="radio" name="bbPreset" value="normal" 
                    ${app.conditions.bbPeriod === 20 && app.conditions.bbMultiplier === 2 ? 'checked' : ''}
                    ${!app.conditions.bbEnabled ? 'disabled' : ''} class="w-4 h-4">
                  <span>일반적 (20일, ±2σ) - 가장 많이 사용 ⭐</span>
                </label>
                <label class="flex items-center gap-2 text-white cursor-pointer text-sm">
                  <input type="radio" name="bbPreset" value="long" 
                    ${app.conditions.bbPeriod === 30 && app.conditions.bbMultiplier === 3 ? 'checked' : ''}
                    ${!app.conditions.bbEnabled ? 'disabled' : ''} class="w-4 h-4">
                  <span>장기 투자 (30일, ±3σ) - 안정적</span>
                </label>
              </div>
              
              <select id="bbPosition" class="px-3 py-1 bg-white/20 border border-white/30 rounded text-white text-sm"
                ${!app.conditions.bbEnabled ? 'disabled' : ''}>
                <option value="all" ${app.conditions.bbPosition === 'all' ? 'selected' : ''}>위치 무관</option>
                <option value="lower" ${app.conditions.bbPosition === 'lower' ? 'selected' : ''}>하단 밴드 근처 (과매도)</option>
                <option value="middle" ${app.conditions.bbPosition === 'middle' ? 'selected' : ''}>중간 밴드 근처</option>
                <option value="upper" ${app.conditions.bbPosition === 'upper' ? 'selected' : ''}>상단 밴드 근처 (과매수)</option>
              </select>
              
              <div class="grid grid-cols-1 md:grid-cols-2 gap-3 mt-3">
                <label class="flex items-center gap-2 text-white cursor-pointer text-sm">
                  <input type="checkbox" id="bbUpperBreak" ${app.conditions.bbUpperBreak ? 'checked' : ''} class="w-4 h-4">
                  <span>상단 밴드 돌파 (강한 상승)</span>
                </label>
                <label class="flex items-center gap-2 text-white cursor-pointer text-sm">
                  <input type="checkbox" id="bbLowerBreak" ${app.conditions.bbLowerBreak ? 'checked' : ''} class="w-4 h-4">
                  <span>하단 밴드 터치 (반등 기회)</span>
                </label>
              </div>
              
              <div class="text-xs text-blue-300 bg-blue-900/20 p-2 rounded mt-2">
                💡 상단 돌파: 주가 > 상단 밴드 | 하단 터치: 주가 ≤ 하단 밴드
              </div>
            </div>
          </div>

          <div class="mb-6">
            <h3 class="text-base md:text-lg font-semibold text-blue-200 mb-3">거래량</h3>
            <div class="flex items-center gap-2 flex-wrap">
              <label class="flex items-center gap-2 text-white cursor-pointer text-sm">
                <input type="checkbox" id="volumeEnabled" ${app.conditions.volumeEnabled ? 'checked' : ''} class="w-4 h-4">
                <span>평균 대비</span>
              </label>
              <input type="number" step="0.1" id="volumeMultiple" value="${app.conditions.volumeMultiple}" 
                class="w-20 px-2 py-1 bg-white/20 border border-white/30 rounded text-white text-sm"
                ${!app.conditions.volumeEnabled ? 'disabled' : ''}>
              <span class="text-blue-300 text-sm">배</span>
            </div>
          </div>

          <div class="mb-6">
            <h3 class="text-base md:text-lg font-semibold text-blue-200 mb-3">가격 변동</h3>
            <div class="space-y-2">
              <label class="flex items-center gap-2 text-white cursor-pointer text-sm">
                <input type="checkbox" id="priceChangeEnabled" ${app.conditions.priceChangeEnabled ? 'checked' : ''} class="w-4 h-4">
                <span>등락률 범위</span>
              </label>
              <div class="flex items-center gap-2 ml-6">
                <input type="number" step="0.1" id="priceChangeMin" value="${app.conditions.priceChangeMin}" 
                  class="w-20 px-2 py-1 bg-white/20 border border-white/30 rounded text-white text-sm"
                  ${!app.conditions.priceChangeEnabled ? 'disabled' : ''}>
                <span class="text-white">~</span>
                <input type="number" step="0.1" id="priceChangeMax" value="${app.conditions.priceChangeMax}" 
                  class="w-20 px-2 py-1 bg-white/20 border border-white/30 rounded text-white text-sm"
                  ${!app.conditions.priceChangeEnabled ? 'disabled' : ''}>
                <span class="text-blue-300 text-sm">%</span>
              </div>
            </div>
          </div>

          <div class="mb-6">
            <h3 class="text-base md:text-lg font-semibold text-blue-200 mb-3">추가 조건</h3>
            <div class="space-y-2">
              <label class="flex items-center gap-2 text-white cursor-pointer text-sm">
                <input type="checkbox" id="maAlignment" ${app.conditions.maAlignment ? 'checked' : ''} class="w-4 h-4">
                <span>이평선 정배열 (5 > 20 > 60 > 112)</span>
              </label>
            </div>
          </div>

          <div class="mb-6">
            <h3 class="text-base md:text-lg font-semibold text-blue-200 mb-3">시가총액 (억원)</h3>
            <div class="space-y-2">
              <label class="flex items-center gap-2 text-white cursor-pointer text-sm">
                <input type="checkbox" id="marketCapEnabled" ${app.conditions.marketCapEnabled ? 'checked' : ''} class="w-4 h-4">
                <span>시가총액 범위</span>
              </label>
              <div class="flex items-center gap-2 ml-6">
                <input type="number" step="1000" id="marketCapMin" value="${app.conditions.marketCapMin / 100000000}" 
                  class="w-24 px-2 py-1 bg-white/20 border border-white/30 rounded text-white text-sm"
                  ${!app.conditions.marketCapEnabled ? 'disabled' : ''}>
                <span class="text-white">~</span>
                <input type="number" step="1000" id="marketCapMax" value="${app.conditions.marketCapMax / 100000000}" 
                  class="w-24 px-2 py-1 bg-white/20 border border-white/30 rounded text-white text-sm"
                  ${!app.conditions.marketCapEnabled ? 'disabled' : ''}>
                <span class="text-blue-300 text-sm">억</span>
              </div>
            </div>
          </div>

          <div class="mb-6">
            <h3 class="text-base md:text-lg font-semibold text-blue-200 mb-3">재무 비율</h3>
            <div class="space-y-3">
              <div>
                <label class="flex items-center gap-2 text-white cursor-pointer text-sm mb-2">
                  <input type="checkbox" id="perEnabled" ${app.conditions.perEnabled ? 'checked' : ''} class="w-4 h-4">
                  <span>PER (주가수익비율)</span>
                </label>
                <div class="flex items-center gap-2 ml-6">
                  <input type="number" step="1" id="perMin" value="${app.conditions.perMin}" 
                    class="w-20 px-2 py-1 bg-white/20 border border-white/30 rounded text-white text-sm"
                    ${!app.conditions.perEnabled ? 'disabled' : ''}>
                  <span class="text-white">~</span>
                  <input type="number" step="1" id="perMax" value="${app.conditions.perMax}" 
                    class="w-20 px-2 py-1 bg-white/20 border border-white/30 rounded text-white text-sm"
                    ${!app.conditions.perEnabled ? 'disabled' : ''}>
                </div>
              </div>
              <div>
                <label class="flex items-center gap-2 text-white cursor-pointer text-sm mb-2">
                  <input type="checkbox" id="pbrEnabled" ${app.conditions.pbrEnabled ? 'checked' : ''} class="w-4 h-4">
                  <span>PBR (주가순자산비율)</span>
                </label>
                <div class="flex items-center gap-2 ml-6">
                  <input type="number" step="0.1" id="pbrMin" value="${app.conditions.pbrMin}" 
                    class="w-20 px-2 py-1 bg-white/20 border border-white/30 rounded text-white text-sm"
                    ${!app.conditions.pbrEnabled ? 'disabled' : ''}>
                  <span class="text-white">~</span>
                  <input type="number" step="0.1" id="pbrMax" value="${app.conditions.pbrMax}" 
                    class="w-20 px-2 py-1 bg-white/20 border border-white/30 rounded text-white text-sm"
                    ${!app.conditions.pbrEnabled ? 'disabled' : ''}>
                </div>
              </div>
            </div>
          </div>

          <button onclick="runScreener()" ${app.loading ? 'disabled' : ''}
            class="w-full bg-gradient-to-r from-blue-500 to-purple-600 hover:from-blue-600 hover:to-purple-700 disabled:from-gray-500 disabled:to-gray-600 text-white font-bold py-3 px-6 rounded-lg transition-all">
            ${app.loading ? '🔄 검색 중...' : '🔍 조건 검색 실행'}
          </button>
        </div>

        ${app.error ? `
          <div class="bg-red-500/20 border border-red-500 text-red-200 px-4 py-3 rounded-lg mb-6">
            ${app.error}
          </div>
        ` : ''}

        ${app.results.length > 0 ? `
          <div class="bg-white/10 backdrop-blur-md rounded-xl p-4 md:p-6 border border-white/20">
            <div class="flex items-center justify-between mb-4">
              <h2 class="text-lg md:text-xl font-bold text-white">✅ 검색 결과 (${app.results.length}개)</h2>
              <div class="text-xs text-blue-300">
                💡 비율: 현재가가 이평선보다 얼마나 높은지 (100% = 일치, 105% = 5% 위)
              </div>
            </div>
            <div class="overflow-x-auto">
              <table class="w-full text-left text-xs md:text-sm">
                <thead>
                  <tr class="border-b border-white/20">
                    <th class="px-2 py-2 text-blue-200">종목명</th>
                    <th class="px-2 py-2 text-blue-200">종목코드</th>
                    <th class="px-2 py-2 text-blue-200">현재가</th>
                    <th class="px-2 py-2 text-blue-200">등락%</th>
                    ${getActiveMAPeriod() ? `
                      <th class="px-2 py-2 text-blue-200">${getActiveMAPeriod()}일선</th>
                      <th class="px-2 py-2 text-blue-200">비율</th>
                    ` : ''}
                  </tr>
                </thead>
                <tbody>
                  ${app.results.map(stock => `
                    <tr class="border-b border-white/10 hover:bg-white/5">
                      <td class="px-2 py-2 text-white font-medium">${stock.name}</td>
                      <td class="px-2 py-2 text-gray-300 text-xs">${stock.code}</td>
                      <td class="px-2 py-2 text-white">${parseFloat(stock.currentPrice).toLocaleString()}</td>
                      <td class="px-2 py-2 ${parseFloat(stock.changePercent) >= 0 ? 'text-red-400' : 'text-blue-400'} font-bold">
                        ${stock.changePercent}%
                      </td>
                      ${getActiveMAPeriod() ? `
                        <td class="px-2 py-2 text-white">${getMAValue(stock, getActiveMAPeriod())}</td>
                        <td class="px-2 py-2 text-green-400">${getMARatio(stock, getActiveMAPeriod())}%</td>
                      ` : ''}
                    </tr>
                  `).join('')}
                </tbody>
              </table>
            </div>
          </div>
        ` : !app.loading ? `
          <div class="bg-white/5 backdrop-blur-sm rounded-xl p-8 text-center border border-white/10">
            <p class="text-blue-200 text-base md:text-lg">API 키를 입력하고 조건을 설정한 후 검색을 실행하세요</p>
          </div>
        ` : ''}
      `;

      // 이벤트 리스너 등록
      ['appKey', 'appSecret'].forEach(id => {
        const el = document.getElementById(id);
        if (el) el.addEventListener('input', (e) => {
          app[id] = e.target.value;
        });
      });
      
      // 계좌 구분 라디오 버튼
      document.querySelectorAll('input[name="accountType"]').forEach(radio => {
        radio.addEventListener('change', (e) => {
          app.isProduction = e.target.value === 'real';
          console.log('계좌 구분 변경:', app.isProduction ? '실전투자' : '모의투자');
        });
      });
      
      // 시장 선택 체크박스
      ['searchDomestic', 'searchUS'].forEach(id => {
        const el = document.getElementById(id);
        if (el) el.addEventListener('change', (e) => {
          app[id] = e.target.checked;
          console.log('시장 선택:', id, app[id]);
        });
      });

      ['excludeETF', 'excludeManagement', 'bbEnabled', 'volumeEnabled', 'bbUpperBreak', 'bbLowerBreak', 'maAlignment', 'priceChangeEnabled', 'marketCapEnabled', 'perEnabled', 'pbrEnabled'].forEach(id => {
        const el = document.getElementById(id);
        if (el) el.addEventListener('change', (e) => {
          app.conditions[id] = e.target.checked;
          render();
        });
      });
      
      // 이동평균선 라디오 버튼
      document.querySelectorAll('input[name="maPeriod"]').forEach(radio => {
        radio.addEventListener('change', (e) => {
          // 모든 MA 비활성화
          app.conditions.ma60Enabled = false;
          app.conditions.ma112Enabled = false;
          app.conditions.ma224Enabled = false;
          
          // 선택된 MA만 활성화
          const period = e.target.value;
          if (period === '60') app.conditions.ma60Enabled = true;
          if (period === '112') app.conditions.ma112Enabled = true;
          if (period === '224') app.conditions.ma224Enabled = true;
          
          render();
        });
      });

      ['ma60Min', 'ma60Max', 'ma112Min', 'ma112Max', 'ma224Min', 'ma224Max', 'volumeMultiple', 'priceChangeMin', 'priceChangeMax', 'perMin', 'perMax', 'pbrMin', 'pbrMax'].forEach(id => {
        const el = document.getElementById(id);
        if (el) el.addEventListener('input', (e) => {
          app.conditions[id] = parseFloat(e.target.value);
        });
      });

      // 시가총액 (억원 단위 변환)
      ['marketCapMin', 'marketCapMax'].forEach(id => {
        const el = document.getElementById(id);
        if (el) el.addEventListener('input', (e) => {
          app.conditions[id] = parseFloat(e.target.value) * 100000000; // 억원 → 원
        });
      });

      // 볼린저 밴드 프리셋 라디오 버튼
      document.querySelectorAll('input[name="bbPreset"]').forEach(radio => {
        radio.addEventListener('change', (e) => {
          const presets = {
            short: { period: 10, multiplier: 1.5 },
            normal: { period: 20, multiplier: 2 },
            long: { period: 30, multiplier: 3 }
          };
          const preset = presets[e.target.value];
          if (preset) {
            app.conditions.bbPeriod = preset.period;
            app.conditions.bbMultiplier = preset.multiplier;
          }
        });
      });

      const bbPos = document.getElementById('bbPosition');
      if (bbPos) bbPos.addEventListener('change', (e) => {
        app.conditions.bbPosition = e.target.value;
      });
    }

    // 초기 렌더링
    render();
    
    // DB 상태 자동 확인 (페이지 로드 시)
    setTimeout(checkDatabaseStatus, 500);
  </script>
</body>
</html>
