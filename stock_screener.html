<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>ì œë¡¬ê³¼ í•¨ê»˜í•˜ëŠ” í–‰ë³µ ì£¼ì‹ ê²€ìƒ‰ê¸°</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0"></script>
  <script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-zoom@2.0.1/dist/chartjs-plugin-zoom.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/hammerjs@2.0.8"></script>
  <style>
    body {
      background: linear-gradient(to bottom right, #0f172a, #1e3a8a, #0f172a);
      min-height: 100vh;
    }
  </style>
</head>
<body class="p-4 md:p-6">
  <div id="app" class="max-w-7xl mx-auto"></div>
  
  <!-- ì§„í–‰ë¥  ëª¨ë‹¬ -->
  <div id="progressModal" class="hidden fixed inset-0 bg-black/50 backdrop-blur-sm flex items-center justify-center z-50">
    <div class="bg-gradient-to-br from-slate-900 to-slate-800 border border-white/20 rounded-2xl p-8 max-w-md w-full mx-4">
      <h3 class="text-2xl font-bold text-white mb-6">ğŸ“Š DB ì´ˆê¸°í™” ì¤‘...</h3>
      
      <div class="mb-4">
        <div class="flex justify-between text-white mb-2">
          <span id="progressText">ì¤€ë¹„ ì¤‘...</span>
          <span id="progressPercent">0%</span>
        </div>
        <div class="w-full bg-slate-700 rounded-full h-4 overflow-hidden">
          <div id="progressBar" class="h-full bg-gradient-to-r from-blue-500 to-purple-500 transition-all duration-300" style="width: 0%"></div>
        </div>
      </div>
      
      <div class="text-sm text-white/70 space-y-2">
        <div class="flex justify-between">
          <span>ì²˜ë¦¬ ì¤‘:</span>
          <span id="progressCount">0 / 0</span>
        </div>
        <div class="flex justify-between">
          <span>í˜„ì¬ ì¢…ëª©:</span>
          <span id="progressStock" class="font-mono">-</span>
        </div>
        <div class="flex justify-between">
          <span>ê²½ê³¼ ì‹œê°„:</span>
          <span id="progressElapsed">0ì´ˆ</span>
        </div>
        <div class="flex justify-between">
          <span>ë‚¨ì€ ì‹œê°„:</span>
          <span id="progressRemaining">ê³„ì‚° ì¤‘...</span>
        </div>
      </div>
      
      <div class="mt-6 text-xs text-white/50 text-center">
        âš ï¸ í•œêµ­íˆ¬ìì¦ê¶Œ API ì œì•½ ì¤€ìˆ˜ ì¤‘ (ì´ˆë‹¹ 15ê±´)
      </div>
    </div>
  </div>

  <!-- ì°¨íŠ¸ íŒì—… ëª¨ë‹¬ -->
  <div id="chartModal" class="hidden fixed inset-0 bg-black/70 backdrop-blur-sm flex items-center justify-center z-50 p-4">
    <div class="bg-gradient-to-br from-slate-900 to-slate-800 border border-white/20 rounded-2xl p-6 max-w-6xl w-full overflow-y-auto" style="max-height: 90vh;">
      <!-- í—¤ë” -->
      <div class="flex justify-between items-start mb-6">
        <div class="flex-1">
          <div class="flex items-center gap-4 mb-2">
            <h3 class="text-2xl font-bold text-white" id="chartStockName">ì¢…ëª©ëª…</h3>
            <div class="text-sm" id="financialInfoBadge">
              <!-- ì¬ë¬´ì •ë³´ í‘œì‹œ ì˜ì—­ (ì¢…ëª©ëª… ì˜†) -->
            </div>
          </div>
          <p class="text-sm text-white/60" id="chartStockCode">000000</p>
        </div>
        <button onclick="closeChart()" class="text-white/60 hover:text-white text-3xl leading-none">&times;</button>
      </div>
      
      <!-- ì°¨íŠ¸ í•„í„° ë° ì¤Œ ì»¨íŠ¸ë¡¤ -->
      <div class="bg-slate-800/50 rounded-xl p-4 mb-4">
        <div class="flex justify-between items-center mb-4">
          <div class="flex flex-wrap gap-3">
            <label class="flex items-center gap-2 text-white text-sm cursor-pointer">
              <input type="checkbox" id="showMA60" checked class="w-4 h-4" onchange="toggleIndicator()">
              <span>60ì¼ì„ </span>
            </label>
            <label class="flex items-center gap-2 text-white text-sm cursor-pointer">
              <input type="checkbox" id="showMA112" checked class="w-4 h-4" onchange="toggleIndicator()">
              <span>112ì¼ì„ </span>
            </label>
            <label class="flex items-center gap-2 text-white text-sm cursor-pointer">
              <input type="checkbox" id="showMA224" checked class="w-4 h-4" onchange="toggleIndicator()">
              <span>224ì¼ì„ </span>
            </label>
            <label class="flex items-center gap-2 text-white text-sm cursor-pointer">
              <input type="checkbox" id="showTrendline" class="w-4 h-4" onchange="toggleIndicator()">
              <span>ì¶”ì„¸ì„ </span>
            </label>
            <label class="flex items-center gap-2 text-white text-sm cursor-pointer">
              <input type="checkbox" id="showSupport" class="w-4 h-4" onchange="toggleIndicator()">
              <span>ì§€ì§€ì„ </span>
            </label>
            <label class="flex items-center gap-2 text-white text-sm cursor-pointer">
              <input type="checkbox" id="showResistance" class="w-4 h-4" onchange="toggleIndicator()">
              <span>ì €í•­ì„ </span>
            </label>
            <label class="flex items-center gap-2 text-white text-sm cursor-pointer">
              <input type="checkbox" id="showIchimoku" class="w-4 h-4" onchange="toggleIndicator()">
              <span>ì¼ëª©ê· í˜•í‘œ (êµ¬ë¦„ëŒ€)</span>
            </label>
          </div>
          
          <!-- ì¤Œ ì»¨íŠ¸ë¡¤ -->
          <div class="flex flex-col gap-2">
            <div class="flex gap-2">
              <button onclick="zoomIn()" class="bg-blue-600 hover:bg-blue-700 text-white px-3 py-1 rounded text-sm font-bold">
                +
              </button>
              <button onclick="zoomOut()" class="bg-blue-600 hover:bg-blue-700 text-white px-3 py-1 rounded text-sm font-bold">
                âˆ’
              </button>
              <button onclick="resetZoom()" class="bg-slate-600 hover:bg-slate-700 text-white px-3 py-1 rounded text-sm">
                ì´ˆê¸°í™”
              </button>
            </div>
            <div class="text-xs text-white/60">
              ğŸ’¡ ì´ë™: Shift + ë“œë˜ê·¸ ë˜ëŠ” íœ  í´ë¦­
            </div>
          </div>
        </div>
        
        <!-- ê°€ê²© ì°¨íŠ¸ -->
        <div style="height: 350px; position: relative;" class="mb-4">
          <canvas id="stockChart"></canvas>
        </div>
        
        <!-- ê±°ë˜ëŸ‰ ì°¨íŠ¸ -->
        <div style="height: 100px; position: relative;">
          <canvas id="volumeChart"></canvas>
        </div>
      </div>
      
      <!-- í†µê³„ ì •ë³´ -->
      <div class="grid grid-cols-2 md:grid-cols-4 gap-4 text-sm mb-4">
        <div class="bg-slate-800/50 rounded-lg p-3">
          <div class="text-white/60 text-xs mb-1">í˜„ì¬ê°€</div>
          <div class="text-white font-bold text-lg" id="chartPrice">-</div>
        </div>
        <div class="bg-slate-800/50 rounded-lg p-3">
          <div class="text-white/60 text-xs mb-1">60ì¼ì„ </div>
          <div class="text-blue-400 font-bold" id="chartMa60">-</div>
        </div>
        <div class="bg-slate-800/50 rounded-lg p-3">
          <div class="text-white/60 text-xs mb-1">112ì¼ì„ </div>
          <div class="text-purple-400 font-bold" id="chartMa112">-</div>
        </div>
        <div class="bg-slate-800/50 rounded-lg p-3">
          <div class="text-white/60 text-xs mb-1">224ì¼ì„ </div>
          <div class="text-red-400 font-bold" id="chartMa224">-</div>
        </div>
      </div>
    </div>
  </div>

  <script>
    // ê°„ë‹¨í•œ ì•”í˜¸í™”/ë³µí˜¸í™” (ë¸Œë¼ìš°ì € ê³ ìœ  ì •ë³´ ê¸°ë°˜)
    function getEncryptionKey() {
      // ë¸Œë¼ìš°ì € ê³ ìœ  ì •ë³´ë¡œ í‚¤ ìƒì„± (userAgent + ê³ ì • salt)
      const salt = 'StockHunter2025_KIS_API_KEY_PROTECTION';
      const raw = navigator.userAgent + salt + screen.width + screen.height;
      let hash = 0;
      for (let i = 0; i < raw.length; i++) {
        const char = raw.charCodeAt(i);
        hash = ((hash << 5) - hash) + char;
        hash = hash & hash;
      }
      return Math.abs(hash).toString(36);
    }
    
    // XOR ì•”í˜¸í™”
    function encrypt(text) {
      if (!text) return '';
      const key = getEncryptionKey();
      let result = '';
      for (let i = 0; i < text.length; i++) {
        result += String.fromCharCode(text.charCodeAt(i) ^ key.charCodeAt(i % key.length));
      }
      return btoa(result); // Base64 ì¸ì½”ë”©
    }
    
    // XOR ë³µí˜¸í™”
    function decrypt(encoded) {
      if (!encoded) return '';
      try {
        const text = atob(encoded); // Base64 ë””ì½”ë”©
        const key = getEncryptionKey();
        let result = '';
        for (let i = 0; i < text.length; i++) {
          result += String.fromCharCode(text.charCodeAt(i) ^ key.charCodeAt(i % key.length));
        }
        return result;
      } catch (e) {
        console.error('Decryption failed:', e);
        return '';
      }
    }
    
    // LocalStorageì—ì„œ API í‚¤ ë¡œë“œ (ì•”í˜¸í™”ëœ ê°’ ë³µí˜¸í™”)
    function loadApiKeys() {
      const encryptedKey = localStorage.getItem('kis_app_key_enc');
      const encryptedSecret = localStorage.getItem('kis_app_secret_enc');
      const isProd = localStorage.getItem('kis_is_production');
      
      console.log('[DEBUG] Loading API keys from localStorage');
      console.log('[DEBUG] Encrypted key exists:', !!encryptedKey);
      console.log('[DEBUG] Encrypted secret exists:', !!encryptedSecret);
      console.log('[DEBUG] isProduction:', isProd);
      
      const decryptedKey = encryptedKey ? decrypt(encryptedKey) : '';
      const decryptedSecret = encryptedSecret ? decrypt(encryptedSecret) : '';
      
      console.log('[DEBUG] Decrypted key length:', decryptedKey.length);
      console.log('[DEBUG] Decrypted secret length:', decryptedSecret.length);
      
      return {
        appKey: decryptedKey,
        appSecret: decryptedSecret,
        isProduction: isProd ? isProd === 'true' : true // ê¸°ë³¸ê°’ true
      };
    }
    
    // LocalStorageì— API í‚¤ ì €ì¥ (ì•”í˜¸í™”)
    function saveApiKeys(appKey, appSecret, isProduction) {
      console.log('[DEBUG] Saving API keys to localStorage');
      console.log('[DEBUG] Key length:', appKey?.length || 0);
      console.log('[DEBUG] Secret length:', appSecret?.length || 0);
      console.log('[DEBUG] isProduction:', isProduction);
      
      if (appKey) {
        const encrypted = encrypt(appKey);
        localStorage.setItem('kis_app_key_enc', encrypted);
        console.log('[DEBUG] Encrypted key saved:', encrypted.substring(0, 20) + '...');
      }
      if (appSecret) {
        const encrypted = encrypt(appSecret);
        localStorage.setItem('kis_app_secret_enc', encrypted);
        console.log('[DEBUG] Encrypted secret saved:', encrypted.substring(0, 20) + '...');
      }
      localStorage.setItem('kis_is_production', isProduction.toString());
      console.log('[DEBUG] Save completed');
    }
    
    // API í‚¤ ìˆ˜ë™ ì €ì¥
    function saveApiKeysManual() {
      const appKey = document.getElementById('appKey').value.trim();
      const appSecret = document.getElementById('appSecret').value.trim();
      const isProduction = document.getElementById('isProduction')?.checked ?? true;
      
      if (!appKey || !appSecret) {
        alert('âŒ APP KEYì™€ APP SECRETì„ ì…ë ¥í•´ì£¼ì„¸ìš”!');
        return;
      }
      
      saveApiKeys(appKey, appSecret, isProduction);
      app.appKey = appKey;
      app.appSecret = appSecret;
      app.isProduction = isProduction;
      
      render();
      alert('âœ… API í‚¤ê°€ ì•”í˜¸í™”ë˜ì–´ ì•ˆì „í•˜ê²Œ ì €ì¥ë˜ì—ˆìŠµë‹ˆë‹¤!\n\nğŸ” XOR ì•”í˜¸í™” + Base64 ì¸ì½”ë”©\n\në‹¤ìŒ ë°©ë¬¸ ì‹œ ìë™ìœ¼ë¡œ ë¶ˆëŸ¬ì˜µë‹ˆë‹¤.');
    }
    
    // API í‚¤ ì €ì¥ ìƒíƒœ ë””ë²„ê·¸
    function debugApiKeys() {
      const encKey = localStorage.getItem('kis_app_key_enc');
      const encSecret = localStorage.getItem('kis_app_secret_enc');
      const isProd = localStorage.getItem('kis_is_production');
      
      let msg = 'ğŸ” ì €ì¥ ìƒíƒœ í™•ì¸\n\n';
      msg += 'â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”\n';
      msg += `ì•”í˜¸í™”ëœ KEY: ${encKey ? 'âœ… ì €ì¥ë¨ (' + encKey.length + 'ì)' : 'âŒ ì—†ìŒ'}\n`;
      msg += `ì•”í˜¸í™”ëœ SECRET: ${encSecret ? 'âœ… ì €ì¥ë¨ (' + encSecret.length + 'ì)' : 'âŒ ì—†ìŒ'}\n`;
      msg += `ì‹¤ì „íˆ¬ì ì„¤ì •: ${isProd || 'ì—†ìŒ'}\n`;
      msg += 'â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”\n\n';
      
      if (encKey && encSecret) {
        const decKey = decrypt(encKey);
        const decSecret = decrypt(encSecret);
        msg += `ë³µí˜¸í™”ëœ KEY ê¸¸ì´: ${decKey.length}ì\n`;
        msg += `ë³µí˜¸í™”ëœ SECRET ê¸¸ì´: ${decSecret.length}ì\n`;
        msg += 'â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”\n\n';
        
        if (decKey.length > 0 && decSecret.length > 0) {
          msg += 'âœ… ì •ìƒ: ì €ì¥ ë° ë³µí˜¸í™” ì„±ê³µ!\n';
          msg += '\ní˜„ì¬ ë©”ëª¨ë¦¬:\n';
          msg += `app.appKey: ${app.appKey?.length || 0}ì\n`;
          msg += `app.appSecret: ${app.appSecret?.length || 0}ì\n`;
        } else {
          msg += 'âš ï¸ ê²½ê³ : ë³µí˜¸í™” ì‹¤íŒ¨!\n';
          msg += 'ë¸Œë¼ìš°ì € ì •ë³´ê°€ ë³€ê²½ë˜ì—ˆì„ ìˆ˜ ìˆìŠµë‹ˆë‹¤.\n';
          msg += 'â†’ [ğŸ—‘ï¸ ì €ì¥ëœ í‚¤ ì‚­ì œ] í›„ ì¬ì €ì¥í•˜ì„¸ìš”.';
        }
      } else {
        msg += 'âŒ ì €ì¥ëœ API í‚¤ê°€ ì—†ìŠµë‹ˆë‹¤.\n';
        msg += '\ní•´ê²° ë°©ë²•:\n';
        msg += '1. API KEYì™€ SECRET ì…ë ¥\n';
        msg += '2. [ğŸ’¾ API í‚¤ ì €ì¥] í´ë¦­\n';
        msg += '3. "âœ… ì•”í˜¸í™”ë˜ì–´ ì €ì¥" ë©”ì‹œì§€ í™•ì¸';
      }
      
      alert(msg);
      console.log('[DEBUG] Full localStorage:', localStorage);
    }
    
    // API í‚¤ ì‚­ì œ
    function clearApiKeys() {
      if (confirm('âš ï¸ ì €ì¥ëœ API í‚¤ë¥¼ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?')) {
        // ì•”í˜¸í™”ëœ í‚¤ ì‚­ì œ
        localStorage.removeItem('kis_app_key_enc');
        localStorage.removeItem('kis_app_secret_enc');
        localStorage.removeItem('kis_is_production');
        // ë ˆê±°ì‹œ í‚¤ë„ ì‚­ì œ (ì´ì „ ë²„ì „ í˜¸í™˜ì„±)
        localStorage.removeItem('kis_app_key');
        localStorage.removeItem('kis_app_secret');
        
        app.appKey = '';
        app.appSecret = '';
        app.isProduction = true;
        render();
        alert('âœ… API í‚¤ê°€ ì‚­ì œë˜ì—ˆìŠµë‹ˆë‹¤.');
      }
    }
    
    const app = {
      selectedMarket: 'domestic',  // domestic or us
      isProduction: true,   // ê¸°ë³¸ê°’, ë‚˜ì¤‘ì— ë¡œë“œë¨
      appKey: '',  // ë‚˜ì¤‘ì— ë¡œë“œë¨
      appSecret: '',  // ë‚˜ì¤‘ì— ë¡œë“œë¨
      searchDomestic: true,   // êµ­ë‚´ì£¼ì‹ ê²€ìƒ‰ ì—¬ë¶€
      searchUS: false,        // í•´ì™¸ì£¼ì‹ ê²€ìƒ‰ ì—¬ë¶€
      conditions: {
        market: 'domestic',
        exchangeCode: 'KRX',  // KRX(êµ­ë‚´), NAS(ë‚˜ìŠ¤ë‹¥), NYS(ë‰´ìš•)
        excludeManagement: true,  // A: ê´€ë¦¬ì¢…ëª© ì œì™¸ (ì „ëµì‹ í•„ìˆ˜)
        ma20Enabled: true,  // J: 20ì¼ì„  105% ì´í•˜ (ì „ëµì‹ J or K) âœ… ê¸°ë³¸ ì²´í¬
        ma20Min: 0,
        ma20Max: 105,
        ma60Enabled: false,
        ma60Min: 95,
        ma60Max: 105,
        ma112Enabled: true,  // E: 112ì¼ì„  95~105% (ì „ëµì‹ E or F) âœ… ê¸°ë³¸ ì²´í¬
        ma112Min: 95,
        ma112Max: 105,
        ma224Enabled: true,  // F: 224ì¼ì„  95~105% (ì „ëµì‹ E or F) âœ… ê¸°ë³¸ ì²´í¬
        ma224Min: 95,
        ma224Max: 105,
        highLowRangeEnabled: true,  // G/H: ê³ ê°€/ì €ê°€ ë“±ë½ë¥  (ì „ëµì‹ í•„ìˆ˜) âœ… ê¸°ë³¸ ì²´í¬
        highLowRangeMin: 12,
        highLowRangeMax: 30,
        highLowRangePeriod: 30,
        excludeETF: true,  // C: ETF ì œì™¸ (ì „ëµì‹ í•„ìˆ˜)
        excludeETN: true,  // C: ETN ì œì™¸ (ì „ëµì‹ í•„ìˆ˜)
        volumeEnabled: false,  // ê±°ë˜ëŸ‰ì€ ì „ëµì‹ì— ì—†ìŒ
        volumeMultiple: 1.5,
        maAlignment: true,  // D+I: ì´í‰ì„  ì •ë°°ì—´ (ì „ëµì‹ í•„ìˆ˜)
        ichimokuEnabled: true,  // N: ì¼ëª©ê· í˜•í‘œ êµ¬ë¦„ëŒ€ ìœ„ (ì „ëµì‹ í•„ìˆ˜) âœ… ê¸°ë³¸ ì²´í¬
        ichimokuTenkan: 9,
        ichimokuKijun: 26,
        ichimokuSenkou: 52,
        bbEnabled: true,  // K+L+M: ë³¼ë¦°ì €ë°´ë“œ (ì „ëµì‹ í•„ìˆ˜)
        bbPeriod: 40,  // L+M: BB[40,2] (ì „ëµì‹ í•„ìˆ˜)
        bbMultiplier: 2,
        bbPosition: 'upper',  // L: ìƒí•œì„  ê·¼ì ‘ (ì „ëµì‹ í•„ìˆ˜)
        bbUpperBreak: true,  // M: ìƒí•œì„  ëŒíŒŒ (ì „ëµì‹ í•„ìˆ˜)
        bbLowerBreak: false,
        priceChangeEnabled: false,  // ì „ëµì‹ì— ì—†ìŒ
        priceChangeMin: -100,
        priceChangeMax: 100,
        marketCapEnabled: true,  // O: ì‹œê°€ì´ì•¡ 1000ì–µ ì´ìƒ (ì „ëµì‹ í•„ìˆ˜)
        marketCapMin: 100000000000,  // 1000ì–µ
        marketCapMax: 10000000000000,
        perEnabled: true,  // Q: PER 30ë°° ì´í•˜ (ì „ëµì‹ í•„ìˆ˜)
        perMin: 0,
        perMax: 30,
        pbrEnabled: false,  // ì „ëµì‹ì— ì—†ìŒ
        pbrMin: 0,
        pbrMax: 3,
      },
      appKey: '',
      appSecret: '',
      accessToken: '',
      results: [],
      loading: false,
      error: '',
      hasSearched: false  // ê²€ìƒ‰ ì‹¤í–‰ ì—¬ë¶€
    };

    // FastAPI ë°±ì—”ë“œ URL (ê°™ì€ ì„œë²„ ì‚¬ìš©)
    const API_BASE_URL = window.location.origin;
    
    let progressCheckInterval = null;

    // ì§„í–‰ë¥  ëª¨ë‹¬ í‘œì‹œ/ìˆ¨ê¹€
    function showProgressModal() {
      document.getElementById('progressModal').classList.remove('hidden');
      startProgressCheck();
    }
    
    function hideProgressModal() {
      document.getElementById('progressModal').classList.add('hidden');
      stopProgressCheck();
    }
    
    // ì§„í–‰ë¥  í´ë§ ì‹œì‘
    function startProgressCheck() {
      progressCheckInterval = setInterval(updateProgress, 1000); // 1ì´ˆë§ˆë‹¤
      updateProgress(); // ì¦‰ì‹œ í•œ ë²ˆ ì‹¤í–‰
    }
    
    // ì§„í–‰ë¥  í´ë§ ì¤‘ì§€
    function stopProgressCheck() {
      if (progressCheckInterval) {
        clearInterval(progressCheckInterval);
        progressCheckInterval = null;
      }
    }
    
    // ì§„í–‰ë¥  ì—…ë°ì´íŠ¸
    async function updateProgress() {
      try {
        const response = await fetch('http://localhost:8080/api/v1/database/progress');
        const progress = await response.json();
        
        document.getElementById('progressPercent').textContent = progress.percentage + '%';
        document.getElementById('progressBar').style.width = progress.percentage + '%';
        document.getElementById('progressCount').textContent = 
          `${progress.currentCount} / ${progress.totalCount}`;
        document.getElementById('progressStock').textContent = 
          progress.currentStock || '-';
        document.getElementById('progressElapsed').textContent = 
          formatSeconds(progress.elapsedSeconds);
        document.getElementById('progressRemaining').textContent = 
          progress.remainingSeconds > 0 ? formatSeconds(progress.remainingSeconds) : 'ê³„ì‚° ì¤‘...';
        
        if (progress.percentage > 0) {
          document.getElementById('progressText').textContent = 'ì´ˆê¸°í™” ì¤‘...';
        }
        
        // ì™„ë£Œ ì‹œ ëª¨ë‹¬ ë‹«ê¸° ë° DB ìƒíƒœ ê°±ì‹ 
        if (!progress.isRunning && progress.currentCount > 0) {
          setTimeout(() => {
            hideProgressModal();
            // DB ìƒíƒœ ìë™ ê°±ì‹ 
            checkDatabaseStatus();
            alert('âœ… DB ì´ˆê¸°í™” ì™„ë£Œ!\nì´ì œ ìŠ¤í¬ë¦¬ë‹ì„ ì‹¤í–‰í•˜ì„¸ìš”.');
          }, 1000);
        }
      } catch (err) {
        console.error('ì§„í–‰ë¥  ì¡°íšŒ ì‹¤íŒ¨:', err);
      }
    }
    
    // ì´ˆ â†’ "ë¶„ ì´ˆ" í˜•ì‹ ë³€í™˜
    function formatSeconds(seconds) {
      const min = Math.floor(seconds / 60);
      const sec = seconds % 60;
      return min > 0 ? `${min}ë¶„ ${sec}ì´ˆ` : `${sec}ì´ˆ`;
    }
    
    // ì§„í–‰ë¥  í´ë§ ì‹œì‘
    function startProgressPolling() {
      if (progressCheckInterval) {
        clearInterval(progressCheckInterval);
      }
      progressCheckInterval = setInterval(updateProgress, 1000);
      updateProgress(); // ì¦‰ì‹œ í•œ ë²ˆ ì‹¤í–‰
    }
    
    // DB ìƒíƒœ í™•ì¸ ë° ë²„íŠ¼ í‘œì‹œ
    async function checkDatabaseStatus() {
      try {
        const response = await fetch('http://localhost:8080/api/v1/database/status');
        const status = await response.json();
        
        const initBtn = document.getElementById('dbInitBtn');
        const rebuildBtn = document.getElementById('dbRebuildBtn');
        const updateBtn = document.getElementById('dbUpdateBtn');
        const statusText = document.getElementById('dbStatusText');
        
        if (!status.initialized || status.totalStocks === 0) {
          // DB ì—†ìŒ â†’ ì´ˆê¸°í™” ë²„íŠ¼ë§Œ í‘œì‹œ
          initBtn.classList.remove('hidden');
          rebuildBtn.classList.add('hidden');
          updateBtn.classList.add('hidden');
          statusText.innerHTML = 'âŒ DB ë¯¸êµ¬ì¶• (ì´ˆê¸°í™” í•„ìš”)';
        } else {
          // DB ìˆìŒ â†’ ì¬êµ¬ì¶• + ì—…ë°ì´íŠ¸ ë²„íŠ¼ í‘œì‹œ
          initBtn.classList.add('hidden');
          rebuildBtn.classList.remove('hidden');
          updateBtn.classList.remove('hidden');
          
          // ìµœì‹  ì˜ì—…ì¼ í™•ì¸ (í† ìš”ì¼, ì¼ìš”ì¼ ì œì™¸)
          const now = new Date();
          const dayOfWeek = now.getDay(); // 0=ì¼ìš”ì¼, 6=í† ìš”ì¼
          
          // ê°€ì¥ ìµœê·¼ ì˜ì—…ì¼ ê³„ì‚°
          let daysToSubtract = 1; // ê¸°ë³¸: ì–´ì œ(ì¥ ë§ˆê° í›„ ê¸°ì¤€)
          if (dayOfWeek === 0) {
            // ì¼ìš”ì¼ â†’ ê¸ˆìš”ì¼ê¹Œì§€ê°€ ìµœì‹  (2ì¼ ì „)
            daysToSubtract = 2;
          } else if (dayOfWeek === 6) {
            // í† ìš”ì¼ â†’ ê¸ˆìš”ì¼ê¹Œì§€ê°€ ìµœì‹  (1ì¼ ì „)
            daysToSubtract = 1;
          } else if (dayOfWeek === 1) {
            // ì›”ìš”ì¼ â†’ ê¸ˆìš”ì¼ê¹Œì§€ê°€ ìµœì‹  (3ì¼ ì „)
            daysToSubtract = 3;
          }
          // í™”~ê¸ˆì€ ì „ì¼(1ì¼ ì „)ì´ ìµœì‹ 
          
          const lastBusinessDay = new Date(now);
          lastBusinessDay.setDate(now.getDate() - daysToSubtract);
          const expectedDate = lastBusinessDay.toISOString().split('T')[0];
          
          const isUpToDate = status.newestDate >= expectedDate;
          
          if (isUpToDate) {
            // ìµœì‹  ìƒíƒœ
            updateBtn.disabled = true;
            updateBtn.classList.remove('bg-green-600', 'hover:bg-green-700');
            updateBtn.classList.add('bg-gray-600', 'cursor-not-allowed', 'opacity-50');
            statusText.innerHTML = `âœ… ìµœì‹  ì •ë³´ì…ë‹ˆë‹¤ (${status.totalStocks}ê°œ ì¢…ëª©, ${status.totalRecords.toLocaleString()}ê±´, ${status.newestDate})`;
          } else {
            // ì—…ë°ì´íŠ¸ í•„ìš”
            updateBtn.disabled = false;
            updateBtn.classList.add('bg-green-600', 'hover:bg-green-700');
            updateBtn.classList.remove('bg-gray-600', 'cursor-not-allowed', 'opacity-50');
            statusText.innerHTML = `âš ï¸ ì—…ë°ì´íŠ¸ í•„ìš” (${status.totalStocks}ê°œ ì¢…ëª©, ìµœì¢…: ${status.newestDate})`;
          }
        }
      } catch (err) {
        console.error('DB ìƒíƒœ í™•ì¸ ì‹¤íŒ¨:', err);
        document.getElementById('dbStatusText').innerHTML = 'âš ï¸ ìƒíƒœ í™•ì¸ ì‹¤íŒ¨';
      }
    }
    
    // DB ì´ˆê¸°í™”
    async function initializeDatabase() {
      if (!app.appKey || !app.appSecret) {
        alert('âŒ API KEYì™€ SECRETì„ ë¨¼ì € ì…ë ¥í•´ì£¼ì„¸ìš”!');
        return;
      }
      
      if (!confirm('DB ì´ˆê¸°í™”ë¥¼ ì‹œì‘í•©ë‹ˆë‹¤.\nì•½ 2ë¶„ ì†Œìš”ë©ë‹ˆë‹¤. ê³„ì†í•˜ì‹œê² ìŠµë‹ˆê¹Œ?')) {
        return;
      }
      
      try {
        showProgressModal();
        
        const response = await fetch('http://localhost:8080/api/v1/database/initialize', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({
            appKey: app.appKey,
            appSecret: app.appSecret,
            isProduction: app.isProduction
          })
        });
        
        const result = await response.json();
        
        if (response.status === 409) {
          // ì´ë¯¸ ì´ˆê¸°í™”ë¨
          alert('â„¹ï¸ ' + result.message + '\n\n' + result.error);
          hideProgressModal();
          checkDatabaseStatus();
        } else if (response.ok) {
          // ì§„í–‰ë¥  ì²´í¬ ì‹œì‘
          startProgressPolling();
        } else {
          throw new Error(result.error || 'DB ì´ˆê¸°í™” ì‹¤íŒ¨');
        }
      } catch (err) {
        alert('âŒ ì˜¤ë¥˜: ' + err.message);
        hideProgressModal();
      }
    }
    
    // DB ì¬êµ¬ì¶• (ê°•ì œ)
    async function rebuildDatabase() {
      if (!app.appKey || !app.appSecret) {
        alert('âŒ API KEYì™€ SECRETì„ ë¨¼ì € ì…ë ¥í•´ì£¼ì„¸ìš”!');
        return;
      }
      
      if (!confirm('âš ï¸ DBë¥¼ ì™„ì „íˆ ì¬êµ¬ì¶•í•©ë‹ˆë‹¤.\n\nê¸°ì¡´ ë°ì´í„°ê°€ ì‚­ì œë˜ê³  ì²˜ìŒë¶€í„° ë‹¤ì‹œ ìˆ˜ì§‘í•©ë‹ˆë‹¤.\nì•½ 2~3ë¶„ ì†Œìš”ë©ë‹ˆë‹¤.\n\nê³„ì†í•˜ì‹œê² ìŠµë‹ˆê¹Œ?')) {
        return;
      }
      
      try {
        showProgressModal();
        
        const response = await fetch('http://localhost:8080/api/v1/database/initialize', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({
            appKey: app.appKey,
            appSecret: app.appSecret,
            isProduction: app.isProduction,
            forceRebuild: true  // ê°•ì œ ì¬êµ¬ì¶•!
          })
        });
        
        const result = await response.json();
        
        if (!response.ok) {
          throw new Error(result.error || 'ì¬êµ¬ì¶• ì‹¤íŒ¨');
        }
        
        // ì§„í–‰ë¥  ì²´í¬ ì‹œì‘
        startProgressPolling();
        
      } catch (err) {
        alert('âŒ ì¬êµ¬ì¶• ì‹¤íŒ¨: ' + err.message);
        hideProgressModal();
      }
    }
    
    // DB ì—…ë°ì´íŠ¸
    async function updateDatabase() {
      if (!app.appKey || !app.appSecret) {
        alert('âŒ API KEYì™€ SECRETì„ ë¨¼ì € ì…ë ¥í•´ì£¼ì„¸ìš”!');
        return;
      }
      
      if (!confirm('DB ì—…ë°ì´íŠ¸ë¥¼ ì‹œì‘í•©ë‹ˆë‹¤.\nì•½ 30ì´ˆ ì†Œìš”ë©ë‹ˆë‹¤. ê³„ì†í•˜ì‹œê² ìŠµë‹ˆê¹Œ?')) {
        return;
      }
      
      try {
        showProgressModal();
        
        const response = await fetch('http://localhost:8080/api/v1/database/update', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({
            appKey: app.appKey,
            appSecret: app.appSecret,
            isProduction: app.isProduction
          })
        });
        
        const result = await response.json();
        
        // ì§„í–‰ë¥  ì²´í¬ ì‹œì‘
        startProgressPolling();
        
      } catch (err) {
        alert('âŒ ì—…ë°ì´íŠ¸ ì‹¤íŒ¨: ' + err.message);
        hideProgressModal();
      }
    }
    
    // í™œì„±í™”ëœ ì´ë™í‰ê·  ê¸°ê°„ ê°€ì ¸ì˜¤ê¸°
    function getActiveMAPeriod() {
      if (app.conditions.ma224Enabled) return 224;
      if (app.conditions.ma112Enabled) return 112;
      if (app.conditions.ma60Enabled) return 60;
      return null;
    }
    
    // ì´ë™í‰ê·  ê°’ ê°€ì ¸ì˜¤ê¸°
    function getMAValue(stock, period) {
      const value = stock[`ma${period}`];
      return value !== undefined && value !== null ? parseFloat(value).toLocaleString() : 'N/A';
    }
    
    // ì´ë™í‰ê·  ë¹„ìœ¨ ê°€ì ¸ì˜¤ê¸°
    function getMARatio(stock, period) {
      const ratio = stock[`ma${period}Ratio`];
      return ratio !== undefined && ratio !== null ? ratio : 'N/A';
    }
    
    // ì°¨íŠ¸ ê´€ë ¨ ë³€ìˆ˜
    let priceChartInstance = null;
    let volumeChartInstance = null;
    let chartData = null;
    let chartStockName = null;
    
    // ì°¨íŠ¸ í‘œì‹œ
    async function showChart(stockCode, stockName) {
      const modal = document.getElementById('chartModal');
      modal.classList.remove('hidden');
      
      // í—¤ë” ì •ë³´ ì„¤ì •
      document.getElementById('chartStockName').textContent = stockName;
      document.getElementById('chartStockCode').textContent = stockCode;
      
      try {
        // 280ì¼ ê°€ê²© ë°ì´í„° ê°€ì ¸ì˜¤ê¸°
        const response = await fetch(`http://localhost:8080/api/v1/stocks/${stockCode}/prices?days=280`);
        if (!response.ok) throw new Error('ë°ì´í„° ë¡œë“œ ì‹¤íŒ¨');
        
        const data = await response.json();
        
        // ë°ì´í„° ì €ì¥ (í† ê¸€ìš©)
        chartData = data;
        chartStockName = stockName;
        
        // ì°¨íŠ¸ ê·¸ë¦¬ê¸°
        drawCharts(data, stockName);
        
        // í†µê³„ ì •ë³´ ì—…ë°ì´íŠ¸
        updateChartStats(data);
        
        // ì¬ë¬´ ì •ë³´ ê°€ì ¸ì˜¤ê¸° (P, R ì¡°ê±´)
        fetchFinancialData(stockCode);
        
      } catch (err) {
        alert('âŒ ì°¨íŠ¸ ë°ì´í„°ë¥¼ ë¶ˆëŸ¬ì˜¬ ìˆ˜ ì—†ìŠµë‹ˆë‹¤: ' + err.message);
        closeChart();
      }
    }
    
    // ì¬ë¬´ ì •ë³´ ê°€ì ¸ì˜¤ê¸° (P: ë¶€ì±„ë¹„ìœ¨, R: ìœ ë³´ìœ¨)
    async function fetchFinancialData(stockCode) {
      const financialDiv = document.getElementById('financialInfoBadge');
      financialDiv.innerHTML = '<span class="text-white/50 text-xs">ğŸ“Š ë¡œë”©...</span>';
      
      try {
        const response = await fetch(`http://localhost:8080/api/v1/stocks/${stockCode}/financial?appKey=${app.appKey}&appSecret=${app.appSecret}&isProduction=${app.isProduction}`);
        if (!response.ok) throw new Error('ì¬ë¬´ ë°ì´í„° ë¡œë“œ ì‹¤íŒ¨');
        
        const data = await response.json();
        
        // P, R ì¡°ê±´ ì²´í¬ (snake_caseë¡œ ì ‘ê·¼)
        const debtRatio = data.debt_ratio ? parseFloat(data.debt_ratio) : null;
        const rsrvRate = data.rsrv_rate ? parseFloat(data.rsrv_rate) : null;
        const pCheck = debtRatio !== null ? (debtRatio <= 200 ? 'âœ…' : 'âŒ') : '?';
        const rCheck = rsrvRate !== null ? (rsrvRate >= 300 ? 'âœ…' : 'âŒ') : '?';
        
        // EPS/BPS ì •ë³´ (ì°¸ê³ ìš©)
        const eps = data.eps ? parseFloat(data.eps) : null;
        const bps = data.bps ? parseFloat(data.bps) : null;
        
        // ì¢…ëª©ëª… ì˜†ì— ê°„ë‹¨í•˜ê²Œ í‘œì‹œ
        financialDiv.innerHTML = `
          <div class="flex items-center gap-3">
            <div class="bg-slate-700/50 px-3 py-1 rounded-md">
              <span class="text-white/60 text-xs">P: ë¶€ì±„ë¹„ìœ¨</span>
              <span class="ml-2 font-mono text-sm ${pCheck === 'âœ…' ? 'text-green-400' : pCheck === 'âŒ' ? 'text-red-400' : 'text-gray-400'}">
                ${debtRatio !== null ? debtRatio.toFixed(1) + '%' : 'N/A'} ${pCheck}
              </span>
            </div>
            <div class="bg-slate-700/50 px-3 py-1 rounded-md">
              <span class="text-white/60 text-xs">R: ìœ ë³´ìœ¨</span>
              <span class="ml-2 font-mono text-sm ${rCheck === 'âœ…' ? 'text-green-400' : rCheck === 'âŒ' ? 'text-red-400' : 'text-gray-400'}">
                ${rsrvRate !== null ? rsrvRate.toFixed(1) + '%' : 'N/A'} ${rCheck}
              </span>
            </div>
            ${eps !== null || bps !== null ? `
            <div class="bg-slate-700/50 px-3 py-1 rounded-md text-xs text-white/60">
              ${eps !== null ? `EPS: ${eps.toFixed(0)}` : ''} ${bps !== null ? `BPS: ${bps.toFixed(0)}` : ''}
            </div>
            ` : ''}
          </div>
        `;
        
      } catch (err) {
        console.error('ì¬ë¬´ ë°ì´í„° ë¡œë“œ ì‹¤íŒ¨:', err);
        financialDiv.innerHTML = '<span class="text-red-400 text-xs">âŒ ì¬ë¬´ì •ë³´ ì—†ìŒ</span>';
      }
    }
    
    // ì§€í‘œ í† ê¸€
    function toggleIndicator() {
      if (!chartData) return;
      drawCharts(chartData, chartStockName);
    }
    
    // ì¤Œ ì¸
    function zoomIn() {
      if (priceChartInstance) {
        // ì˜¤ë¥¸ìª½ ë(ìµœì‹  ë°ì´í„°)ì„ ê¸°ì¤€ìœ¼ë¡œ í™•ëŒ€
        priceChartInstance.zoom({
          x: 1.2,
          focalPoint: { x: priceChartInstance.chartArea.right }
        });
      }
      if (volumeChartInstance) {
        volumeChartInstance.zoom({
          x: 1.2,
          focalPoint: { x: volumeChartInstance.chartArea.right }
        });
      }
    }
    
    // ì¤Œ ì•„ì›ƒ
    function zoomOut() {
      if (priceChartInstance) {
        // ì˜¤ë¥¸ìª½ ë(ìµœì‹  ë°ì´í„°)ì„ ê¸°ì¤€ìœ¼ë¡œ ì¶•ì†Œ
        priceChartInstance.zoom({
          x: 0.8,
          focalPoint: { x: priceChartInstance.chartArea.right }
        });
      }
      if (volumeChartInstance) {
        volumeChartInstance.zoom({
          x: 0.8,
          focalPoint: { x: volumeChartInstance.chartArea.right }
        });
      }
    }
    
    // ì¤Œ ì´ˆê¸°í™”
    function resetZoom() {
      if (priceChartInstance) {
        priceChartInstance.resetZoom();
      }
      if (volumeChartInstance) {
        volumeChartInstance.resetZoom();
      }
    }
    
    // ì°¨íŠ¸ ë‹«ê¸°
    function closeChart() {
      const modal = document.getElementById('chartModal');
      modal.classList.add('hidden');
      
      // ê¸°ì¡´ ì°¨íŠ¸ íŒŒê´´
      if (priceChartInstance) {
        priceChartInstance.destroy();
        priceChartInstance = null;
      }
      if (volumeChartInstance) {
        volumeChartInstance.destroy();
        volumeChartInstance = null;
      }
    }
    
    // Shift í‚¤ ìƒíƒœ ì¶”ì 
    let isShiftPressed = false;
    document.addEventListener('keydown', (e) => {
      if (e.key === 'Shift') isShiftPressed = true;
    });
    document.addEventListener('keyup', (e) => {
      if (e.key === 'Shift') isShiftPressed = false;
    });
    
    // ì°¨íŠ¸ ê·¸ë¦¬ê¸° (ê°€ê²© + ê±°ë˜ëŸ‰)
    function drawCharts(data, stockName) {
      // ê¸°ì¡´ ì°¨íŠ¸ íŒŒê´´
      if (priceChartInstance) {
        priceChartInstance.destroy();
      }
      if (volumeChartInstance) {
        volumeChartInstance.destroy();
      }
      
      const priceCtx = document.getElementById('stockChart').getContext('2d');
      const volumeCtx = document.getElementById('volumeChart').getContext('2d');
      
      // ë°ì´í„° ì •ë ¬ (ì˜¤ë˜ëœ ê²ƒë¶€í„°)
      const sortedData = [...data].reverse();
      
      // ë‚ ì§œì™€ ê°€ê²© ì¶”ì¶œ
      const labels = sortedData.map(d => d.date);
      const prices = sortedData.map(d => d.close);
      const highs = sortedData.map(d => d.high);
      const lows = sortedData.map(d => d.low);
      const volumes = sortedData.map(d => d.volume);
      
      // ì¼ëª©ê· í˜•í‘œë¥¼ ìœ„í•œ ë¯¸ë˜ 26ì¼ ì¶”ê°€
      const lastDate = new Date(labels[labels.length - 1]);
      for (let i = 1; i <= 26; i++) {
        const futureDate = new Date(lastDate);
        futureDate.setDate(lastDate.getDate() + i);
        // ì£¼ë§ ê±´ë„ˆë›°ê¸°
        while (futureDate.getDay() === 0 || futureDate.getDay() === 6) {
          futureDate.setDate(futureDate.getDate() + 1);
        }
        labels.push(futureDate.toISOString().split('T')[0]);
        prices.push(null); // ë¯¸ë˜ ê°€ê²©ì€ null
        highs.push(null);
        lows.push(null);
        volumes.push(0); // ë¯¸ë˜ ê±°ë˜ëŸ‰ì€ 0
      }
      
      // ì²´í¬ë°•ìŠ¤ ìƒíƒœ
      const showMA60 = document.getElementById('showMA60').checked;
      const showMA112 = document.getElementById('showMA112').checked;
      const showMA224 = document.getElementById('showMA224').checked;
      const showTrendline = document.getElementById('showTrendline').checked;
      const showSupport = document.getElementById('showSupport').checked;
      const showResistance = document.getElementById('showResistance').checked;
      const showIchimoku = document.getElementById('showIchimoku').checked;
      
      // ì´ë™í‰ê·  ê³„ì‚°
      const ma60 = calculateMA(prices, 60);
      const ma112 = calculateMA(prices, 112);
      const ma224 = calculateMA(prices, 224);
      
      // ì¼ëª©ê· í˜•í‘œ ê³„ì‚°
      const ichimoku = calculateIchimoku(highs, lows, prices);
      
      // ì¶”ì„¸ì„  ê³„ì‚°
      const trendline = calculateTrendline(prices);
      
      // ì§€ì§€ì„ /ì €í•­ì„  ê³„ì‚°
      const support = calculateSupport(lows);
      const resistance = calculateResistance(highs);
      
      // ë°ì´í„°ì…‹ êµ¬ì„±
      const datasets = [
        {
          label: 'ì¢…ê°€',
          data: prices,
          borderColor: 'rgb(255, 255, 255)',
          backgroundColor: 'rgba(255, 255, 255, 0.1)',
          borderWidth: 2,
          pointRadius: 0,
          yAxisID: 'y',
          order: 1
        }
      ];
      
      // ì´ë™í‰ê· ì„ 
      if (showMA60) {
        datasets.push({
          label: '60ì¼ì„ ',
          data: ma60,
          borderColor: 'rgb(59, 130, 246)',
          backgroundColor: 'transparent',
          borderWidth: 1.5,
          pointRadius: 0,
          yAxisID: 'y',
          order: 1
        });
      }
      
      if (showMA112) {
        datasets.push({
          label: '112ì¼ì„ ',
          data: ma112,
          borderColor: 'rgb(168, 85, 247)',
          backgroundColor: 'transparent',
          borderWidth: 1.5,
          pointRadius: 0,
          yAxisID: 'y',
          order: 1
        });
      }
      
      if (showMA224) {
        datasets.push({
          label: '224ì¼ì„ ',
          data: ma224,
          borderColor: 'rgb(239, 68, 68)',
          backgroundColor: 'transparent',
          borderWidth: 1.5,
          pointRadius: 0,
          yAxisID: 'y',
          order: 1
        });
      }
      
      // ì¼ëª©ê· í˜•í‘œ êµ¬ë¦„ëŒ€
      if (showIchimoku) {
        // ì„ í–‰ìŠ¤íŒ¬1
        datasets.push({
          label: 'ì„ í–‰ìŠ¤íŒ¬1',
          data: ichimoku.senkou_span_a,
          borderColor: 'rgba(34, 197, 94, 0.6)',
          backgroundColor: 'transparent',
          borderWidth: 1,
          pointRadius: 0,
          yAxisID: 'y',
          order: 3,
          fill: '+1' // ë‹¤ìŒ ë°ì´í„°ì…‹ê³¼ ì‚¬ì´ ì±„ìš°ê¸°
        });
        
        // ì„ í–‰ìŠ¤íŒ¬2
        datasets.push({
          label: 'ì„ í–‰ìŠ¤íŒ¬2',
          data: ichimoku.senkou_span_b,
          borderColor: 'rgba(239, 68, 68, 0.6)',
          backgroundColor: 'rgba(147, 51, 234, 0.15)', // ë³´ë¼ìƒ‰ ë°˜íˆ¬ëª…
          borderWidth: 1,
          pointRadius: 0,
          yAxisID: 'y',
          order: 3,
          fill: '-1' // ì´ì „ ë°ì´í„°ì…‹ê³¼ ì‚¬ì´ ì±„ìš°ê¸°
        });
      }
      
      // ì¶”ì„¸ì„ 
      if (showTrendline) {
        datasets.push({
          label: 'ì¶”ì„¸ì„ ',
          data: trendline,
          borderColor: 'rgb(251, 191, 36)',
          backgroundColor: 'transparent',
          borderWidth: 2,
          borderDash: [5, 5],
          pointRadius: 0,
          yAxisID: 'y',
          order: 2
        });
      }
      
      // ì§€ì§€ì„ 
      if (showSupport) {
        datasets.push({
          label: 'ì§€ì§€ì„ ',
          data: support,
          borderColor: 'rgb(34, 197, 94)',
          backgroundColor: 'transparent',
          borderWidth: 2,
          borderDash: [10, 5],
          pointRadius: 0,
          yAxisID: 'y',
          order: 2
        });
      }
      
      // ì €í•­ì„ 
      if (showResistance) {
        datasets.push({
          label: 'ì €í•­ì„ ',
          data: resistance,
          borderColor: 'rgb(239, 68, 68)',
          backgroundColor: 'transparent',
          borderWidth: 2,
          borderDash: [10, 5],
          pointRadius: 0,
          yAxisID: 'y',
          order: 2
        });
      }
      
      // ê°€ê²© ì°¨íŠ¸ ìƒì„±
      priceChartInstance = new Chart(priceCtx, {
        type: 'line',
        data: {
          labels: labels,
          datasets: datasets
        },
        options: {
          responsive: true,
          maintainAspectRatio: false,
          interaction: {
            mode: 'index',
            intersect: false
          },
          plugins: {
            legend: {
              labels: { color: 'white', font: { size: 10 } },
              onClick: null
            },
            tooltip: {
              backgroundColor: 'rgba(0, 0, 0, 0.8)',
              titleColor: 'white',
              bodyColor: 'white',
              enabled: function() {
                // Shift í‚¤ë¥¼ ëˆ„ë¥´ê³  ìˆìœ¼ë©´ tooltip ë¹„í™œì„±í™” (íŒ¨ë‹ ëª¨ë“œ)
                return !isShiftPressed;
              }
            },
            zoom: {
              pan: {
                enabled: true,
                mode: 'x',
                modifierKey: 'shift',
                // scaleMode ì¶”ê°€: ìŠ¤ì¼€ì¼ë§Œ ì´ë™ (ë°ì´í„°ëŠ” ê³ ì •)
                scaleMode: 'x'
              },
              zoom: {
                wheel: {
                  enabled: false
                },
                pinch: {
                  enabled: false
                },
                mode: 'x'
              },
              limits: {
                x: {
                  minRange: 10 // ìµœì†Œ 10ê°œ ë°ì´í„° í¬ì¸íŠ¸ í‘œì‹œ
                }
              }
            }
          },
          scales: {
            x: {
              ticks: { 
                color: 'rgba(255, 255, 255, 0.6)',
                maxTicksLimit: 15
              },
              grid: { color: 'rgba(255, 255, 255, 0.1)' }
            },
            y: {
              type: 'linear',
              position: 'left',
              ticks: { 
                color: 'rgba(255, 255, 255, 0.8)',
                callback: function(value) {
                  return value.toLocaleString();
                }
              },
              grid: { color: 'rgba(255, 255, 255, 0.1)' }
            },
            y1: {
              type: 'linear',
              position: 'right',
              ticks: { 
                color: 'rgba(255, 255, 255, 0.6)',
                callback: function(value) {
                  return value.toLocaleString();
                }
              },
              grid: { display: false }
            }
          }
        }
      });
      
      // ê±°ë˜ëŸ‰ ì°¨íŠ¸ ìƒì„± (ë³„ë„)
      volumeChartInstance = new Chart(volumeCtx, {
        type: 'bar',
        data: {
          labels: labels,
          datasets: [{
            label: 'ê±°ë˜ëŸ‰',
            data: volumes,
            backgroundColor: volumes.map((v, i) => {
              if (i === 0) return 'rgba(34, 197, 94, 0.6)';
              return prices[i] >= prices[i-1] ? 'rgba(34, 197, 94, 0.6)' : 'rgba(239, 68, 68, 0.6)';
            }),
            borderWidth: 0
          }]
        },
        options: {
          responsive: true,
          maintainAspectRatio: false,
          interaction: {
            mode: 'index',
            intersect: false
          },
          plugins: {
            legend: {
              display: false
            },
            tooltip: {
              backgroundColor: 'rgba(0, 0, 0, 0.8)',
              titleColor: 'white',
              bodyColor: 'white',
              enabled: function() {
                // Shift í‚¤ë¥¼ ëˆ„ë¥´ê³  ìˆìœ¼ë©´ tooltip ë¹„í™œì„±í™” (íŒ¨ë‹ ëª¨ë“œ)
                return !isShiftPressed;
              }
            },
            zoom: {
              pan: {
                enabled: true,
                mode: 'x',
                modifierKey: 'shift',
                scaleMode: 'x'
              },
              zoom: {
                wheel: {
                  enabled: false
                },
                pinch: {
                  enabled: false
                },
                mode: 'x'
              },
              limits: {
                x: {
                  minRange: 10 // ìµœì†Œ 10ê°œ ë°ì´í„° í¬ì¸íŠ¸ í‘œì‹œ
                }
              }
            }
          },
          scales: {
            x: {
              ticks: { 
                color: 'rgba(255, 255, 255, 0.6)',
                maxTicksLimit: 15
              },
              grid: { color: 'rgba(255, 255, 255, 0.1)' }
            },
            y: {
              type: 'linear',
              ticks: { 
                color: 'rgba(34, 197, 94, 0.8)',
                callback: function(value) {
                  if (value >= 1000000) return (value/1000000).toFixed(1) + 'M';
                  if (value >= 1000) return (value/1000).toFixed(0) + 'K';
                  return value;
                }
              },
              grid: { color: 'rgba(255, 255, 255, 0.05)' }
            }
          }
        }
      });
      
      // ë‘ ì°¨íŠ¸ì˜ ì¤Œ/íŒ¬ ë™ê¸°í™”
      priceChartInstance.options.plugins.zoom.pan.onPan = function({chart}) {
        volumeChartInstance.options.scales.x.min = chart.scales.x.min;
        volumeChartInstance.options.scales.x.max = chart.scales.x.max;
        volumeChartInstance.update('none');
      };
      
      volumeChartInstance.options.plugins.zoom.pan.onPan = function({chart}) {
        priceChartInstance.options.scales.x.min = chart.scales.x.min;
        priceChartInstance.options.scales.x.max = chart.scales.x.max;
        priceChartInstance.update('none');
      };
    }
    
    // ì´ë™í‰ê·  ê³„ì‚°
    function calculateMA(prices, period) {
      const result = [];
      const realLength = prices.filter(p => p !== null).length;
      
      for (let i = 0; i < prices.length; i++) {
        if (i >= realLength) {
          // ë¯¸ë˜ ë°ì´í„°ëŠ” null
          result.push(null);
        } else if (i < period - 1) {
          result.push(null);
        } else {
          const validPrices = prices.slice(i - period + 1, i + 1).filter(p => p !== null);
          const sum = validPrices.reduce((a, b) => a + b, 0);
          result.push(sum / validPrices.length);
        }
      }
      return result;
    }
    
    // ì¼ëª©ê· í˜•í‘œ ê³„ì‚°
    function calculateIchimoku(highs, lows, prices) {
      const senkou_span_a = [];
      const senkou_span_b = [];
      
      // ì‹¤ì œ ë°ì´í„° ê¸¸ì´ (ë¯¸ë˜ 26ì¼ ì œì™¸)
      const realDataLength = prices.filter(p => p !== null).length;
      
      for (let i = 0; i < realDataLength; i++) {
        if (i < 26) {
          senkou_span_a.push(null);
          senkou_span_b.push(null);
          continue;
        }
        
        // ì „í™˜ì„  (9ì¼): (9ì¼ ìµœê³  + 9ì¼ ìµœì €) / 2
        const tenkan = (Math.max(...highs.slice(i-8, i+1)) + Math.min(...lows.slice(i-8, i+1))) / 2;
        
        // ê¸°ì¤€ì„  (26ì¼): (26ì¼ ìµœê³  + 26ì¼ ìµœì €) / 2
        const kijun = (Math.max(...highs.slice(i-25, i+1)) + Math.min(...lows.slice(i-25, i+1))) / 2;
        
        // ì„ í–‰ìŠ¤íŒ¬1: (ì „í™˜ì„  + ê¸°ì¤€ì„ ) / 2
        senkou_span_a.push((tenkan + kijun) / 2);
        
        // ì„ í–‰ìŠ¤íŒ¬2: (52ì¼ ìµœê³  + 52ì¼ ìµœì €) / 2
        if (i >= 52) {
          const span_b = (Math.max(...highs.slice(i-51, i+1)) + Math.min(...lows.slice(i-51, i+1))) / 2;
          senkou_span_b.push(span_b);
        } else {
          senkou_span_b.push(null);
        }
      }
      
      // 26ì¼ ì„ í–‰: ì•ì— 26ê°œ null ì¶”ê°€, ë’¤ì— 26ê°œ ì‹¤ì œ ë°ì´í„°ë¡œ í™•ì¥
      const shifted_senkou_a = Array(26).fill(null).concat(senkou_span_a);
      const shifted_senkou_b = Array(26).fill(null).concat(senkou_span_b);
      
      return { 
        senkou_span_a: shifted_senkou_a.slice(0, prices.length), 
        senkou_span_b: shifted_senkou_b.slice(0, prices.length)
      };
    }
    
    // ì¶”ì„¸ì„  ê³„ì‚° (ì„ í˜• íšŒê·€) - ì‹¤ì œ ë°ì´í„° ë²”ìœ„ë§Œ
    function calculateTrendline(prices) {
      // ì‹¤ì œ ê°€ê²© ë°ì´í„° ê°œìˆ˜ (null ì•„ë‹Œ ê²ƒë§Œ)
      const realPrices = prices.filter(p => p !== null);
      const realLength = realPrices.length;
      
      let sumX = 0, sumY = 0, sumXY = 0, sumXX = 0;
      
      for (let i = 0; i < realLength; i++) {
        sumX += i;
        sumY += realPrices[i];
        sumXY += i * realPrices[i];
        sumXX += i * i;
      }
      
      const slope = (realLength * sumXY - sumX * sumY) / (realLength * sumXX - sumX * sumX);
      const intercept = (sumY - slope * sumX) / realLength;
      
      // ì‹¤ì œ ë°ì´í„° ë²”ìœ„ë§Œ ê³„ì‚°í•˜ê³ , ë¯¸ë˜ëŠ” null
      return prices.map((p, i) => {
        if (i < realLength) {
          return slope * i + intercept;
        }
        return null; // ë¯¸ë˜ 26ì¼ì€ null
      });
    }
    
    // ì§€ì§€ì„  ê³„ì‚° (ìµœê·¼ 60ì¼ ìµœì €ê°€ ê¸°ì¤€) - ì‹¤ì œ ë°ì´í„° ë²”ìœ„ë§Œ
    function calculateSupport(lows) {
      const result = [];
      const period = 60;
      const realLength = lows.filter(l => l !== null).length;
      
      for (let i = 0; i < lows.length; i++) {
        if (i >= realLength) {
          // ë¯¸ë˜ ë°ì´í„°ëŠ” null
          result.push(null);
        } else if (i < period) {
          result.push(null);
        } else {
          const min = Math.min(...lows.slice(i - period, i + 1).filter(l => l !== null));
          result.push(min);
        }
      }
      
      return result;
    }
    
    // ì €í•­ì„  ê³„ì‚° (ìµœê·¼ 60ì¼ ìµœê³ ê°€ ê¸°ì¤€) - ì‹¤ì œ ë°ì´í„° ë²”ìœ„ë§Œ
    function calculateResistance(highs) {
      const result = [];
      const period = 60;
      const realLength = highs.filter(h => h !== null).length;
      
      for (let i = 0; i < highs.length; i++) {
        if (i >= realLength) {
          // ë¯¸ë˜ ë°ì´í„°ëŠ” null
          result.push(null);
        } else if (i < period) {
          result.push(null);
        } else {
          const max = Math.max(...highs.slice(i - period, i + 1).filter(h => h !== null));
          result.push(max);
        }
      }
      
      return result;
    }
    
    // í†µê³„ ì •ë³´ ì—…ë°ì´íŠ¸
    function updateChartStats(data) {
      if (data.length === 0) return;
      
      const latest = data[0]; // ìµœì‹  ë°ì´í„°
      const prices = data.map(d => d.close);
      
      document.getElementById('chartPrice').textContent = 
        latest.close.toLocaleString() + 'ì›';
      
      const ma60 = calculateMA(prices.reverse(), 60);
      const ma112 = calculateMA(prices, 112);
      const ma224 = calculateMA(prices, 224);
      
      const latestIdx = ma60.length - 1;
      
      document.getElementById('chartMa60').textContent = 
        ma60[latestIdx] ? Math.round(ma60[latestIdx]).toLocaleString() + 'ì›' : 'N/A';
      document.getElementById('chartMa112').textContent = 
        ma112[latestIdx] ? Math.round(ma112[latestIdx]).toLocaleString() + 'ì›' : 'N/A';
      document.getElementById('chartMa224').textContent = 
        ma224[latestIdx] ? Math.round(ma224[latestIdx]).toLocaleString() + 'ì›' : 'N/A';
    }
    
    // ì¢…ëª©ëª… ë™ê¸°í™”
    async function syncStockNames() {
      if (!app.appKey || !app.appSecret) {
        alert('âŒ API KEYì™€ SECRETì„ ë¨¼ì € ì…ë ¥í•´ì£¼ì„¸ìš”!');
        return;
      }
      
      if (!confirm('ğŸ”„ DBì˜ ì¢…ëª©ì½”ë“œë¡œ í•œíˆ¬ APIì—ì„œ ì¢…ëª©ëª…ì„ ê°€ì ¸ì˜µë‹ˆë‹¤.\n\nì•½ 3,600ê°œ Ã— 70ms = 4-5ë¶„ ì†Œìš”\n\nê³„ì†í•˜ì‹œê² ìŠµë‹ˆê¹Œ?')) {
        return;
      }
      
      try {
        const statusEl = document.getElementById('syncStatus');
        statusEl.textContent = 'ğŸ”„ ë™ê¸°í™” ì¤‘... (4-5ë¶„ ì†Œìš”, ë°±ê·¸ë¼ìš´ë“œ ì‹¤í–‰)';
        statusEl.className = 'mt-2 text-xs text-yellow-400';
        
        const response = await fetch('http://localhost:8080/api/v1/database/sync-stock-names', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({
            appKey: app.appKey,
            appSecret: app.appSecret,
            isProduction: app.isProduction
          })
        });
        
        if (response.ok) {
          statusEl.textContent = 'âœ… ë™ê¸°í™” ì‹œì‘! 4-5ë¶„ í›„ ì™„ë£Œë©ë‹ˆë‹¤. docker logsë¡œ ì§„í–‰ìƒí™© í™•ì¸ ê°€ëŠ¥';
          statusEl.className = 'mt-2 text-xs text-green-400';
        } else {
          throw new Error('ë™ê¸°í™” ì‹¤íŒ¨');
        }
      } catch (err) {
        document.getElementById('syncStatus').textContent = 'âŒ ë™ê¸°í™” ì‹¤íŒ¨: ' + err.message;
        document.getElementById('syncStatus').className = 'mt-2 text-xs text-red-400';
      }
    }
    
    // ì¢…ëª© ë§ˆìŠ¤í„° íŒŒì¼ ì—…ë¡œë“œ
    async function uploadStockMasterFiles() {
      const kospiFile = document.getElementById('kospiFile').files[0];
      const kosdaqFile = document.getElementById('kosdaqFile').files[0];
      
      if (!kospiFile && !kosdaqFile) {
        alert('âŒ KOSPI ë˜ëŠ” KOSDAQ íŒŒì¼ì„ ì„ íƒí•´ì£¼ì„¸ìš”!');
        return;
      }
      
      if (!confirm(`ğŸ“¤ ì¢…ëª© ë§ˆìŠ¤í„° íŒŒì¼ì„ ì—…ë¡œë“œí•©ë‹ˆë‹¤.\n\nKOSPI: ${kospiFile ? kospiFile.name : 'ì—†ìŒ'}\nKOSDAQ: ${kosdaqFile ? kosdaqFile.name : 'ì—†ìŒ'}\n\nê³„ì†í•˜ì‹œê² ìŠµë‹ˆê¹Œ?`)) {
        return;
      }
      
      try {
        const statusEl = document.getElementById('uploadStatus');
        statusEl.textContent = 'ğŸ“¤ ì—…ë¡œë“œ ì¤‘...';
        statusEl.className = 'mt-2 text-xs text-yellow-400';
        
        const formData = new FormData();
        if (kospiFile) formData.append('files', kospiFile);
        if (kosdaqFile) formData.append('files', kosdaqFile);
        
        const response = await fetch('http://localhost:8080/api/v1/database/upload-stock-master', {
          method: 'POST',
          body: formData
        });
        
        const result = await response.json();
        
        if (response.ok) {
          statusEl.textContent = `âœ… ì—…ë¡œë“œ ì™„ë£Œ! KOSPI: ${result.kospiCount}ê°œ, KOSDAQ: ${result.kosdaqCount}ê°œ, ì´: ${result.totalCount}ê°œ`;
          statusEl.className = 'mt-2 text-xs text-green-400';
          
          // DB ìƒíƒœ ê°±ì‹ 
          setTimeout(() => checkDatabaseStatus(), 1000);
          
          // íŒŒì¼ ì…ë ¥ ì´ˆê¸°í™”
          document.getElementById('kospiFile').value = '';
          document.getElementById('kosdaqFile').value = '';
        } else {
          throw new Error(result.error || 'ì—…ë¡œë“œ ì‹¤íŒ¨');
        }
        
      } catch (err) {
        const statusEl = document.getElementById('uploadStatus');
        statusEl.textContent = 'âŒ ì—…ë¡œë“œ ì‹¤íŒ¨: ' + err.message;
        statusEl.className = 'mt-2 text-xs text-red-400';
      }
    }

    async function validateCredentials() {
      try {
        const response = await fetch(`${API_BASE_URL}/api/v1/validate-credentials`, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({
            appKey: app.appKey,
            appSecret: app.appSecret
          })
        });
        
        const data = await response.json();
        if (data.valid) {
          app.error = '';
          return true;
        } else {
          throw new Error(data.message || 'ì¸ì¦ ì‹¤íŒ¨');
        }
      } catch (err) {
        app.error = 'API ì¸ì¦ ì‹¤íŒ¨: ' + err.message;
        render();
        return false;
      }
    }

    // ê¸°ìˆ ì  ì§€í‘œ ê³„ì‚° í•¨ìˆ˜ë“¤ì€ ë°±ì—”ë“œì—ì„œ ì²˜ë¦¬ë˜ë¯€ë¡œ ì œê±°ë¨

    async function runScreener() {
      if (!app.appKey || !app.appSecret) {
        app.error = 'APP KEYì™€ APP SECRETì„ ì…ë ¥í•´ì£¼ì„¸ìš”';
        render();
        return;
      }

      app.loading = true;
      app.error = '';
      app.results = [];
      render();

      try {
        // FastAPI ë°±ì—”ë“œë¡œ ìŠ¤í¬ë¦¬ë‹ ìš”ì²­ ì „ì†¡
        const response = await fetch(`${API_BASE_URL}/api/v1/screen`, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({
            appKey: app.appKey,
            appSecret: app.appSecret,
            isProduction: app.isProduction,
            ...app.conditions
          })
        });

        if (!response.ok) {
          const errorData = await response.json();
          throw new Error(errorData.error || errorData.detail || 'ìŠ¤í¬ë¦¬ë‹ ì‹¤íŒ¨');
        }

        const result = await response.json();
        
        // ê²°ê³¼ ë³€í™˜ (ë°±ì—”ë“œ ì‘ë‹µ í˜•ì‹ì— ë§ê²Œ)
        app.results = result.stocks.map(stock => ({
          code: stock.code,
          name: stock.name,
          currentPrice: stock.currentPrice,
          changePercent: stock.changePercent,
          ma5: stock.ma5,
          ma20: stock.ma20,
          ma60: stock.ma60,
          ma112: stock.ma112,
          ma224: stock.ma224,
          ma60Ratio: stock.ma60Ratio,
          ma112Ratio: stock.ma112Ratio,
          ma224Ratio: stock.ma224Ratio,
          bbPosition: stock.bbPosition,
          currentVolume: stock.volume,
          volumeRatio: stock.volumeRatio,
          maAlignment: stock.maAlignment
        }));

        console.log(`ìŠ¤í¬ë¦¬ë‹ ì™„ë£Œ: ${result.matchedCount}/${result.totalScanned} ì¢…ëª© (${result.executionTimeMs}ms)`);
        app.hasSearched = true;  // ê²€ìƒ‰ ì‹¤í–‰ë¨
        
      } catch (err) {
        app.error = 'ê²€ìƒ‰ ì¤‘ ì˜¤ë¥˜ ë°œìƒ: ' + err.message;
        app.hasSearched = true;  // ê²€ìƒ‰ ì‹¤í–‰ë¨ (ì—ëŸ¬ì§€ë§Œ)
        console.error('Screening error:', err);
      } finally {
        app.loading = false;
        render();
      }
    }

    function render() {
      const appDiv = document.getElementById('app');
      appDiv.innerHTML = `
        <div class="text-center mb-8">
          <h1 class="text-3xl md:text-4xl font-bold text-white mb-2">ğŸ“ˆ ì£¼ì‹ ì¡°ê±´ ê²€ìƒ‰ê¸°</h1>
          <p class="text-blue-200">ê¸°ìˆ ì  ë¶„ì„ ê¸°ë°˜ ì¢…ëª© ìŠ¤í¬ë¦¬ë‹</p>
        </div>

        <div class="bg-white/10 backdrop-blur-md rounded-xl p-4 md:p-6 mb-6 border border-white/20">
          <h2 class="text-lg md:text-xl font-bold text-white mb-4">ğŸ”‘ í•œêµ­íˆ¬ìì¦ê¶Œ API ì„¤ì •</h2>
          
          <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-4">
            <div>
              <label class="block text-sm font-medium text-blue-200 mb-2">ê³„ì¢Œ êµ¬ë¶„</label>
              <div class="flex gap-4">
                <label class="flex items-center gap-2 text-white cursor-pointer">
                  <input type="radio" name="accountType" value="mock" ${!app.isProduction ? 'checked' : ''} class="w-4 h-4">
                  <span>ğŸ® ëª¨ì˜íˆ¬ì</span>
                </label>
                <label class="flex items-center gap-2 text-white cursor-pointer">
                  <input type="radio" name="accountType" value="real" ${app.isProduction ? 'checked' : ''} class="w-4 h-4">
                  <span class="text-green-400 font-semibold">ğŸ’ ì‹¤ì „íˆ¬ì</span>
                </label>
              </div>
            </div>
            <div>
              <label class="block text-sm font-medium text-blue-200 mb-2">ì‹œì¥ ì„ íƒ</label>
              <div class="flex gap-4">
                <label class="flex items-center gap-2 text-white cursor-pointer">
                  <input type="checkbox" id="searchDomestic" ${app.searchDomestic ? 'checked' : ''} class="w-4 h-4">
                  <span>ğŸ‡°ğŸ‡· êµ­ë‚´ì£¼ì‹</span>
                </label>
                <label class="flex items-center gap-2 text-white cursor-pointer">
                  <input type="checkbox" id="searchUS" ${app.searchUS ? 'checked' : ''} class="w-4 h-4">
                  <span>ğŸ‡ºğŸ‡¸ í•´ì™¸ì£¼ì‹</span>
                </label>
              </div>
            </div>
          </div>
          
          <!-- ë””ë²„ê·¸ ì •ë³´ í‘œì‹œ -->
          <div class="bg-yellow-900/30 border border-yellow-500/50 rounded-lg p-3 mb-4 text-xs text-yellow-200">
            <strong>ğŸ” ë””ë²„ê·¸ ì •ë³´:</strong><br>
            app.appKey ê¸¸ì´: ${app.appKey?.length || 0}ì ${app.appKey ? 'âœ…' : 'âŒ'}<br>
            app.appSecret ê¸¸ì´: ${app.appSecret?.length || 0}ì ${app.appSecret ? 'âœ…' : 'âŒ'}<br>
            isProduction: ${app.isProduction ? 'true âœ…' : 'false'}
          </div>
          
          <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-4">
            <div>
              <label class="block text-sm font-medium text-blue-200 mb-2">
                APP KEY
                ${app.appKey ? '<span class="text-green-400 text-xs ml-2">âœ“ ì €ì¥ë¨</span>' : '<span class="text-red-400 text-xs ml-2">âœ— ë¹„ì–´ìˆìŒ</span>'}
              </label>
              <input type="text" id="appKey" value="${app.appKey || ''}" placeholder="APP KEY ì…ë ¥"
                oninput="app.appKey = this.value; render();"
                class="w-full px-4 py-2 bg-white/20 border border-white/30 rounded-lg text-white placeholder-white/50 focus:outline-none focus:ring-2 focus:ring-blue-400">
            </div>
            <div>
              <label class="block text-sm font-medium text-blue-200 mb-2">
                APP SECRET
                ${app.appSecret ? '<span class="text-green-400 text-xs ml-2">âœ“ ì €ì¥ë¨</span>' : '<span class="text-red-400 text-xs ml-2">âœ— ë¹„ì–´ìˆìŒ</span>'}
              </label>
              <input type="password" id="appSecret" value="${app.appSecret || ''}" placeholder="APP SECRET ì…ë ¥"
                oninput="app.appSecret = this.value; render();"
                class="w-full px-4 py-2 bg-white/20 border border-white/30 rounded-lg text-white placeholder-white/50 focus:outline-none focus:ring-2 focus:ring-blue-400">
            </div>
          </div>
          
          <div class="flex gap-2 mb-4 flex-wrap">
            <button onclick="saveApiKeysManual()" 
              class="px-4 py-2 bg-green-600 hover:bg-green-700 text-white rounded-lg text-sm font-medium transition-colors">
              ğŸ’¾ API í‚¤ ì €ì¥
            </button>
            ${app.appKey || app.appSecret ? `
              <button onclick="clearApiKeys()" 
                class="px-4 py-2 bg-red-600 hover:bg-red-700 text-white rounded-lg text-sm font-medium transition-colors">
                ğŸ—‘ï¸ ì €ì¥ëœ í‚¤ ì‚­ì œ
              </button>
            ` : ''}
            <button onclick="debugApiKeys()" 
              class="px-4 py-2 bg-yellow-600 hover:bg-yellow-700 text-white rounded-lg text-sm font-medium transition-colors">
              ğŸ” ì €ì¥ ìƒíƒœ í™•ì¸
            </button>
          </div>
          
          <div class="text-sm text-blue-200 bg-blue-900/30 p-3 rounded-lg mb-4">
            <strong>ğŸ” ë³´ì•ˆ:</strong> API í‚¤ëŠ” XOR ì•”í˜¸í™” + Base64 ì¸ì½”ë”©ë˜ì–´ ë¸Œë¼ìš°ì €ì— ì €ì¥ë©ë‹ˆë‹¤.
            <br>
            <strong>ğŸ’¡ íŒ:</strong> ë‹¤ìŒ ë°©ë¬¸ ì‹œ ìë™ìœ¼ë¡œ ë¶ˆëŸ¬ì˜µë‹ˆë‹¤. ê³µìš© PCì—ì„œëŠ” ì‚¬ìš© í›„ ì‚­ì œí•˜ì„¸ìš”.
            <br>
            <strong>API í‚¤ ë°œê¸‰:</strong> í•œêµ­íˆ¬ìì¦ê¶Œ í™ˆí˜ì´ì§€ â†’ KIS Developers â†’ ì•± ë“±ë¡
          </div>
          
          <!-- DB ê´€ë¦¬ ì˜ì—­ -->
          <div id="dbManagement" class="border-t border-white/20 pt-4">
            <div class="flex items-center justify-between gap-4 flex-wrap">
              <div class="flex-1">
                <div class="text-sm font-medium text-blue-200">ğŸ“Š ë°ì´í„°ë² ì´ìŠ¤ ìƒíƒœ</div>
                <div id="dbStatusText" class="text-xs text-white/70 mt-1">í™•ì¸ ì¤‘...</div>
              </div>
              <div class="flex gap-2">
                <button id="dbInitBtn" onclick="initializeDatabase()" 
                  class="hidden px-4 py-2 bg-purple-600 hover:bg-purple-700 text-white rounded-lg text-sm font-medium transition-colors">
                  ğŸš€ DB ì´ˆê¸°í™”
                </button>
                <button id="dbRebuildBtn" onclick="rebuildDatabase()" 
                  class="hidden px-4 py-2 bg-orange-600 hover:bg-orange-700 text-white rounded-lg text-sm font-medium transition-colors">
                  ğŸ”„ DB ì¬êµ¬ì¶•
                </button>
                <button id="dbUpdateBtn" onclick="updateDatabase()" 
                  class="hidden px-4 py-2 bg-green-600 hover:bg-green-700 text-white rounded-lg text-sm font-medium transition-colors">
                  âœ¨ DB ì—…ë°ì´íŠ¸
                </button>
              </div>
            </div>
            
            <!-- ì¢…ëª© ë§ˆìŠ¤í„° íŒŒì¼ ì—…ë¡œë“œ -->
            <div class="mt-4 pt-4 border-t border-white/20">
              <div class="flex items-center justify-between mb-2">
                <div>
                  <div class="text-sm font-medium text-blue-200">ğŸ“ ì¢…ëª© ë§ˆìŠ¤í„° íŒŒì¼ ì—…ë¡œë“œ</div>
                  <div class="text-xs text-white/50 mt-1">í•œêµ­íˆ¬ìì¦ê¶Œ ì¢…ëª©ì •ë³´íŒŒì¼ (KOSPI, KOSDAQ)</div>
                </div>
              </div>
              <div class="grid grid-cols-2 gap-3">
                <!-- KOSPI íŒŒì¼ ì—…ë¡œë“œ -->
                <div>
                  <label class="block text-xs text-white/70 mb-1">KOSPI íŒŒì¼</label>
                  <input type="file" id="kospiFile" accept=".mst,.txt,.dat" 
                    class="block w-full text-xs text-white/70 file:mr-2 file:py-2 file:px-3 file:rounded-lg file:border-0 file:text-xs file:font-semibold file:bg-blue-600 file:text-white hover:file:bg-blue-700 file:cursor-pointer cursor-pointer bg-white/5 border border-white/20 rounded-lg">
                </div>
                <!-- KOSDAQ íŒŒì¼ ì—…ë¡œë“œ -->
                <div>
                  <label class="block text-xs text-white/70 mb-1">KOSDAQ íŒŒì¼</label>
                  <input type="file" id="kosdaqFile" accept=".mst,.txt,.dat" 
                    class="block w-full text-xs text-white/70 file:mr-2 file:py-2 file:px-3 file:rounded-lg file:border-0 file:text-xs file:font-semibold file:bg-blue-600 file:text-white hover:file:bg-blue-700 file:cursor-pointer cursor-pointer bg-white/5 border border-white/20 rounded-lg">
                </div>
              </div>
              <button onclick="uploadStockMasterFiles()" 
                class="mt-3 w-full px-4 py-2 bg-indigo-600 hover:bg-indigo-700 text-white rounded-lg text-sm font-medium transition-colors">
                ğŸ“¤ ì¢…ëª© íŒŒì¼ ì—…ë¡œë“œ
              </button>
              <div id="uploadStatus" class="mt-2 text-xs text-white/70"></div>
              
              <div class="mt-4 pt-4 border-t border-white/20">
                <div class="text-xs text-white/50 mb-2">ğŸ’¡ DB ì¢…ëª©ì½”ë“œë¡œ í•œíˆ¬ APIì—ì„œ ì¢…ëª©ëª… ìë™ ê°±ì‹  (4-5ë¶„)</div>
                <button onclick="syncStockNames()" 
                  class="w-full px-4 py-2 bg-teal-600 hover:bg-teal-700 text-white rounded-lg text-sm font-medium transition-colors">
                  ğŸ”„ ì¢…ëª©ëª… ë™ê¸°í™”
                </button>
                <div id="syncStatus" class="mt-2 text-xs text-white/70"></div>
              </div>
            </div>
          </div>
        </div>

        <div class="bg-white/10 backdrop-blur-md rounded-xl p-4 md:p-6 mb-6 border border-white/20">
          <h2 class="text-lg md:text-xl font-bold text-white mb-4">âš™ï¸ ì¡°ê±´ì„¤ì •</h2>
          
          <div class="mb-6">
            <h3 class="text-base md:text-lg font-semibold text-blue-200 mb-3">ì œì™¸ ì¡°ê±´</h3>
            <div class="grid grid-cols-2 gap-3">
              <label class="flex items-center gap-2 text-white cursor-pointer text-sm">
                <input type="checkbox" id="excludeManagement" ${app.conditions.excludeManagement ? 'checked' : ''} class="w-4 h-4">
                <span>ê´€ë¦¬ì¢…ëª©/íˆ¬ìê²½ê³ </span>
              </label>
              <label class="flex items-center gap-2 text-white cursor-pointer text-sm">
                <input type="checkbox" id="excludeETF" ${app.conditions.excludeETF ? 'checked' : ''} class="w-4 h-4">
                <span>ETF/ETN ì œì™¸</span>
              </label>
            </div>
          </div>

          <div class="mb-6">
            <h3 class="text-base md:text-lg font-semibold text-blue-200 mb-3">ì´ë™í‰ê· ì„  (í•˜ë‚˜ë§Œ ì„ íƒ)</h3>
            <div class="space-y-3">
              ${[
                { key: 'ma60', label: '60ì¼', period: 60 },
                { key: 'ma112', label: '112ì¼', period: 112 },
                { key: 'ma224', label: '224ì¼', period: 224 }
              ].map(ma => `
                <div class="flex items-center gap-2 flex-wrap">
                  <label class="flex items-center gap-2 text-white cursor-pointer text-sm">
                    <input type="radio" name="maPeriod" value="${ma.period}" id="${ma.key}Enabled" 
                      ${app.conditions[ma.key + 'Enabled'] ? 'checked' : ''} class="w-4 h-4">
                    <span>${ma.label} ì´í‰ Â±</span>
                  </label>
                  <input type="number" id="${ma.key}Min" value="${app.conditions[ma.key + 'Min']}" 
                    class="w-16 px-2 py-1 bg-white/20 border border-white/30 rounded text-white text-sm"
                    ${!app.conditions[ma.key + 'Enabled'] ? 'disabled' : ''}>
                  <span class="text-white">~</span>
                  <input type="number" id="${ma.key}Max" value="${app.conditions[ma.key + 'Max']}" 
                    class="w-16 px-2 py-1 bg-white/20 border border-white/30 rounded text-white text-sm"
                    ${!app.conditions[ma.key + 'Enabled'] ? 'disabled' : ''}>
                  <span class="text-blue-300 text-sm">%</span>
                </div>
              `).join('')}
              <div class="text-xs text-blue-300 bg-blue-900/20 p-2 rounded mt-2">
                ğŸ’¡ í˜„ì¬ê°€ê°€ ì„ íƒí•œ ì´ë™í‰ê· ì„  ëŒ€ë¹„ ì„¤ì •í•œ ë²”ìœ„ ë‚´ì— ìˆëŠ” ì¢…ëª©ì„ ì°¾ìŠµë‹ˆë‹¤
              </div>
            </div>
          </div>

          <div class="mb-6">
            <h3 class="text-base md:text-lg font-semibold text-blue-200 mb-3">ë³¼ë¦°ì € ë°´ë“œ</h3>
            <div class="space-y-3">
              <label class="flex items-center gap-2 text-white cursor-pointer text-sm">
                <input type="checkbox" id="bbEnabled" ${app.conditions.bbEnabled ? 'checked' : ''} class="w-4 h-4">
                <span>BB ì¡°ê±´ ì‚¬ìš©</span>
              </label>
              
              <div class="space-y-2 ml-6 ${!app.conditions.bbEnabled ? 'opacity-50' : ''}">
                <div class="text-sm text-blue-300 mb-2">ì „ëµ ì„ íƒ:</div>
                <label class="flex items-center gap-2 text-white cursor-pointer text-sm">
                  <input type="radio" name="bbPreset" value="short" 
                    ${app.conditions.bbPeriod === 10 && app.conditions.bbMultiplier === 1.5 ? 'checked' : ''}
                    ${!app.conditions.bbEnabled ? 'disabled' : ''} class="w-4 h-4">
                  <span>ë‹¨ê¸° íŠ¸ë ˆì´ë”© (10ì¼, Â±1.5Ïƒ) - ë¯¼ê°í•˜ê²Œ ë°˜ì‘</span>
                </label>
                <label class="flex items-center gap-2 text-white cursor-pointer text-sm">
                  <input type="radio" name="bbPreset" value="normal" 
                    ${app.conditions.bbPeriod === 20 && app.conditions.bbMultiplier === 2 ? 'checked' : ''}
                    ${!app.conditions.bbEnabled ? 'disabled' : ''} class="w-4 h-4">
                  <span>ì¼ë°˜ì  (20ì¼, Â±2Ïƒ) - ê°€ì¥ ë§ì´ ì‚¬ìš© â­</span>
                </label>
                <label class="flex items-center gap-2 text-white cursor-pointer text-sm">
                  <input type="radio" name="bbPreset" value="long" 
                    ${app.conditions.bbPeriod === 30 && app.conditions.bbMultiplier === 3 ? 'checked' : ''}
                    ${!app.conditions.bbEnabled ? 'disabled' : ''} class="w-4 h-4">
                  <span>ì¥ê¸° íˆ¬ì (30ì¼, Â±3Ïƒ) - ì•ˆì •ì </span>
                </label>
                <label class="flex items-center gap-2 text-white cursor-pointer text-sm">
                  <input type="radio" name="bbPreset" value="trend" 
                    ${app.conditions.bbPeriod === 40 && app.conditions.bbMultiplier === 2 ? 'checked' : ''}
                    ${!app.conditions.bbEnabled ? 'disabled' : ''} class="w-4 h-4">
                  <span>ì¶”ì„¸ëŒíŒŒê¸°ì¤€ (40ì¼, Â±2Ïƒ) - ì¤‘ì¥ê¸° ì¶”ì„¸</span>
                </label>
              </div>
              
              <select id="bbPosition" class="px-3 py-1 bg-white/20 border border-white/30 rounded text-white text-sm"
                ${!app.conditions.bbEnabled ? 'disabled' : ''}>
                <option value="all" ${app.conditions.bbPosition === 'all' ? 'selected' : ''}>ìœ„ì¹˜ ë¬´ê´€</option>
                <option value="lower" ${app.conditions.bbPosition === 'lower' ? 'selected' : ''}>í•˜ë‹¨ ë°´ë“œ ê·¼ì²˜ (ê³¼ë§¤ë„)</option>
                <option value="middle" ${app.conditions.bbPosition === 'middle' ? 'selected' : ''}>ì¤‘ê°„ ë°´ë“œ ê·¼ì²˜</option>
                <option value="upper" ${app.conditions.bbPosition === 'upper' ? 'selected' : ''}>ìƒë‹¨ ë°´ë“œ ê·¼ì²˜ (ê³¼ë§¤ìˆ˜)</option>
              </select>
              
              <div class="grid grid-cols-1 md:grid-cols-2 gap-3 mt-3">
                <label class="flex items-center gap-2 text-white cursor-pointer text-sm">
                  <input type="checkbox" id="bbUpperBreak" ${app.conditions.bbUpperBreak ? 'checked' : ''} class="w-4 h-4">
                  <span>ìƒë‹¨ ë°´ë“œ ëŒíŒŒ (ê°•í•œ ìƒìŠ¹)</span>
                </label>
                <label class="flex items-center gap-2 text-white cursor-pointer text-sm">
                  <input type="checkbox" id="bbLowerBreak" ${app.conditions.bbLowerBreak ? 'checked' : ''} class="w-4 h-4">
                  <span>í•˜ë‹¨ ë°´ë“œ í„°ì¹˜ (ë°˜ë“± ê¸°íšŒ)</span>
                </label>
              </div>
              
              <div class="text-xs text-blue-300 bg-blue-900/20 p-2 rounded mt-2">
                ğŸ’¡ ìƒë‹¨ ëŒíŒŒ: ì£¼ê°€ > ìƒë‹¨ ë°´ë“œ | í•˜ë‹¨ í„°ì¹˜: ì£¼ê°€ â‰¤ í•˜ë‹¨ ë°´ë“œ
              </div>
            </div>
          </div>

          <div class="mb-6">
            <h3 class="text-base md:text-lg font-semibold text-blue-200 mb-3">ê±°ë˜ëŸ‰</h3>
            <div class="flex items-center gap-2 flex-wrap">
              <label class="flex items-center gap-2 text-white cursor-pointer text-sm">
                <input type="checkbox" id="volumeEnabled" ${app.conditions.volumeEnabled ? 'checked' : ''} class="w-4 h-4">
                <span>í‰ê·  ëŒ€ë¹„</span>
              </label>
              <input type="number" step="0.1" id="volumeMultiple" value="${app.conditions.volumeMultiple}" 
                class="w-20 px-2 py-1 bg-white/20 border border-white/30 rounded text-white text-sm"
                ${!app.conditions.volumeEnabled ? 'disabled' : ''}>
              <span class="text-blue-300 text-sm">ë°°</span>
            </div>
          </div>

          <div class="mb-6">
            <h3 class="text-base md:text-lg font-semibold text-blue-200 mb-3">ê°€ê²© ë³€ë™</h3>
            <div class="space-y-2">
              <label class="flex items-center gap-2 text-white cursor-pointer text-sm">
                <input type="checkbox" id="priceChangeEnabled" ${app.conditions.priceChangeEnabled ? 'checked' : ''} class="w-4 h-4">
                <span>ë“±ë½ë¥  ë²”ìœ„</span>
              </label>
              <div class="flex items-center gap-2 ml-6">
                <input type="number" step="0.1" id="priceChangeMin" value="${app.conditions.priceChangeMin}" 
                  class="w-20 px-2 py-1 bg-white/20 border border-white/30 rounded text-white text-sm"
                  ${!app.conditions.priceChangeEnabled ? 'disabled' : ''}>
                <span class="text-white">~</span>
                <input type="number" step="0.1" id="priceChangeMax" value="${app.conditions.priceChangeMax}" 
                  class="w-20 px-2 py-1 bg-white/20 border border-white/30 rounded text-white text-sm"
                  ${!app.conditions.priceChangeEnabled ? 'disabled' : ''}>
                <span class="text-blue-300 text-sm">%</span>
              </div>
            </div>
          </div>

          <div class="mb-6">
            <h3 class="text-base md:text-lg font-semibold text-blue-200 mb-3">ì¶”ê°€ ì¡°ê±´</h3>
            <div class="space-y-2">
              <label class="flex items-center gap-2 text-white cursor-pointer text-sm">
                <input type="checkbox" id="maAlignment" ${app.conditions.maAlignment ? 'checked' : ''} class="w-4 h-4">
                <span>ì´í‰ì„  ì •ë°°ì—´ (D: 60<112<224, I: 5â‰¥20) â­ ì „ëµì‹ í•„ìˆ˜</span>
              </label>
              <label class="flex items-center gap-2 text-white cursor-pointer text-sm">
                <input type="checkbox" id="ma20Enabled" ${app.conditions.ma20Enabled ? 'checked' : ''} class="w-4 h-4">
                <span>J: 20ì¼ì„  105% ì´í•˜ â­ ì „ëµì‹ í•„ìˆ˜</span>
              </label>
              <label class="flex items-center gap-2 text-white cursor-pointer text-sm">
                <input type="checkbox" id="highLowRangeEnabled" ${app.conditions.highLowRangeEnabled ? 'checked' : ''} class="w-4 h-4">
                <span>G/H: ê³ ê°€/ì €ê°€ ë“±ë½ë¥  12~30% (30ë´‰ ì´ë‚´) â­ ì „ëµì‹ í•„ìˆ˜</span>
              </label>
              <label class="flex items-center gap-2 text-white cursor-pointer text-sm">
                <input type="checkbox" id="ichimokuEnabled" ${app.conditions.ichimokuEnabled ? 'checked' : ''} class="w-4 h-4">
                <span>N: ì¼ëª©ê· í˜•í‘œ êµ¬ë¦„ëŒ€ ìœ„ [9,26,52] â­ ì „ëµì‹ í•„ìˆ˜</span>
              </label>
            </div>
          </div>

          <div class="mb-6">
            <h3 class="text-base md:text-lg font-semibold text-blue-200 mb-3">ì‹œê°€ì´ì•¡ (ì–µì›)</h3>
            <div class="space-y-2">
              <label class="flex items-center gap-2 text-white cursor-pointer text-sm">
                <input type="checkbox" id="marketCapEnabled" ${app.conditions.marketCapEnabled ? 'checked' : ''} class="w-4 h-4">
                <span>ì‹œê°€ì´ì•¡ ë²”ìœ„</span>
              </label>
              <div class="flex items-center gap-2 ml-6">
                <input type="number" step="1000" id="marketCapMin" value="${app.conditions.marketCapMin / 100000000}" 
                  class="w-24 px-2 py-1 bg-white/20 border border-white/30 rounded text-white text-sm"
                  ${!app.conditions.marketCapEnabled ? 'disabled' : ''}>
                <span class="text-white">~</span>
                <input type="number" step="1000" id="marketCapMax" value="${app.conditions.marketCapMax / 100000000}" 
                  class="w-24 px-2 py-1 bg-white/20 border border-white/30 rounded text-white text-sm"
                  ${!app.conditions.marketCapEnabled ? 'disabled' : ''}>
                <span class="text-blue-300 text-sm">ì–µ</span>
              </div>
            </div>
          </div>

          <div class="mb-6">
            <h3 class="text-base md:text-lg font-semibold text-blue-200 mb-3">ì¬ë¬´ ë¹„ìœ¨</h3>
            <div class="space-y-3">
              <div>
                <label class="flex items-center gap-2 text-white cursor-pointer text-sm mb-2">
                  <input type="checkbox" id="perEnabled" ${app.conditions.perEnabled ? 'checked' : ''} class="w-4 h-4">
                  <span>PER (ì£¼ê°€ìˆ˜ìµë¹„ìœ¨)</span>
                </label>
                <div class="flex items-center gap-2 ml-6">
                  <input type="number" step="1" id="perMin" value="${app.conditions.perMin}" 
                    class="w-20 px-2 py-1 bg-white/20 border border-white/30 rounded text-white text-sm"
                    ${!app.conditions.perEnabled ? 'disabled' : ''}>
                  <span class="text-white">~</span>
                  <input type="number" step="1" id="perMax" value="${app.conditions.perMax}" 
                    class="w-20 px-2 py-1 bg-white/20 border border-white/30 rounded text-white text-sm"
                    ${!app.conditions.perEnabled ? 'disabled' : ''}>
                </div>
              </div>
              <div>
                <label class="flex items-center gap-2 text-white cursor-pointer text-sm mb-2">
                  <input type="checkbox" id="pbrEnabled" ${app.conditions.pbrEnabled ? 'checked' : ''} class="w-4 h-4">
                  <span>PBR (ì£¼ê°€ìˆœìì‚°ë¹„ìœ¨)</span>
                </label>
                <div class="flex items-center gap-2 ml-6">
                  <input type="number" step="0.1" id="pbrMin" value="${app.conditions.pbrMin}" 
                    class="w-20 px-2 py-1 bg-white/20 border border-white/30 rounded text-white text-sm"
                    ${!app.conditions.pbrEnabled ? 'disabled' : ''}>
                  <span class="text-white">~</span>
                  <input type="number" step="0.1" id="pbrMax" value="${app.conditions.pbrMax}" 
                    class="w-20 px-2 py-1 bg-white/20 border border-white/30 rounded text-white text-sm"
                    ${!app.conditions.pbrEnabled ? 'disabled' : ''}>
                </div>
              </div>
            </div>
          </div>

          <button onclick="runScreener()" ${app.loading ? 'disabled' : ''}
            class="w-full bg-gradient-to-r from-blue-500 to-purple-600 hover:from-blue-600 hover:to-purple-700 disabled:from-gray-500 disabled:to-gray-600 text-white font-bold py-3 px-6 rounded-lg transition-all">
            ${app.loading ? 'ğŸ”„ ê²€ìƒ‰ ì¤‘...' : 'ğŸ” ì¡°ê±´ ê²€ìƒ‰ ì‹¤í–‰'}
          </button>
        </div>

        ${app.error ? `
          <div class="bg-red-500/20 border border-red-500 text-red-200 px-4 py-3 rounded-lg mb-6">
            ${app.error}
          </div>
        ` : ''}

        ${app.results.length > 0 ? `
          <div class="bg-white/10 backdrop-blur-md rounded-xl p-4 md:p-6 border border-white/20">
            <div class="flex items-center justify-between mb-4">
              <h2 class="text-lg md:text-xl font-bold text-white">âœ… ê²€ìƒ‰ ê²°ê³¼ (${app.results.length}ê°œ)</h2>
              <div class="text-xs text-blue-300">
                ğŸ’¡ ë¹„ìœ¨: í˜„ì¬ê°€ê°€ ì´í‰ì„ ë³´ë‹¤ ì–¼ë§ˆë‚˜ ë†’ì€ì§€ (100% = ì¼ì¹˜, 105% = 5% ìœ„)
              </div>
            </div>
            <div class="overflow-x-auto">
              <table class="w-full text-left text-xs md:text-sm">
                <thead>
                  <tr class="border-b border-white/20">
                    <th class="px-2 py-2 text-blue-200">ì¢…ëª©ëª…</th>
                    <th class="px-2 py-2 text-blue-200">ì¢…ëª©ì½”ë“œ</th>
                    <th class="px-2 py-2 text-blue-200">í˜„ì¬ê°€</th>
                    <th class="px-2 py-2 text-blue-200">ë“±ë½%</th>
                    ${getActiveMAPeriod() ? `
                      <th class="px-2 py-2 text-blue-200">${getActiveMAPeriod()}ì¼ì„ </th>
                      <th class="px-2 py-2 text-blue-200">ë¹„ìœ¨</th>
                    ` : ''}
                  </tr>
                </thead>
                <tbody>
                  ${app.results.map(stock => `
                    <tr class="border-b border-white/10 hover:bg-white/5 cursor-pointer" onclick="showChart('${stock.code}', '${stock.name}')">
                      <td class="px-2 py-2 text-white font-medium hover:text-blue-400">${stock.name}</td>
                      <td class="px-2 py-2 text-gray-300 text-xs">${stock.code}</td>
                      <td class="px-2 py-2 text-white">${parseFloat(stock.currentPrice).toLocaleString()}</td>
                      <td class="px-2 py-2 ${parseFloat(stock.changePercent) >= 0 ? 'text-red-400' : 'text-blue-400'} font-bold">
                        ${stock.changePercent}%
                      </td>
                      ${getActiveMAPeriod() ? `
                        <td class="px-2 py-2 text-white">${getMAValue(stock, getActiveMAPeriod())}</td>
                        <td class="px-2 py-2 text-green-400">${getMARatio(stock, getActiveMAPeriod())}%</td>
                      ` : ''}
                    </tr>
                  `).join('')}
                </tbody>
              </table>
            </div>
          </div>
        ` : !app.loading && app.hasSearched ? `
          <div class="bg-white/5 backdrop-blur-sm rounded-xl p-8 text-center border border-white/10">
            <div class="text-6xl mb-4">ğŸ”</div>
            <p class="text-blue-200 text-xl font-semibold mb-2">ê²€ìƒ‰ ê²°ê³¼ê°€ ì—†ìŠµë‹ˆë‹¤</p>
            <p class="text-white/60 text-sm">ì¡°ê±´ì„ ì™„í™”í•˜ê±°ë‚˜ ë‹¤ë¥¸ ì¡°ê±´ìœ¼ë¡œ ë‹¤ì‹œ ê²€ìƒ‰í•´ë³´ì„¸ìš”</p>
          </div>
        ` : !app.loading ? `
          <div class="bg-white/5 backdrop-blur-sm rounded-xl p-8 text-center border border-white/10">
            <p class="text-blue-200 text-base md:text-lg">API í‚¤ë¥¼ ì…ë ¥í•˜ê³  ì¡°ê±´ì„ ì„¤ì •í•œ í›„ ê²€ìƒ‰ì„ ì‹¤í–‰í•˜ì„¸ìš”</p>
          </div>
        ` : ''}
      `;

      // ì´ë²¤íŠ¸ ë¦¬ìŠ¤ë„ˆ ë“±ë¡
      ['appKey', 'appSecret'].forEach(id => {
        const el = document.getElementById(id);
        if (el) el.addEventListener('input', (e) => {
          app[id] = e.target.value;
        });
      });
      
      // ê³„ì¢Œ êµ¬ë¶„ ë¼ë””ì˜¤ ë²„íŠ¼
      document.querySelectorAll('input[name="accountType"]').forEach(radio => {
        radio.addEventListener('change', (e) => {
          app.isProduction = e.target.value === 'real';
          console.log('ê³„ì¢Œ êµ¬ë¶„ ë³€ê²½:', app.isProduction ? 'ì‹¤ì „íˆ¬ì' : 'ëª¨ì˜íˆ¬ì');
        });
      });
      
      // ì‹œì¥ ì„ íƒ ì²´í¬ë°•ìŠ¤
      ['searchDomestic', 'searchUS'].forEach(id => {
        const el = document.getElementById(id);
        if (el) el.addEventListener('change', (e) => {
          app[id] = e.target.checked;
          console.log('ì‹œì¥ ì„ íƒ:', id, app[id]);
        });
      });

      ['excludeETF', 'excludeManagement', 'bbEnabled', 'volumeEnabled', 'bbUpperBreak', 'bbLowerBreak', 'maAlignment', 'ma20Enabled', 'highLowRangeEnabled', 'ichimokuEnabled', 'priceChangeEnabled', 'marketCapEnabled', 'perEnabled', 'pbrEnabled'].forEach(id => {
        const el = document.getElementById(id);
        if (el) el.addEventListener('change', (e) => {
          app.conditions[id] = e.target.checked;
          render();
        });
      });
      
      // ì´ë™í‰ê· ì„  ë¼ë””ì˜¤ ë²„íŠ¼
      document.querySelectorAll('input[name="maPeriod"]').forEach(radio => {
        radio.addEventListener('change', (e) => {
          // ëª¨ë“  MA ë¹„í™œì„±í™”
          app.conditions.ma60Enabled = false;
          app.conditions.ma112Enabled = false;
          app.conditions.ma224Enabled = false;
          
          // ì„ íƒëœ MAë§Œ í™œì„±í™”
          const period = e.target.value;
          if (period === '60') app.conditions.ma60Enabled = true;
          if (period === '112') app.conditions.ma112Enabled = true;
          if (period === '224') app.conditions.ma224Enabled = true;
          
          render();
        });
      });

      ['ma60Min', 'ma60Max', 'ma112Min', 'ma112Max', 'ma224Min', 'ma224Max', 'volumeMultiple', 'priceChangeMin', 'priceChangeMax', 'perMin', 'perMax', 'pbrMin', 'pbrMax'].forEach(id => {
        const el = document.getElementById(id);
        if (el) el.addEventListener('input', (e) => {
          app.conditions[id] = parseFloat(e.target.value);
        });
      });

      // ì‹œê°€ì´ì•¡ (ì–µì› ë‹¨ìœ„ ë³€í™˜)
      ['marketCapMin', 'marketCapMax'].forEach(id => {
        const el = document.getElementById(id);
        if (el) el.addEventListener('input', (e) => {
          app.conditions[id] = parseFloat(e.target.value) * 100000000; // ì–µì› â†’ ì›
        });
      });

      // ë³¼ë¦°ì € ë°´ë“œ í”„ë¦¬ì…‹ ë¼ë””ì˜¤ ë²„íŠ¼
      document.querySelectorAll('input[name="bbPreset"]').forEach(radio => {
        radio.addEventListener('change', (e) => {
          const presets = {
            short: { period: 10, multiplier: 1.5 },
            normal: { period: 20, multiplier: 2 },
            long: { period: 30, multiplier: 3 },
            trend: { period: 40, multiplier: 2 }
          };
          const preset = presets[e.target.value];
          if (preset) {
            app.conditions.bbPeriod = preset.period;
            app.conditions.bbMultiplier = preset.multiplier;
          }
        });
      });

      const bbPos = document.getElementById('bbPosition');
      if (bbPos) bbPos.addEventListener('change', (e) => {
        app.conditions.bbPosition = e.target.value;
      });
    }

    // API í‚¤ ë¡œë“œ (í˜ì´ì§€ ë¡œë“œ í›„)
    function initializeApiKeys() {
      const savedKeys = loadApiKeys();
      console.log('[DEBUG] savedKeys loaded:', {
        appKey: savedKeys.appKey?.length || 0,
        appSecret: savedKeys.appSecret?.length || 0,
        isProduction: savedKeys.isProduction
      });
      
      app.appKey = savedKeys.appKey;
      app.appSecret = savedKeys.appSecret;
      app.isProduction = savedKeys.isProduction;
      
      console.log('[DEBUG] app object after load:', {
        appKey: app.appKey?.length || 0,
        appSecret: app.appSecret?.length || 0
      });
      
      render(); // ë‹¤ì‹œ ë Œë”ë§í•´ì„œ input í•„ë“œì— ê°’ í‘œì‹œ
    }
    
    // ì´ˆê¸° ë Œë”ë§
    render();
    
    // API í‚¤ ë¡œë“œ (DOM ë¡œë“œ í›„)
    setTimeout(initializeApiKeys, 100);
    
    // DB ìƒíƒœ ìë™ í™•ì¸ (í˜ì´ì§€ ë¡œë“œ ì‹œ)
    setTimeout(checkDatabaseStatus, 500);
  </script>
</body>
</html>
