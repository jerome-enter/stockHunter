# StockHunter 프로젝트 규칙

## 프로젝트 구조
```
StockHunter/
├── kotlin-screener/        # 백엔드 (Kotlin + Ktor)
│   └── src/main/kotlin/com/jeromeent/stockhunter/
│       ├── Application.kt           # 메인 + API 엔드포인트
│       ├── client/
│       │   ├── KISApiClient.kt     # 한국투자증권 API 클라이언트
│       │   └── KISStockMasterParser.kt  # 종목파일 파서 (업로드 전용)
│       ├── service/
│       │   └── DBStockScreener.kt  # DB 기반 스크리너 (400일 데이터)
│       └── db/
│           ├── PriceDatabase.kt    # SQLite DB (400일 자동정리)
│           └── PriceDataCollector.kt  # 데이터 수집 (6회 API 호출)
├── fastapi-gateway/        # 게이트웨이 (FastAPI)
└── stock_screener.html     # 프론트엔드 (단일 HTML)
```

## 핵심 원칙

### 1. DB 중심 아키텍처
- **모든 스크리닝은 DB에서**: API 30일 데이터 사용 금지
- **400일 수집 후 계속 누적**: 일일 업데이트 시 데이터 삭제 안 함
- **초기화 시에만 정리**: `cleanOldData(keepDays = 400)` 호출
- **스크리닝 조회**: DB에서 필요한 만큼 조회 (기본 280일)

### 2. 데이터 수집
- **6회 API 호출**: 100일 × 6 = 400일 (영업일)
- **자동 정리**: 초기화 완료 시에만 400일 이전 삭제 (일일 업데이트 시 삭제 안 함)
- **Rate Limiter**: 초당 15건 (67ms 간격)

### 3. 종목 마스터
- **파일 업로드 우선**: 네이버/KRX 크롤링 금지
- **고정 길이 파싱**:
  - 위치 0-8: 단축코드 (앞 6자리 = 종목코드)
  - 위치 21-60: 한글종목명 (40자)
- **DB 캐싱**: stock_master 테이블에 종목코드 + 종목명 저장
- **종목명 동기화**: 파일 없을 시 한투 API로 자동 갱신 (백그라운드, 4분)

### 4. 스크리닝
- **DBStockScreener 사용**: StockScreener(API 기반) 사용 금지
- **이동평균 라디오**: 60/112/224 중 하나만 선택
- **비율 기준 정렬**: 선택한 MA 비율 높은 순

## 절대 금지
1. ❌ API에서 30일 데이터로 ma60/112/224 계산 (DB에서만!)
2. ❌ 네이버/KRX 크롤링으로 종목 자동 수집 (파일 업로드만!)
3. ❌ 체크박스로 ma60/112/224 중복 선택 (라디오 버튼만!)
4. ❌ 일일 업데이트 시 오래된 데이터 삭제 (계속 누적!)
5. ❌ **사용자 요청 없이 문서 자동 생성** (README, 가이드, 매뉴얼 등)
   - 명시적 요청이 있을 때만 문서 작성
   - 코드 수정만 하고 문서는 생성하지 않음

## API 엔드포인트
- POST `/api/v1/database/initialize` - DB 초기화 (2,500종목 × 6회 × 400일)
- POST `/api/v1/database/update` - 일일 업데이트 (누락 기간 자동 채움)
- POST `/api/v1/database/upload-stock-master` - 종목파일 업로드 (KOSPI/KOSDAQ)
- POST `/api/v1/database/sync-stock-names` - 종목명 자동 동기화 (한투 API, 4분 소요)
- POST `/api/v1/screen` - 스크리닝 (DB 400일 데이터 사용)

## 주요 흐름

### 초기 설정
1. 한투 포털에서 종목정보파일 다운로드 (KOSPI, KOSDAQ)
2. 웹에서 파일 업로드 → stock_master 테이블에 종목코드+종목명 저장
3. DB 초기화 → 400일 가격 데이터 수집 (6회 API 호출)
4. 초기화 완료 시 400일 이전 데이터 자동 정리

### 스크리닝
1. 웹에서 조건 설정 (ma60/112/224 중 하나만 라디오 선택)
2. DBStockScreener가 DB에서 필요한 데이터 조회 (기본 280일)
3. ma60/112/224 계산 → 필터링 → 비율 높은 순 정렬

### 유지보수
- 일일 업데이트: 누락 기간 자동 계산 후 채움 (데이터 삭제 안 함, 계속 누적)
- 재초기화: 필요 시 forceRebuild 옵션으로 전체 재구축 + 400일 정리
- 종목 갱신: 파일 재업로드

## 웹 프론트엔드 규칙

### API 키 저장
- **암호화 저장**: XOR 암호화 + Base64 인코딩
- **저장 위치**: 브라우저 LocalStorage (kis_app_key_enc, kis_app_secret_enc)
- **보안**: 브라우저별 고유 암호화 키 (userAgent + salt + screen size)
- **자동 로드**: 페이지 로드 시 자동으로 복호화하여 input 필드에 표시
- **로드 타이밍**: `setTimeout(initializeApiKeys, 100)` - 화면 크기 안정화 후 복호화
- **안전성**: 개인 PC에서만 사용 권장, 공용 PC는 사용 후 삭제 필수

### 디버그 표시
- **디버그 박스 유지**: 노란색 박스로 app.appKey/appSecret 길이 실시간 표시
- **필수 정보**: API 키 로드 상태, 복호화 성공 여부 확인용
- **위치**: API 설정 섹션 상단 (input 필드 위)
- **제거 금지**: 문제 진단 시 필수 도구

### 차트 기능
- **분리 차트**: 가격 차트(350px) + 거래량 차트(100px) 별도 표시
- **Y축**: 가격 차트는 양쪽에 Y축 표시 (좌/우 동일 값)
- **확대/축소**: +/- 버튼, 초기화 버튼
- **패닝**: Shift + 드래그 또는 휠 클릭 + 드래그 (맥북 친화적)
- **지표 토글**: 60/112/224일선, 추세선, 지지선, 저항선, 일목균형표 구름대 ON/OFF

## 코딩 스타일
- 한글 주석 사용
- 로깅: `logger.info { "✅ 완료" }` 형식
- 에러 핸들링: try-catch + 로깅
- 디버그: 중요한 상태는 화면에 표시 (콘솔 로그 대신)
