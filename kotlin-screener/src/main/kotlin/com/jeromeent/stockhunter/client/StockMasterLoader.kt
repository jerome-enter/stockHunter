package com.jeromeent.stockhunter.client

import com.jeromeent.stockhunter.db.PriceDatabase
import kotlinx.coroutines.runBlocking
import mu.KotlinLogging
import java.io.File

private val logger = KotlinLogging.logger {}

/**
 * ì „ì²´ ì¢…ëª© ë¦¬ìŠ¤íŠ¸ ë¡œë”
 * 
 * 1ìˆœìœ„: DB ìºì‹œ (7ì¼ ì´ë‚´)
 * 2ìˆœìœ„: ë„¤ì´ë²„ ê¸ˆìœµ ì‹¤ì‹œê°„ ì¡°íšŒ â†’ DB ì €ì¥
 * 3ìˆœìœ„: CSV íŒŒì¼
 * 4ìˆœìœ„: ê¸°ë³¸ 500ê°œ ì¢…ëª©
 */
object StockMasterLoader {
    
    private var database: PriceDatabase? = null
    
    /**
     * Database ì¸ìŠ¤í„´ìŠ¤ ì„¤ì •
     */
    fun setDatabase(db: PriceDatabase) {
        database = db
    }
    
    /**
     * ì „ì²´ ì½”ìŠ¤í”¼/ì½”ìŠ¤ë‹¥ ì¢…ëª© ì½”ë“œ ì¡°íšŒ
     * 
     * DB ìºì‹œ â†’ ë„¤ì´ë²„ â†’ CSV â†’ ê¸°ë³¸ ë¦¬ìŠ¤íŠ¸ ìˆœì„œë¡œ ì‹œë„
     */
    fun loadAllStockCodes(): List<String> {
        // 1ìˆœìœ„: DB ìºì‹œ í™•ì¸ (7ì¼ ì´ë‚´)
        database?.let { db ->
            if (!db.needsStockMasterRefresh(maxAgeDays = 7)) {
                val cachedStocks = db.getCachedStockCodes()
                if (cachedStocks.isNotEmpty()) {
                    val stats = db.getStockMasterStats()
                    logger.info { "âœ… Loaded ${cachedStocks.size} stocks from DB cache (KOSPI: ${stats.kospiStocks}, KOSDAQ: ${stats.kosdaqStocks})" }
                    logger.info { "Last updated: ${stats.lastUpdated}" }
                    return cachedStocks
                }
            } else {
                logger.info { "ğŸ“… DB cache is outdated or empty, fetching fresh data..." }
            }
        }
        
        // 2ìˆœìœ„: ë„¤ì´ë²„ ê¸ˆìœµì—ì„œ ì‹¤ì‹œê°„ ì¡°íšŒ
        try {
            logger.info { "ğŸŒ Fetching stock list from Naver Finance..." }
            val stocksWithMarket = runBlocking {
                fetchStocksWithMarketInfo()
            }
            
            if (stocksWithMarket.isNotEmpty()) {
                logger.info { "âœ… Fetched ${stocksWithMarket.size} stocks from Naver Finance" }
                
                // DBì— ì €ì¥
                database?.let { db ->
                    try {
                        db.refreshStockMaster(stocksWithMarket)
                        logger.info { "ğŸ’¾ Saved to DB cache for future use" }
                    } catch (e: Exception) {
                        logger.warn(e) { "Failed to save stock master to DB" }
                    }
                }
                
                return stocksWithMarket.keys.toList()
            }
        } catch (e: Exception) {
            logger.warn(e) { "Failed to fetch from Naver, trying CSV..." }
        }
        
        // 3ìˆœìœ„: CSVì—ì„œ ë¡œë“œ
        return try {
            val csvPath = "/app/src/main/resources/all_stocks.csv"
            val file = File(csvPath)
            
            if (file.exists()) {
                loadFromCSV(file)
            } else {
                logger.warn { "all_stocks.csv not found, using comprehensive default list" }
                getComprehensiveDefaultStocks()
            }
        } catch (e: Exception) {
            logger.error(e) { "Failed to load stock list from CSV" }
            getComprehensiveDefaultStocks()
        }
    }
    
    /**
     * ì¢…ëª© ë§ˆìŠ¤í„° ê°•ì œ ê°±ì‹ 
     * 
     * ì£¼ê¸°ì  ê°±ì‹ ìš© (2ì£¼ ë˜ëŠ” 1ë‹¬ë§ˆë‹¤)
     */
    fun forceRefreshStockMaster(): Boolean {
        logger.info { "ğŸ”„ Forcing stock master refresh..." }
        
        return try {
            val stocksWithMarket = runBlocking {
                fetchStocksWithMarketInfo()
            }
            
            if (stocksWithMarket.isNotEmpty()) {
                database?.refreshStockMaster(stocksWithMarket)
                logger.info { "âœ… Stock master refreshed: ${stocksWithMarket.size} stocks" }
                true
            } else {
                logger.warn { "Failed to fetch stocks" }
                false
            }
        } catch (e: Exception) {
            logger.error(e) { "Failed to refresh stock master" }
            false
        }
    }
    
    /**
     * ì‹œì¥ ì •ë³´ì™€ í•¨ê»˜ ì¢…ëª© ì¡°íšŒ
     */
    private suspend fun fetchStocksWithMarketInfo(): Map<String, String> {
        val result = mutableMapOf<String, String>()
        
        val kospiStocks = KRXStockListFetcher.fetchMarketStocksFromNaver("KOSPI")
        val kosdaqStocks = KRXStockListFetcher.fetchMarketStocksFromNaver("KOSDAQ")
        
        kospiStocks.forEach { result[it] = "KOSPI" }
        kosdaqStocks.forEach { result[it] = "KOSDAQ" }
        
        return result
    }
    
    /**
     * CSV íŒŒì¼ì—ì„œ ì¢…ëª© ë¡œë“œ
     */
    private fun loadFromCSV(file: File): List<String> {
        val stocks = mutableListOf<String>()
        
        file.bufferedReader().use { reader ->
            reader.readLine() // í—¤ë” ìŠ¤í‚µ
            
            reader.lineSequence().forEach { line ->
                val parts = line.split(",")
                if (parts.isNotEmpty()) {
                    val code = parts[0].trim()
                    if (code.matches(Regex("\\d{6}"))) { // 6ìë¦¬ ìˆ«ì í™•ì¸
                        stocks.add(code)
                    }
                }
            }
        }
        
        logger.info { "Loaded ${stocks.size} stocks from CSV" }
        return stocks
    }
    
    /**
     * í¬ê´„ì ì¸ ê¸°ë³¸ ì¢…ëª© ë¦¬ìŠ¤íŠ¸
     * ì½”ìŠ¤í”¼ 200 + ì½”ìŠ¤ë‹¥ ì£¼ìš” ì¢…ëª©
     */
    private fun getComprehensiveDefaultStocks(): List<String> {
        return kospi200Stocks + kosdaqMajorStocks
    }
    
    /**
     * ì½”ìŠ¤í”¼ 200 ì¢…ëª©
     */
    private val kospi200Stocks = listOf(
        // ì‹œê°€ì´ì•¡ ìƒìœ„
        "005930", // ì‚¼ì„±ì „ì
        "000660", // SKí•˜ì´ë‹‰ìŠ¤
        "373220", // LGì—ë„ˆì§€ì†”ë£¨ì…˜
        "207940", // ì‚¼ì„±ë°”ì´ì˜¤ë¡œì§ìŠ¤
        "005380", // í˜„ëŒ€ì°¨
        "006400", // ì‚¼ì„±SDI
        "051910", // LGí™”í•™
        "035420", // NAVER
        "000270", // ê¸°ì•„
        "068270", // ì…€íŠ¸ë¦¬ì˜¨
        "105560", // KBê¸ˆìœµ
        "055550", // ì‹ í•œì§€ì£¼
        "035720", // ì¹´ì¹´ì˜¤
        "012330", // í˜„ëŒ€ëª¨ë¹„ìŠ¤
        "028260", // ì‚¼ì„±ë¬¼ì‚°
        "086790", // í•˜ë‚˜ê¸ˆìœµì§€ì£¼
        "066570", // LGì „ì
        "003670", // í¬ìŠ¤ì½”í“¨ì²˜ì— 
        "017670", // SKí…”ë ˆì½¤
        "009150", // ì‚¼ì„±ì „ê¸°
        "032830", // ì‚¼ì„±ìƒëª…
        "015760", // í•œêµ­ì „ë ¥
        "018260", // ì‚¼ì„±ì—ìŠ¤ë””ì—ìŠ¤
        "003550", // LG
        "096770", // SKì´ë…¸ë² ì´ì…˜
        "000810", // ì‚¼ì„±í™”ì¬
        "033780", // KT&G
        "034730", // SK
        "010950", // S-Oil
        "011170", // ë¡¯ë°ì¼€ë¯¸ì¹¼
        "009540", // í˜„ëŒ€ì¤‘ê³µì—…ì§€ì£¼
        "001450", // í˜„ëŒ€í•´ìƒ
        "010130", // ê³ ë ¤ì•„ì—°
        "047810", // í•œêµ­í•­ê³µìš°ì£¼
        "003490", // ëŒ€í•œí•­ê³µ
        "024110", // ê¸°ì—…ì€í–‰
        "139480", // ì´ë§ˆíŠ¸
        "090430", // ì•„ëª¨ë ˆí¼ì‹œí”½
        "161390", // í•œêµ­íƒ€ì´ì–´
        "011780", // ê¸ˆí˜¸ì„ìœ 
        "029780", // ì‚¼ì„±ì¹´ë“œ
        "004020", // í˜„ëŒ€ì œì² 
        "010140", // ì‚¼ì„±ì¤‘ê³µì—…
        "011200", // HMM
        "000120", // CJëŒ€í•œí†µìš´
        "006800", // ë¯¸ë˜ì—ì…‹ì¦ê¶Œ
        "036570", // ì—”ì”¨ì†Œí”„íŠ¸
        "009830", // í•œí™”ì†”ë£¨ì…˜
        "000720", // í˜„ëŒ€ê±´ì„¤
        "016360", // ì‚¼ì„±ì¦ê¶Œ
        "005940", // NHíˆ¬ìì¦ê¶Œ
        
        // ì¶”ê°€ ì½”ìŠ¤í”¼ 150ê°œ (ì‹¤ì œë¡œëŠ” KRXì—ì„œ ë°›ì•„ì•¼ í•¨)
        "001040", "001120", "001230", "001390", "001440",
        "001460", "001500", "001510", "001520", "001550",
        "001560", "001570", "001630", "001680", "001720",
        "001740", "001750", "001770", "001780", "001790",
        "001800", "001820", "001880", "002020", "002030",
        "002140", "002150", "002200", "002210", "002270",
        "002350", "002380", "002390", "002410", "002600",
        "002700", "002710", "002720", "002760", "002780",
        "002790", "002820", "002840", "002880", "002900",
        "002960", "003000", "003010", "003030", "003070",
        "003090", "003160", "003200", "003230", "003240",
        "003280", "003300", "003350", "003410", "003450",
        "003460", "003470", "003520", "003570", "003580",
        "003590", "003610", "003620", "003650", "003690",
        "003720", "003800", "003830", "004000", "004080",
        "004090", "004100", "004170", "004250", "004310",
        "004360", "004370", "004410", "004490", "004540",
        "004560", "004800", "004840", "004870", "004910",
        "004940", "004960", "004970", "004990", "005180",
        "005250", "005290", "005300", "005320", "005360",
        "005420", "005440", "005490", "005500", "005610",
        "005680", "005690", "005720", "005740", "005750",
        "005800", "005810", "005820", "005830", "005850",
        "005870", "005880", "005930", "005935", "005945"
    )
    
    /**
     * ì½”ìŠ¤ë‹¥ ì£¼ìš” ì¢…ëª© (ì•½ 300ê°œ)
     */
    private val kosdaqMajorStocks = listOf(
        // ì‹œê°€ì´ì•¡ ìƒìœ„
        "247540", // ì—ì½”í”„ë¡œë¹„ì— 
        "086520", // ì—ì½”í”„ë¡œ
        "091990", // ì…€íŠ¸ë¦¬ì˜¨í—¬ìŠ¤ì¼€ì–´
        "068760", // ì…€íŠ¸ë¦¬ì˜¨ì œì•½
        "141080", // ë ˆê³ ì¼ë°”ì´ì˜¤
        "293490", // ì¹´ì¹´ì˜¤ê²Œì„ì¦ˆ
        "277810", // ë ˆì¸ë³´ìš°ë¡œë³´í‹±ìŠ¤
        "112040", // ìœ„ë©”ì´ë“œ
        "263750", // í„ì–´ë¹„ìŠ¤
        "251270", // ë„·ë§ˆë¸”
        "041510", // ì—ìŠ¤ì— 
        "035900", // JYP Ent.
        "035760", // CJ ENM
        "352820", // í•˜ì´ë¸Œ
        "122870", // ì™€ì´ì§€ì—”í„°í…Œì¸ë¨¼íŠ¸
        "376300", // ë””ì–´ìœ 
        "206400", // ë² ì´ìŠ¤ì „ì
        "088350", // í•œí™”ìƒëª…
        "036420", // ì½¤í…ì‹œìŠ¤í…œ
        "192820", // ì½”ìŠ¤ë§¥ìŠ¤
        "290650", // ì—˜ì•¤ì—í”„
        "020150", // ì¼ì§„ë¨¸í‹°ë¦¬ì–¼ì¦ˆ
        "348210", // ë„¥ìŠ¤í‹´
        "064760", // í‹°ì”¨ì¼€ì´
        "357780", // ì†”ë¸Œë ˆì¸
        "336260", // ë‘ì‚°í“¨ì–¼ì…€
        "086900", // ë©”ë””í†¡ìŠ¤
        "095340", // ISC
        "194480", // ë°ë¸Œì‹œìŠ¤í„°ì¦ˆ
        "048410", // í˜„ëŒ€ë°”ì´ì˜¤
        "145020", // íœ´ì ¤
        "299900", // ìœ„ì§€ìœ…ìŠ¤íŠœë””ì˜¤
        
        // ë°”ì´ì˜¤/ì œì•½
        "214150", // í´ë˜ì‹œìŠ¤
        "214450", // íŒŒë§ˆë¦¬ì„œì¹˜
        "200130", // ì½œë§ˆë¹„ì•¤ì—ì´ì¹˜
        "205470", // íœ´ë§ˆì‹œìŠ¤
        "241710", // ì½”ìŠ¤ë©”ì¹´ì½”ë¦¬ì•„
        "237690", // ì—ìŠ¤í‹°íŒœ
        "214370", // ì¼€ì–´ì  
        "950110", // SBIì¸ë² ìŠ¤íŠ¸ë¨¼íŠ¸
        
        // IT/ì†Œí”„íŠ¸ì›¨ì–´
        "053800", // ì•ˆë©
        "095660", // ë„¤ì˜¤ìœ„ì¦ˆ
        "036420", // ì½¤í…ì‹œìŠ¤í…œ
        "042700", // í•œë¯¸ë°˜ë„ì²´
        "039030", // ì´ì˜¤í…Œí¬ë‹‰ìŠ¤
        "067310", // í•˜ë‚˜ë§ˆì´í¬ë¡ 
        "108230", // í†±í…
        "095340", // ISC
        "101490", // ì—ìŠ¤ì•¤ì—ìŠ¤í…
        "140410", // ë©”ì§€ì˜¨
        "043370", // í”¼ì—ìŠ¤ì¼€ì´
        "041190", // ìš°ë¦¬ê¸°ìˆ íˆ¬ì
        
        // 2ì°¨ì „ì§€/ì†Œì¬
        "067630", // HLBìƒëª…ê³¼í•™
        "196170", // ì•Œí…Œì˜¤ì  
        "145020", // íœ´ì ¤
        "214150", // í´ë˜ì‹œìŠ¤
        "950110", // SBIì¸ë² ìŠ¤íŠ¸ë¨¼íŠ¸
        "263860", // ì§€ë‹ˆì–¸ìŠ¤
        "052770", // ì•„ì´í†¡ì‹œ
        "085660", // ì°¨ë°”ì´ì˜¤í…
        "206640", // ë°”ë””í…ë©”ë“œ
        "950130", // ì—‘ì„¸ìŠ¤ë°”ì´ì˜¤
        
        // ë‚˜ë¨¸ì§€ 200ê°œ ì¶”ê°€ (ì‹¤ì œë¡œëŠ” APIë‚˜ CSVì—ì„œ)
        "007390", "007460", "007530", "007570", "007590",
        "007610", "007660", "007770", "007810", "007980",
        "008060", "008110", "008250", "008260", "008350",
        "008490", "008600", "008700", "008770", "008870",
        "009070", "009140", "009180", "009190", "009240",
        "009270", "009290", "009310", "009410", "009420",
        "009440", "009450", "009460", "009470", "009520",
        "009580", "009680", "009770", "009810", "009900",
        "010060", "010120", "010240", "010280", "010470",
        "010580", "010620", "010660", "010690", "010730",
        "010770", "010780", "010820", "010870", "010890",
        "011000", "011040", "011050", "011070", "011080",
        "011150", "011155", "011210", "011230", "011280",
        "011300", "011330", "011390", "011420", "011500",
        "011690", "011700", "011720", "011760", "011785",
        "011790", "011810", "011930", "012030", "012160",
        "012170", "012205", "012280", "012320", "012330",
        "012340", "012450", "012510", "012600", "012610",
        "012620", "012630", "012690", "012750", "012800",
        "013000", "013030", "013120", "013360", "013520",
        "013570", "013580", "013700", "013810", "013870",
        "014130", "014160", "014285", "014440", "014530",
        "014580", "014680", "014710", "014790", "014820",
        "014830", "014910", "014915", "015020", "015230",
        "015260", "015350", "015360", "015540", "015590",
        "015750", "015860", "015890", "016100", "016250",
        "016380", "016385", "016450", "016580", "016590",
        "016610", "016740", "016800", "016880", "017000",
        "017040", "017390", "017550", "017800", "017810",
        "017890", "017900", "017940", "017960", "018250",
        "018470", "018500", "018620", "018670", "018680",
        "018880", "019170", "019175", "019180", "019210",
        "019440", "019490", "019550", "019570", "019590",
        "019680", "019685", "020000", "020120", "020150"
    )
}
